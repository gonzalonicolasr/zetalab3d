<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZETALAB - Admin Dashboard [FIXED]</title>
    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #111111;
            --bg-tertiary: #1a1a1a;
            --text-primary: #e5e5e5;
            --text-secondary: #b0b0b0;
            --accent-primary: #00ff88;
            --success: #00ff88;
            --warning: #ffbf00;
            --error: #ff4444;
            --border-primary: #333333;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary), var(--bg-secondary));
            color: var(--text-primary);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            border: 1px solid var(--border-primary);
        }

        .header h1 {
            color: var(--accent-primary);
            margin-bottom: 10px;
            font-size: 2rem;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: var(--bg-tertiary);
            padding: 10px;
            border-radius: 10px;
            border: 1px solid var(--border-primary);
        }

        .nav-link {
            padding: 12px 20px;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .nav-link:hover {
            background: var(--accent-primary);
            color: var(--bg-primary);
        }

        .nav-link.active {
            background: var(--accent-primary);
            color: var(--bg-primary);
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--accent-primary);
            margin-bottom: 5px;
        }

        .metric-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .data-table {
            background: var(--bg-tertiary);
            border-radius: 10px;
            border: 1px solid var(--border-primary);
            overflow: hidden;
        }

        .table-header {
            background: var(--bg-secondary);
            padding: 15px 20px;
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .table-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--accent-primary);
        }

        .table-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            background: var(--accent-primary);
            color: var(--bg-primary);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .btn:hover {
            opacity: 0.8;
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-primary);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-primary);
        }

        th {
            background: var(--bg-secondary);
            color: var(--accent-primary);
            font-weight: 600;
        }

        tr:hover {
            background: rgba(0, 255, 136, 0.05);
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-badge.active {
            background: rgba(0, 255, 136, 0.2);
            color: var(--success);
        }

        .status-badge.inactive {
            background: rgba(255, 68, 68, 0.2);
            color: var(--error);
        }

        .status-badge.expired {
            background: rgba(255, 191, 0, 0.2);
            color: var(--warning);
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-primary);
            border-top: 2px solid var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: var(--bg-primary);
            font-weight: 500;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: var(--success);
        }

        .notification.error {
            background: var(--error);
        }

        .notification.warning {
            background: var(--warning);
        }

        .notification.info {
            background: #00ffff;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 ZETALAB Admin Dashboard</h1>
            <p>Panel de administración con datos reales de Supabase</p>
        </div>

        <nav class="nav-tabs">
            <button class="nav-link active" data-section="dashboard">Dashboard</button>
            <button class="nav-link" data-section="subscriptions">Suscripciones</button>
            <button class="nav-link" data-section="payments">Pagos</button>
            <button class="nav-link" data-section="pieces">Piezas</button>
        </nav>

        <div id="dashboard" class="content-section active">
            <div class="metrics-grid">
                <div class="metric-card">
                    <div id="totalPieces" class="metric-value">-</div>
                    <div class="metric-label">Total Piezas</div>
                </div>
                <div class="metric-card">
                    <div id="totalCalculations" class="metric-value">-</div>
                    <div class="metric-label">Total Cálculos</div>
                </div>
                <div class="metric-card">
                    <div id="activeSubscriptions" class="metric-value">-</div>
                    <div class="metric-label">Suscripciones Activas</div>
                </div>
                <div class="metric-card">
                    <div id="totalRevenue" class="metric-value">-</div>
                    <div class="metric-label">Ingresos Totales</div>
                </div>
            </div>
        </div>

        <div id="subscriptions" class="content-section">
            <div class="data-table">
                <div class="table-header">
                    <div class="table-title">Suscripciones Reales</div>
                    <div class="table-actions">
                        <button class="btn btn-secondary" onclick="refreshSubscriptions()">🔄 Actualizar</button>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Usuario</th>
                            <th>Plan</th>
                            <th>Estado</th>
                            <th>Monto</th>
                            <th>Creada</th>
                            <th>Expira</th>
                        </tr>
                    </thead>
                    <tbody id="subscriptionsTable">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px;">
                                <div class="loading-spinner"></div>
                                <div style="margin-top: 10px;">Cargando suscripciones...</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="payments" class="content-section">
            <div class="data-table">
                <div class="table-header">
                    <div class="table-title">Transacciones de Pago</div>
                    <div class="table-actions">
                        <button class="btn btn-secondary" onclick="refreshPayments()">🔄 Actualizar</button>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Usuario</th>
                            <th>Monto</th>
                            <th>Estado</th>
                            <th>MP Payment ID</th>
                            <th>Fecha</th>
                        </tr>
                    </thead>
                    <tbody id="paymentsTable">
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px;">
                                <div class="loading-spinner"></div>
                                <div style="margin-top: 10px;">Cargando pagos...</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="pieces" class="content-section">
            <div class="data-table">
                <div class="table-header">
                    <div class="table-title">Piezas de Usuarios</div>
                    <div class="table-actions">
                        <button class="btn btn-secondary" onclick="refreshPieces()">🔄 Actualizar</button>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Título</th>
                            <th>Usuario</th>
                            <th>Creada</th>
                            <th>Precio Est.</th>
                            <th>Peso</th>
                        </tr>
                    </thead>
                    <tbody id="piecesTable">
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 40px;">
                                <div class="loading-spinner"></div>
                                <div style="margin-top: 10px;">Cargando piezas...</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="notificationContainer"></div>

    <!-- Include Supabase JS -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://fwmyiovamcxvinoxnput.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3bXlpb3ZhbWN4dmlub3hucHV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxNzAzODksImV4cCI6MjA3MTc0NjM4OX0.x94-SZj7-BR9CGMzeujkjyk_7iItajoHKkGRgIYPUTc';
        const SERVICE_ROLE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3bXlpb3ZhbWN4dmlub3hucHV0Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NjE3MDM4OSwiZXhwIjoyMDcxNzQ2Mzg5fQ.DfuFLgbxVNmrhfqXVgCRIoTCsDvUK02qR9wJqzik2PY';
        
        // Initialize Supabase clients
        let supabase, supabaseAdmin;
        
        function initSupabase() {
            if (typeof window.supabase === 'undefined') {
                console.log('⏳ Waiting for Supabase to load...');
                setTimeout(initSupabase, 100);
                return;
            }
            
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                supabaseAdmin = window.supabase.createClient(SUPABASE_URL, SERVICE_ROLE_KEY);
                console.log('✅ Supabase clients initialized successfully');
                
                // Load initial data
                loadDashboardData();
            } catch (error) {
                console.error('❌ Error initializing Supabase:', error);
                showNotification('Error inicializando Supabase: ' + error.message, 'error');
            }
        }

        // Initialize when DOM loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Initializing ZETALAB Admin Dashboard [FIXED VERSION]');
            
            // Setup navigation
            setupNavigation();
            
            // Initialize Supabase
            initSupabase();
        });

        function setupNavigation() {
            const navLinks = document.querySelectorAll('.nav-link');
            
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    // Remove active class from all links
                    navLinks.forEach(l => l.classList.remove('active'));
                    
                    // Add active class to clicked link
                    link.classList.add('active');
                    
                    // Hide all sections
                    document.querySelectorAll('.content-section').forEach(section => {
                        section.classList.remove('active');
                    });
                    
                    // Show target section
                    const targetSection = link.dataset.section;
                    const sectionElement = document.getElementById(targetSection);
                    if (sectionElement) {
                        sectionElement.classList.add('active');
                        
                        // Load section data
                        loadSectionData(targetSection);
                    }
                });
            });
        }

        async function loadDashboardData() {
            try {
                console.log('📊 Loading dashboard metrics...');
                showNotification('Cargando datos del dashboard...', 'info');
                
                const metrics = await calculateRealMetrics();
                
                // Update metric cards
                document.getElementById('totalPieces').textContent = metrics.total_pieces || 0;
                document.getElementById('totalCalculations').textContent = metrics.total_calculations || 0;
                document.getElementById('activeSubscriptions').textContent = metrics.active_subscriptions || 0;
                document.getElementById('totalRevenue').textContent = formatCurrency(metrics.total_revenue || 0);
                
                console.log('✅ Dashboard metrics loaded successfully');
                showNotification('Dashboard cargado correctamente', 'success');
                
            } catch (error) {
                console.error('❌ Error loading dashboard:', error);
                showNotification('Error cargando el dashboard: ' + error.message, 'error');
            }
        }

        async function calculateRealMetrics() {
            try {
                console.log('🔄 Calculating real metrics from actual tables...');
                
                // Count pieces using REAL table
                const { count: totalPieces, error: piecesError } = await supabase
                    .from('pieces')
                    .select('*', { count: 'exact', head: true });
                
                if (piecesError) {
                    console.error('Error counting pieces:', piecesError);
                }
                
                // Count calculations (piece_versions) using REAL table
                const { count: totalCalculations, error: versionsError } = await supabase
                    .from('piece_versions')
                    .select('*', { count: 'exact', head: true });
                    
                if (versionsError) {
                    console.error('Error counting versions:', versionsError);
                }
                
                // Count active subscriptions using REAL column names (active=true)
                const { count: activeSubscriptions, error: subsError } = await supabase
                    .from('subscriptions')
                    .select('*', { count: 'exact', head: true })
                    .eq('active', true);
                    
                if (subsError) {
                    console.error('Error counting subscriptions:', subsError);
                }
                
                // Calculate revenue from payment_transactions using REAL columns
                const { data: payments, error: paymentsError } = await supabase
                    .from('payment_transactions')
                    .select('amount')
                    .eq('status', 'approved');
                
                if (paymentsError) {
                    console.error('Error fetching payments:', paymentsError);
                }
                
                const totalRevenue = payments?.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0) || 0;
                
                return {
                    total_pieces: totalPieces || 0,
                    total_calculations: totalCalculations || 0,
                    active_subscriptions: activeSubscriptions || 0,
                    total_revenue: totalRevenue
                };
                
            } catch (error) {
                console.error('❌ Error calculating real metrics:', error);
                return {
                    total_pieces: 0,
                    total_calculations: 0,
                    active_subscriptions: 0,
                    total_revenue: 0
                };
            }
        }

        function loadSectionData(sectionId) {
            switch(sectionId) {
                case 'subscriptions':
                    loadSubscriptionsData();
                    break;
                case 'payments':
                    loadPaymentsData();
                    break;
                case 'pieces':
                    loadPiecesData();
                    break;
                default:
                    break;
            }
        }

        async function loadSubscriptionsData() {
            try {
                console.log('💳 Loading subscriptions from REAL table...');
                
                // Use REAL table schema only - NO VIEWS or non-existent columns
                const { data: subscriptions, error } = await supabase
                    .from('subscriptions')
                    .select(`
                        id,
                        user_id,
                        plan_type,
                        active,
                        created_at,
                        expires_at,
                        payment_id,
                        amount,
                        payment_status
                    `)
                    .order('created_at', { ascending: false })
                    .limit(100);
                
                if (error) {
                    console.error('❌ Error loading subscriptions:', error);
                    throw error;
                }
                
                console.log(`✅ Loaded ${subscriptions?.length || 0} real subscriptions`);
                renderSubscriptionsTable(subscriptions || []);
                
            } catch (error) {
                console.error('❌ Error loading subscriptions:', error);
                document.getElementById('subscriptionsTable').innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: var(--error);">
                            ❌ Error cargando suscripciones: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        function renderSubscriptionsTable(subscriptions) {
            const tbody = document.getElementById('subscriptionsTable');
            
            if (!subscriptions || subscriptions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px;">
                            No hay suscripciones disponibles
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = subscriptions.map(sub => {
                // Calculate status using REAL schema (active boolean + expires_at)
                const now = new Date();
                const expiryDate = sub.expires_at ? new Date(sub.expires_at) : null;
                let computedStatus;
                
                if (sub.active) {
                    if (expiryDate && expiryDate < now) {
                        computedStatus = 'expired';
                    } else {
                        computedStatus = 'active';
                    }
                } else {
                    computedStatus = 'inactive';
                }
                
                return `
                    <tr>
                        <td style="font-family: monospace; font-size: 0.8rem;">${sub.id}</td>
                        <td>user-${sub.user_id.substring(0, 8)}</td>
                        <td>${getPlanLabel(sub.plan_type)}</td>
                        <td><span class="status-badge ${computedStatus}">${getStatusLabel(computedStatus)}</span></td>
                        <td>${formatCurrency(sub.amount || 0)}</td>
                        <td>${formatDate(sub.created_at)}</td>
                        <td>${sub.expires_at ? formatDate(sub.expires_at) : 'Sin vencimiento'}</td>
                    </tr>
                `;
            }).join('');
        }

        async function loadPaymentsData() {
            try {
                console.log('💰 Loading payments from REAL table...');
                
                const { data: payments, error } = await supabase
                    .from('payment_transactions')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(100);
                
                if (error) {
                    console.error('❌ Error loading payments:', error);
                    throw error;
                }
                
                console.log(`✅ Loaded ${payments?.length || 0} payments`);
                renderPaymentsTable(payments || []);
                
            } catch (error) {
                console.error('❌ Error loading payments:', error);
                document.getElementById('paymentsTable').innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: var(--error);">
                            ❌ Error cargando pagos: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        function renderPaymentsTable(payments) {
            const tbody = document.getElementById('paymentsTable');
            
            if (!payments || payments.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px;">
                            No hay transacciones de pago disponibles
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = payments.map(payment => `
                <tr>
                    <td style="font-family: monospace; font-size: 0.8rem;">${payment.id}</td>
                    <td>user-${payment.user_id.substring(0, 8)}</td>
                    <td>${formatCurrency(payment.amount || 0)}</td>
                    <td><span class="status-badge ${normalizePaymentStatus(payment.status)}">${getPaymentStatusLabel(payment.status)}</span></td>
                    <td>${payment.mp_payment_id || 'N/A'}</td>
                    <td>${formatDate(payment.created_at)}</td>
                </tr>
            `).join('');
        }

        async function loadPiecesData() {
            try {
                console.log('🔧 Loading pieces from REAL table...');
                
                const { data: pieces, error } = await supabase
                    .from('pieces')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(100);
                
                if (error) {
                    console.error('❌ Error loading pieces:', error);
                    throw error;
                }
                
                console.log(`✅ Loaded ${pieces?.length || 0} pieces`);
                renderPiecesTable(pieces || []);
                
            } catch (error) {
                console.error('❌ Error loading pieces:', error);
                document.getElementById('piecesTable').innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px; color: var(--error);">
                            ❌ Error cargando piezas: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        function renderPiecesTable(pieces) {
            const tbody = document.getElementById('piecesTable');
            
            if (!pieces || pieces.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px;">
                            No hay piezas disponibles
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = pieces.map(piece => `
                <tr>
                    <td>${piece.title || 'Sin título'}</td>
                    <td>user-${piece.user_id.substring(0, 8)}</td>
                    <td>${formatDate(piece.created_at)}</td>
                    <td>${formatCurrency(piece.est_price_ars || 0)}</td>
                    <td>${(piece.est_weight_grams || 0)}g</td>
                </tr>
            `).join('');
        }

        // Utility functions
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function formatCurrency(amount) {
            if (amount === null || amount === undefined) return '$0';
            return new Intl.NumberFormat('es-AR', {
                style: 'currency',
                currency: 'ARS',
                minimumFractionDigits: 0
            }).format(amount);
        }

        function getPlanLabel(planType) {
            const labels = {
                'trial': 'Trial',
                'monthly': 'Mensual'
            };
            return labels[planType] || planType;
        }

        function getStatusLabel(status) {
            const labels = {
                'active': 'Activa',
                'inactive': 'Inactiva',
                'expired': 'Expirada'
            };
            return labels[status] || status;
        }

        function getPaymentStatusLabel(status) {
            const labels = {
                'approved': 'Aprobado',
                'pending': 'Pendiente',
                'cancelled': 'Cancelado',
                'rejected': 'Rechazado',
                'refunded': 'Reembolsado'
            };
            return labels[status] || status;
        }

        function normalizePaymentStatus(status) {
            const mapping = {
                'approved': 'active',
                'pending': 'warning',
                'cancelled': 'inactive',
                'rejected': 'inactive',
                'refunded': 'warning'
            };
            return mapping[status] || 'inactive';
        }

        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            if (!container) {
                console.log(`${type.toUpperCase()}: ${message}`);
                return;
            }
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            container.appendChild(notification);
            
            // Show notification
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            // Hide and remove notification
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (container.contains(notification)) {
                        container.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Refresh functions
        async function refreshSubscriptions() {
            showNotification('Actualizando suscripciones...', 'info');
            await loadSubscriptionsData();
            showNotification('Suscripciones actualizadas', 'success');
        }

        async function refreshPayments() {
            showNotification('Actualizando pagos...', 'info');
            await loadPaymentsData();
            showNotification('Pagos actualizados', 'success');
        }

        async function refreshPieces() {
            showNotification('Actualizando piezas...', 'info');
            await loadPiecesData();
            showNotification('Piezas actualizadas', 'success');
        }

        console.log('✅ ZETALAB Working Admin Dashboard loaded successfully');
    </script>
</body>
</html>