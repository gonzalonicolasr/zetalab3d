<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZETALAB - Admin Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f1f1a, #1a2f26);
            color: #00ff88;
            min-height: 100vh;
            display: flex;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 280px;
            background: rgba(0, 255, 136, 0.08);
            border-right: 1px solid rgba(0, 255, 136, 0.3);
            padding: 20px;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            overflow-y: auto;
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .sidebar.collapsed {
            transform: translateX(-280px);
        }

        .sidebar-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(0, 255, 136, 0.2);
        }

        .sidebar-header h2 {
            font-size: 1.5em;
            margin-bottom: 10px;
            color: #00ff88;
            text-shadow: 0 0 10px #00ff88;
        }

        .sidebar-nav {
            list-style: none;
            padding: 0;
        }

        .sidebar-nav li {
            margin-bottom: 10px;
        }

        .sidebar-nav a {
            display: flex;
            align-items: center;
            padding: 15px;
            color: #00ff88;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s ease;
            background: transparent;
            border: 1px solid transparent;
        }

        .sidebar-nav a:hover {
            background: rgba(0, 255, 136, 0.1);
            border-color: rgba(0, 255, 136, 0.3);
            transform: translateX(5px);
        }

        .sidebar-nav a.active {
            background: rgba(0, 255, 136, 0.15);
            border-color: #00ff88;
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.3);
        }

        .sidebar-nav .icon {
            margin-right: 12px;
            font-size: 1.2em;
        }

        .sidebar-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 255, 136, 0.2);
            border: 1px solid #00ff88;
            color: #00ff88;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            z-index: 1001;
            transition: all 0.3s ease;
        }

        .sidebar-toggle:hover {
            background: rgba(0, 255, 136, 0.3);
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.4);
        }

        .main-content {
            margin-left: 280px;
            flex: 1;
            min-height: 100vh;
            padding: 20px;
            transition: margin-left 0.3s ease;
        }

        .main-content.expanded {
            margin-left: 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 0 20px #00ff88;
        }

        .header p {
            opacity: 0.8;
            font-size: 1.1em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid #00ff88;
            border-radius: 10px;
            padding: 25px;
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 255, 136, 0.3);
        }

        .stat-card h3 {
            font-size: 1.2em;
            margin-bottom: 15px;
            color: #00ff88;
        }

        .stat-card .number {
            font-size: 3em;
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 10px;
        }

        .stat-card .label {
            opacity: 0.7;
            font-size: 0.9em;
        }

        .loading {
            color: #ffaa00;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }

        .data-tables {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-top: 30px;
        }

        .table-container {
            background: rgba(0, 255, 136, 0.05);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 10px;
            padding: 20px;
        }

        .table-container h3 {
            margin-bottom: 20px;
            color: #00ff88;
            font-size: 1.4em;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(0, 255, 136, 0.2);
        }

        th {
            background: rgba(0, 255, 136, 0.1);
            color: #00ff88;
            font-weight: bold;
        }

        tr:hover {
            background: rgba(0, 255, 136, 0.05);
        }

        .refresh-btn {
            background: linear-gradient(45deg, #00ff88, #00cc70);
            color: #0f1f1a;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin: 10px;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.4);
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .status-active { background: #00ff88; color: #0f1f1a; }
        .status-trial { background: #ffaa00; color: #0f1f1a; }
        .status-expired { background: #ff4444; color: white; }

        .error {
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid #ff4444;
            color: #ff4444;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .user-email {
            font-family: monospace;
            background: rgba(0, 255, 136, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
        }

        /* Users section specific styles */
        .users-section {
            display: none;
        }

        .users-section.active {
            display: block;
        }

        .users-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(0, 255, 136, 0.3);
        }

        .users-count {
            background: rgba(0, 255, 136, 0.1);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            border: 1px solid rgba(0, 255, 136, 0.3);
        }

        .dashboard-section {
            display: block;
        }

        .dashboard-section.hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-280px);
            }

            .sidebar.mobile-open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .sidebar-toggle {
                display: block;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
            .data-tables {
                grid-template-columns: 1fr;
            }
            .table-container {
                overflow-x: auto;
            }
        }

        @media (min-width: 769px) {
            .sidebar-toggle {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar Toggle Button -->
    <button class="sidebar-toggle" onclick="toggleSidebar()">☰</button>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>🔧 ZETALAB</h2>
            <p>Admin Panel</p>
        </div>
        <nav>
            <ul class="sidebar-nav">
                <li>
                    <a href="#" class="nav-link active" data-section="dashboard">
                        <span class="icon">📊</span>
                        Dashboard
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-link" data-section="usuarios">
                        <span class="icon">👥</span>
                        Usuarios
                    </a>
                </li>
            </ul>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <div class="container">
            <!-- Dashboard Section -->
            <div class="dashboard-section" id="dashboardSection">
                <div class="header">
                    <h1>📊 Dashboard General</h1>
                    <p>Gestión y estadísticas del sistema</p>
                    <button class="refresh-btn" onclick="loadAllData()">🔄 Actualizar Datos</button>
                </div>

                <div class="stats-grid">
            <div class="stat-card">
                <h3>👥 Usuarios Registrados</h3>
                <div class="number" id="totalUsers">-</div>
                <div class="label">Total en la plataforma</div>
            </div>

            <div class="stat-card">
                <h3>💳 Suscripciones Activas</h3>
                <div class="number" id="activeSubscriptions">-</div>
                <div class="label">Pagando actualmente</div>
            </div>

            <div class="stat-card">
                <h3>🎯 Usuarios en Trial</h3>
                <div class="number" id="trialUsers">-</div>
                <div class="label">Período de prueba</div>
            </div>

            <div class="stat-card">
                <h3>📄 Piezas Creadas</h3>
                <div class="number" id="totalPieces">-</div>
                <div class="label">Proyectos guardados</div>
            </div>

            <div class="stat-card">
                <h3>🔄 Versiones Guardadas</h3>
                <div class="number" id="totalVersions">-</div>
                <div class="label">Historial de cálculos</div>
            </div>

            <div class="stat-card">
                <h3>💰 Ingresos Total</h3>
                <div class="number" id="totalRevenue">-</div>
                <div class="label">ARS acumulados</div>
            </div>
        </div>

        <div class="data-tables">
            <div class="table-container">
                <h3>👥 Usuarios Recientes</h3>
                <div id="usersTable">
                    <div class="loading">Cargando usuarios...</div>
                </div>
            </div>

            <div class="table-container">
                <h3>💳 Suscripciones</h3>
                <div id="subscriptionsTable">
                    <div class="loading">Cargando suscripciones...</div>
                </div>
            </div>

            <div class="table-container">
                <h3>📄 Piezas Recientes</h3>
                <div id="piecesTable">
                    <div class="loading">Cargando piezas...</div>
                </div>
            </div>

            <div class="table-container">
                <h3>💰 Transacciones</h3>
                <div id="paymentsTable">
                    <div class="loading">Cargando pagos...</div>
                </div>
            </div>
        </div>
            </div>

            <!-- Users Section -->
            <div class="users-section" id="usuariosSection">
                <div class="users-header">
                    <h1>👥 Todos los Usuarios</h1>
                    <div class="users-count" id="usersCount">
                        <span id="totalUsersCount">0</span> usuarios registrados
                    </div>
                </div>
                
                <div class="table-container">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>Lista Completa de Usuarios</h3>
                        <button class="refresh-btn" onclick="loadAllUsers()">🔄 Actualizar</button>
                    </div>
                    <div id="allUsersTable">
                        <div class="loading">Cargando todos los usuarios...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Configuración Supabase
        const SUPABASE_URL = 'https://fwmyiovamcxvinoxnput.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3bXlpb3ZhbWN4dmlub3hucHV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxNzAzODksImV4cCI6MjA3MTc0NjM4OX0.x94-SZj7-BR9CGMzeujkjyk_7iItajoHKkGRgIYPUTc';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Sidebar Navigation Functions
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            
            if (window.innerWidth <= 768) {
                sidebar.classList.toggle('mobile-open');
            } else {
                sidebar.classList.toggle('collapsed');
                mainContent.classList.toggle('expanded');
            }
        }

        function switchSection(sectionName) {
            // Remove active class from all nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });

            // Add active class to clicked nav link
            document.querySelector(`[data-section="${sectionName}"]`).classList.add('active');

            // Hide all sections
            document.getElementById('dashboardSection').classList.add('hidden');
            document.getElementById('usuariosSection').classList.remove('active');

            // Show selected section
            if (sectionName === 'dashboard') {
                document.getElementById('dashboardSection').classList.remove('hidden');
            } else if (sectionName === 'usuarios') {
                document.getElementById('usuariosSection').classList.add('active');
                loadAllUsers(); // Load users when section is shown
            }

            // Close sidebar on mobile after selection
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('mobile-open');
            }
        }

        // Add click event listeners to nav links
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const section = this.getAttribute('data-section');
                    switchSection(section);
                });
            });
        });

        // Función para formatear números
        function formatNumber(num) {
            return new Intl.NumberFormat('es-AR').format(num || 0);
        }

        // Función para formatear moneda
        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-AR', {
                style: 'currency',
                currency: 'ARS'
            }).format(amount || 0);
        }

        // Función para formatear fechas
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('es-AR', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // Cargar estadísticas principales
        async function loadStats() {
            try {
                // Contar usuarios únicos desde pieces (método seguro)
                const { count: usersFromPieces } = await supabase
                    .from('pieces')
                    .select('user_id', { count: 'exact', head: true });

                // Contar suscripciones activas
                const { count: activeSubscriptions } = await supabase
                    .from('subscriptions')
                    .select('*', { count: 'exact', head: true })
                    .eq('active', true);

                // Contar usuarios en trial
                const { count: trialUsers } = await supabase
                    .from('subscriptions')
                    .select('*', { count: 'exact', head: true })
                    .eq('plan_type', 'trial')
                    .eq('active', true);

                // Contar piezas totales
                const { count: totalPieces } = await supabase
                    .from('pieces')
                    .select('*', { count: 'exact', head: true });

                // Contar versiones totales
                const { count: totalVersions } = await supabase
                    .from('piece_versions')
                    .select('*', { count: 'exact', head: true });

                // Calcular ingresos totales
                const { data: payments } = await supabase
                    .from('payment_transactions')
                    .select('amount')
                    .eq('status', 'approved');

                const totalRevenue = payments?.reduce((sum, payment) => sum + (payment.amount || 0), 0) || 0;

                // Actualizar UI
                document.getElementById('totalUsers').textContent = formatNumber(usersFromPieces || 0);
                document.getElementById('activeSubscriptions').textContent = formatNumber(activeSubscriptions || 0);
                document.getElementById('trialUsers').textContent = formatNumber(trialUsers || 0);
                document.getElementById('totalPieces').textContent = formatNumber(totalPieces || 0);
                document.getElementById('totalVersions').textContent = formatNumber(totalVersions || 0);
                document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);

            } catch (error) {
                console.error('Error loading stats:', error);
                document.querySelectorAll('.number').forEach(el => {
                    el.textContent = 'Error';
                    el.className = 'number error';
                });
            }
        }

        // Cargar usuarios recientes
        async function loadUsers() {
            try {
                const { data: pieces, error } = await supabase
                    .from('pieces')
                    .select(`
                        user_id,
                        created_at,
                        title
                    `)
                    .order('created_at', { ascending: false })
                    .limit(10);

                if (error) throw error;

                // Agrupar por usuario
                const usersMap = new Map();
                pieces?.forEach(piece => {
                    if (!usersMap.has(piece.user_id)) {
                        usersMap.set(piece.user_id, {
                            user_id: piece.user_id,
                            first_piece_date: piece.created_at,
                            pieces_count: 0
                        });
                    }
                    usersMap.get(piece.user_id).pieces_count++;
                });

                const users = Array.from(usersMap.values()).slice(0, 10);

                let html = `
                    <table>
                        <thead>
                            <tr>
                                <th>User ID</th>
                                <th>Primera Pieza</th>
                                <th>Total Piezas</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                users.forEach(user => {
                    html += `
                        <tr>
                            <td><span class="user-email">${user.user_id.substring(0, 8)}...</span></td>
                            <td>${formatDate(user.first_piece_date)}</td>
                            <td>${user.pieces_count}</td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                document.getElementById('usersTable').innerHTML = html;

            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('usersTable').innerHTML = `
                    <div class="error">Error cargando usuarios: ${error.message}</div>
                `;
            }
        }

        // Cargar suscripciones
        async function loadSubscriptions() {
            try {
                // Usar vista que incluye emails
                const { data: subscriptions, error } = await supabase
                    .from('admin_subscriptions_with_emails')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(10);

                if (error) throw error;

                let html = `
                    <table>
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>User ID</th>
                                <th>Plan</th>
                                <th>Estado</th>
                                <th>Expira</th>
                                <th>Monto</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                subscriptions?.forEach(sub => {
                    const statusClass = sub.active ? 
                        (sub.plan_type === 'trial' ? 'status-trial' : 'status-active') : 
                        'status-expired';

                    html += `
                        <tr>
                            <td><span class="user-email">${sub.user_email || 'Sin email'}</span></td>
                            <td><code style="font-size: 0.8em;">${sub.user_id.substring(0, 8)}...</code></td>
                            <td>${sub.plan_type}</td>
                            <td><span class="status-badge ${statusClass}">
                                ${sub.active ? 'Activa' : 'Inactiva'}
                            </span></td>
                            <td>${formatDate(sub.expires_at)}</td>
                            <td>${formatCurrency(sub.amount)}</td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                document.getElementById('subscriptionsTable').innerHTML = html;

            } catch (error) {
                console.error('Error loading subscriptions:', error);
                document.getElementById('subscriptionsTable').innerHTML = `
                    <div class="error">Error cargando suscripciones: ${error.message}</div>
                `;
            }
        }

        // Cargar piezas recientes
        async function loadPieces() {
            try {
                const { data: pieces, error } = await supabase
                    .from('pieces')
                    .select('title, user_id, created_at, est_price_ars')
                    .order('created_at', { ascending: false })
                    .limit(10);

                if (error) throw error;

                let html = `
                    <table>
                        <thead>
                            <tr>
                                <th>Título</th>
                                <th>Usuario</th>
                                <th>Precio Est.</th>
                                <th>Fecha</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                pieces?.forEach(piece => {
                    html += `
                        <tr>
                            <td>${piece.title || 'Sin título'}</td>
                            <td><span class="user-email">${piece.user_id.substring(0, 8)}...</span></td>
                            <td>${formatCurrency(piece.est_price_ars)}</td>
                            <td>${formatDate(piece.created_at)}</td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                document.getElementById('piecesTable').innerHTML = html;

            } catch (error) {
                console.error('Error loading pieces:', error);
                document.getElementById('piecesTable').innerHTML = `
                    <div class="error">Error cargando piezas: ${error.message}</div>
                `;
            }
        }

        // Cargar transacciones
        async function loadPayments() {
            try {
                const { data: payments, error } = await supabase
                    .from('payment_transactions')
                    .select('user_id, amount, status, created_at, description')
                    .order('created_at', { ascending: false })
                    .limit(10);

                if (error) throw error;

                let html = `
                    <table>
                        <thead>
                            <tr>
                                <th>Usuario</th>
                                <th>Monto</th>
                                <th>Estado</th>
                                <th>Fecha</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                payments?.forEach(payment => {
                    const statusClass = payment.status === 'approved' ? 'status-active' :
                                      payment.status === 'pending' ? 'status-trial' : 'status-expired';

                    html += `
                        <tr>
                            <td><span class="user-email">${payment.user_id.substring(0, 8)}...</span></td>
                            <td>${formatCurrency(payment.amount)}</td>
                            <td><span class="status-badge ${statusClass}">${payment.status}</span></td>
                            <td>${formatDate(payment.created_at)}</td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                document.getElementById('paymentsTable').innerHTML = html;

            } catch (error) {
                console.error('Error loading payments:', error);
                document.getElementById('paymentsTable').innerHTML = `
                    <div class="error">Error cargando transacciones: ${error.message}</div>
                `;
            }
        }

        // Cargar todos los usuarios registrados
        async function loadAllUsers() {
            try {
                console.log('🔄 Cargando todos los usuarios...');
                
                // Strategy 1: Get unique user_ids from pieces table (safer approach)
                const { data: piecesData, error: piecesError } = await supabase
                    .from('pieces')
                    .select('user_id, created_at')
                    .order('created_at', { ascending: false });

                if (piecesError) throw piecesError;

                // Strategy 2: Also try to get users from subscriptions table
                const { data: subscriptionsData, error: subError } = await supabase
                    .from('admin_subscriptions_with_emails')
                    .select('user_id, user_email, created_at');
                
                // Combine data from both sources
                const usersMap = new Map();
                
                // Add users from pieces
                piecesData?.forEach(piece => {
                    if (!usersMap.has(piece.user_id)) {
                        usersMap.set(piece.user_id, {
                            user_id: piece.user_id,
                            email: null,
                            first_seen: piece.created_at,
                            has_pieces: true,
                            has_subscription: false,
                            pieces_count: 0
                        });
                    }
                    usersMap.get(piece.user_id).pieces_count++;
                });

                // Add emails from subscriptions where available
                if (!subError && subscriptionsData) {
                    subscriptionsData.forEach(sub => {
                        if (usersMap.has(sub.user_id)) {
                            usersMap.get(sub.user_id).email = sub.user_email;
                            usersMap.get(sub.user_id).has_subscription = true;
                        } else {
                            // User has subscription but no pieces
                            usersMap.set(sub.user_id, {
                                user_id: sub.user_id,
                                email: sub.user_email,
                                first_seen: sub.created_at,
                                has_pieces: false,
                                has_subscription: true,
                                pieces_count: 0
                            });
                        }
                    });
                }

                const users = Array.from(usersMap.values()).sort((a, b) => 
                    new Date(b.first_seen) - new Date(a.first_seen)
                );

                // Update users count
                document.getElementById('totalUsersCount').textContent = users.length;

                let html = `
                    <table>
                        <thead>
                            <tr>
                                <th>Usuario ID</th>
                                <th>Email</th>
                                <th>Primera Actividad</th>
                                <th>Piezas</th>
                                <th>Suscripción</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                users.forEach(user => {
                    const statusBadge = user.has_subscription ? 
                        '<span class="status-badge status-active">Premium</span>' :
                        user.has_pieces ? 
                            '<span class="status-badge status-trial">Free</span>' : 
                            '<span class="status-badge status-expired">Inactivo</span>';

                    html += `
                        <tr>
                            <td>
                                <span class="user-email">${user.user_id.substring(0, 8)}...</span>
                            </td>
                            <td>
                                ${user.email ? 
                                    `<span class="user-email">${user.email}</span>` : 
                                    '<span style="opacity: 0.5;">No disponible</span>'
                                }
                            </td>
                            <td>${formatDate(user.first_seen)}</td>
                            <td>${user.pieces_count}</td>
                            <td>${user.has_subscription ? '✅' : '❌'}</td>
                            <td>${statusBadge}</td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                document.getElementById('allUsersTable').innerHTML = html;

                console.log(`✅ Cargados ${users.length} usuarios`);

            } catch (error) {
                console.error('Error loading all users:', error);
                document.getElementById('allUsersTable').innerHTML = `
                    <div class="error">
                        Error cargando usuarios: ${error.message}
                        <br><small>Los usuarios se obtienen de manera segura desde las tablas de piezas y suscripciones</small>
                    </div>
                `;
            }
        }

        // Cargar todos los datos
        async function loadAllData() {
            console.log('🔄 Cargando datos del dashboard...');
            await Promise.all([
                loadStats(),
                loadUsers(),
                loadSubscriptions(),
                loadPieces(),
                loadPayments()
            ]);
            console.log('✅ Dashboard cargado completamente');
        }

        // Cargar datos al iniciar
        document.addEventListener('DOMContentLoaded', loadAllData);
    </script>
</body>
</html>