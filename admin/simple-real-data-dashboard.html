<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZETALAB Admin - Dashboard Completo</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #00ff88;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .nav-tabs {
            display: flex;
            background: #1a1a1a;
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 30px;
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            background: transparent;
            border: none;
            color: #888;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            background: #00ff88;
            color: #000;
            font-weight: bold;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #333;
            text-align: center;
        }

        .stat-card h3 {
            color: #00ff88;
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .stat-card p {
            color: #888;
            font-size: 0.9rem;
        }

        .data-table {
            background: #1a1a1a;
            border-radius: 10px;
            border: 2px solid #333;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .data-table h3 {
            color: #00ff88;
            padding: 20px;
            border-bottom: 1px solid #333;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #333;
        }

        th {
            background: #222;
            color: #00ff88;
            font-weight: bold;
        }

        tr:hover {
            background: #222;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .status-active { background: #00ff88; color: #000; }
        .status-trial { background: #ffaa00; color: #000; }
        .status-inactive { background: #ff4444; color: white; }

        .loading {
            text-align: center;
            color: #888;
            padding: 20px;
        }

        .error {
            color: #ff4444;
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid #ff4444;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .action-btn {
            background: #00ff88;
            color: #000;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            margin: 2px;
            transition: all 0.2s ease;
        }

        .action-btn:hover { background: #00dd77; }
        .action-btn.danger { background: #ff4444; color: white; }
        .action-btn.danger:hover { background: #dd3333; }
        .action-btn.secondary { background: #666; color: white; }
        .action-btn.secondary:hover { background: #777; }

        .user-activity {
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            background: #0f0f0f;
            border-radius: 5px;
            margin-top: 10px;
        }

        .activity-item {
            padding: 8px 0;
            border-bottom: 1px solid #333;
            font-size: 0.9em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .activity-item:last-child { border-bottom: none; }
        
        .activity-date { color: #888; font-size: 0.8em; }
        
        .activity-icon { 
            margin-right: 8px; 
            font-size: 1.1em; 
        }
        
        .activity-amount { 
            color: #00ff88; 
            font-weight: bold; 
            margin-left: 8px; 
        }
        
        .activity-negative { 
            color: #ff4444; 
        }
        
        .days-remaining {
            color: #ffaa00;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .days-expired {
            color: #ff4444;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #00ff88;
            font-weight: bold;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            background: #222;
            border: 1px solid #444;
            color: #e0e0e0;
            padding: 8px 12px;
            border-radius: 5px;
        }

        .growth-positive { color: #00ff88; }
        .growth-negative { color: #ff4444; }
        .growth-neutral { color: #ffaa00; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß ZETALAB Admin Dashboard</h1>
            <p>Panel administrativo completo con gesti√≥n de usuarios y m√©tricas avanzadas</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('dashboard')">Dashboard</button>
            <button class="nav-tab" onclick="showTab('users')">Usuarios</button>
            <button class="nav-tab" onclick="showTab('subscriptions')">Suscripciones</button>
            <button class="nav-tab" onclick="showTab('pieces')">Piezas</button>
            <button class="nav-tab" onclick="showTab('analytics')">üìä Analytics</button>
            <button class="nav-tab" onclick="showTab('financials')">üí∞ Financials</button>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard" class="section active">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="totalUsers">0</h3>
                    <p>Total Usuarios Registrados</p>
                </div>
                <div class="stat-card">
                    <h3 id="activeUsers">0</h3>
                    <p>Usuarios Activos (30 d√≠as)</p>
                </div>
                <div class="stat-card">
                    <h3 id="verifiedUsers">0</h3>
                    <p>Usuarios Verificados</p>
                </div>
                <div class="stat-card">
                    <h3 id="activeSubscriptions">0</h3>
                    <p>Suscripciones Activas</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalRevenue">$0</h3>
                    <p>Ingresos Totales</p>
                </div>
                <div class="stat-card">
                    <h3 id="monthlyGrowth">+0%</h3>
                    <p>Crecimiento Mensual</p>
                </div>
            </div>

            <div class="data-table">
                <h3>üìà Actividad Reciente</h3>
                <div id="recentActivity" class="loading">Cargando...</div>
            </div>
        </div>

        <!-- Users Section -->
        <div id="users" class="section">
            <div class="data-table">
                <h3>üë• Todos los Usuarios Registrados</h3>
                <div class="table-controls" style="padding: 15px; border-bottom: 1px solid #333;">
                    <input type="text" id="userSearch" placeholder="üîç Buscar por email..." 
                           style="background: #222; border: 1px solid #444; color: #e0e0e0; padding: 8px 12px; border-radius: 5px; width: 300px;">
                    <select id="userFilter" style="background: #222; border: 1px solid #444; color: #e0e0e0; padding: 8px 12px; border-radius: 5px; margin-left: 10px;">
                        <option value="all">Todos los usuarios</option>
                        <option value="verified">Solo verificados</option>
                        <option value="unverified">No verificados</option>
                        <option value="active">Activos (30 d√≠as)</option>
                        <option value="subscribed">Con suscripci√≥n</option>
                    </select>
                </div>
                <div id="usersContent" class="loading">Cargando...</div>
            </div>

            <!-- User Edit Modal -->
            <div id="userEditModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000;">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1a1a1a; padding: 30px; border-radius: 10px; width: 500px; max-width: 90%; border: 2px solid #333;">
                    <h3 style="color: #00ff88; margin-bottom: 20px;">‚úèÔ∏è Editar Usuario</h3>
                    <div id="userEditContent"></div>
                </div>
            </div>
        </div>

        <!-- Subscriptions Section -->
        <div id="subscriptions" class="section">
            <div class="data-table">
                <h3>Suscripciones Reales</h3>
                <div id="subscriptionsContent" class="loading">Cargando...</div>
            </div>
        </div>

        <!-- Pieces Section -->
        <div id="pieces" class="section">
            <!-- Pieces Statistics -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="totalPieces">0</h3>
                    <p>Total Piezas</p>
                </div>
                <div class="stat-card">
                    <h3 id="piecesThisMonth">0</h3>
                    <p>Piezas Este Mes</p>
                </div>
                <div class="stat-card">
                    <h3 id="averagePrice">$0</h3>
                    <p>Precio Promedio</p>
                </div>
                <div class="stat-card">
                    <h3 id="averagePrintTime">0h</h3>
                    <p>Tiempo Impresi√≥n Promedio</p>
                </div>
            </div>

            <div class="data-table">
                <h3>üîß Gesti√≥n de Piezas</h3>
                <div class="table-controls" style="padding: 15px; border-bottom: 1px solid #333;">
                    <input type="text" id="pieceSearch" placeholder="üîç Buscar por t√≠tulo..." 
                           style="background: #222; border: 1px solid #444; color: #e0e0e0; padding: 8px 12px; border-radius: 5px; width: 200px;">
                    <input type="text" id="pieceUserSearch" placeholder="üë§ Buscar por usuario..." 
                           style="background: #222; border: 1px solid #444; color: #e0e0e0; padding: 8px 12px; border-radius: 5px; width: 200px; margin-left: 10px;">
                    <select id="pieceCategoryFilter" style="background: #222; border: 1px solid #444; color: #e0e0e0; padding: 8px 12px; border-radius: 5px; margin-left: 10px;">
                        <option value="all">Todas las categor√≠as</option>
                        <option value="decorativo">Decorativo</option>
                        <option value="funcional">Funcional</option>
                        <option value="prototipo">Prototipo</option>
                        <option value="repuesto">Repuesto</option>
                        <option value="miniatura">Miniatura</option>
                        <option value="herramienta">Herramienta</option>
                        <option value="juguete">Juguete</option>
                        <option value="otro">Otro</option>
                    </select>
                    <input type="date" id="pieceDateFrom" 
                           style="background: #222; border: 1px solid #444; color: #e0e0e0; padding: 8px 12px; border-radius: 5px; margin-left: 10px;" 
                           title="Desde fecha">
                    <input type="date" id="pieceDateTo" 
                           style="background: #222; border: 1px solid #444; color: #e0e0e0; padding: 8px 12px; border-radius: 5px; margin-left: 10px;" 
                           title="Hasta fecha">
                    <button class="action-btn secondary" onclick="clearPieceFilters()" style="margin-left: 10px;">üóëÔ∏è Limpiar</button>
                </div>
                <div id="piecesContent" class="loading">Cargando...</div>
            </div>

            <!-- Piece Detail Modal -->
            <div id="pieceDetailModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000;">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1a1a1a; padding: 30px; border-radius: 10px; width: 800px; max-width: 90%; max-height: 90%; overflow-y: auto; border: 2px solid #333;">
                    <h3 style="color: #00ff88; margin-bottom: 20px;">üîß Detalles de Pieza</h3>
                    <div id="pieceDetailContent"></div>
                </div>
            </div>
        </div>

        <!-- Analytics Section -->
        <div id="analytics" class="section">
            <!-- User Health Scoring -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="healthyUsers">0</h3>
                    <p>Usuarios Saludables</p>
                </div>
                <div class="stat-card">
                    <h3 id="atRiskUsers">0</h3>
                    <p>Usuarios En Riesgo</p>
                </div>
                <div class="stat-card">
                    <h3 id="churningUsers">0</h3>
                    <p>Usuarios Abandonando</p>
                </div>
                <div class="stat-card">
                    <h3 id="averageHealthScore">0</h3>
                    <p>Puntuaci√≥n Promedio</p>
                </div>
            </div>

            <!-- User Segmentation -->
            <div class="data-table">
                <h3>üéØ Segmentaci√≥n de Usuarios</h3>
                <div class="table-controls" style="padding: 15px; border-bottom: 1px solid #333;">
                    <select id="healthFilter" style="background: #222; border: 1px solid #444; color: #e0e0e0; padding: 8px 12px; border-radius: 5px;">
                        <option value="all">Todos los usuarios</option>
                        <option value="healthy">Saludables (80-100)</option>
                        <option value="at-risk">En Riesgo (50-79)</option>
                        <option value="churning">Abandonando (0-49)</option>
                    </select>
                    <button class="action-btn secondary" onclick="exportHealthData()" style="margin-left: 10px;">üìä Exportar</button>
                </div>
                <div id="healthScoreContent" class="loading">Cargando...</div>
            </div>

            <!-- Analytics Charts -->
            <div class="data-table">
                <h3>üìà M√©tricas y Tendencias</h3>
                <div id="analyticsCharts">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                        <div style="background: #0f0f0f; padding: 20px; border-radius: 8px;">
                            <h4 style="color: #00ff88; margin-bottom: 15px;">üìä Actividad por Mes</h4>
                            <div id="monthlyActivityChart"></div>
                        </div>
                        <div style="background: #0f0f0f; padding: 20px; border-radius: 8px;">
                            <h4 style="color: #00ff88; margin-bottom: 15px;">üí∞ Ingresos por Mes</h4>
                            <div id="monthlyRevenueChart"></div>
                        </div>
                    </div>
                    <div style="background: #0f0f0f; padding: 20px; border-radius: 8px; margin: 20px 0;">
                        <h4 style="color: #00ff88; margin-bottom: 15px;">üîÑ Retenci√≥n de Usuarios</h4>
                        <div id="retentionAnalysis"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Financials Section -->
        <div id="financials" class="section">
            <!-- Revenue Overview KPIs -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="currentMRR">$0</h3>
                    <p>MRR Actual</p>
                    <small id="mrrGrowth" style="color: #00ff88;">+0%</small>
                </div>
                <div class="stat-card">
                    <h3 id="totalRevenue">$0</h3>
                    <p>Ingresos Totales</p>
                    <small id="revenueGrowth" style="color: #00ff88;">+0%</small>
                </div>
                <div class="stat-card">
                    <h3 id="avgRevenuePU">$0</h3>
                    <p>Ingreso por Usuario</p>
                    <small id="arpuGrowth" style="color: #00ff88;">+0%</small>
                </div>
                <div class="stat-card">
                    <h3 id="churnRate">0%</h3>
                    <p>Tasa de Churn</p>
                    <small id="churnTrend" style="color: #ff4444;">+0%</small>
                </div>
                <div class="stat-card">
                    <h3 id="customerLTV">$0</h3>
                    <p>LTV Promedio</p>
                    <small id="ltvGrowth" style="color: #00ff88;">+0%</small>
                </div>
                <div class="stat-card">
                    <h3 id="paymentSuccessRate">0%</h3>
                    <p>√âxito en Pagos</p>
                    <small id="paymentTrend" style="color: #00ff88;">+0%</small>
                </div>
            </div>

            <!-- Revenue Charts -->
            <div class="data-table">
                <h3>üìà An√°lisis de Ingresos</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                    <div style="background: #0f0f0f; padding: 20px; border-radius: 8px;">
                        <h4 style="color: #00ff88; margin-bottom: 15px;">üí∞ MRR Trends</h4>
                        <canvas id="mrrChart" width="400" height="200"></canvas>
                    </div>
                    <div style="background: #0f0f0f; padding: 20px; border-radius: 8px;">
                        <h4 style="color: #00ff88; margin-bottom: 15px;">üìä Ingresos por Plan</h4>
                        <canvas id="revenueByPlanChart" width="400" height="200"></canvas>
                    </div>
                </div>
                <div style="background: #0f0f0f; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h4 style="color: #00ff88; margin-bottom: 15px;">üîÑ Cohort Revenue Analysis</h4>
                    <canvas id="cohortRevenueChart" width="800" height="300"></canvas>
                </div>
            </div>

            <!-- Subscription Analytics -->
            <div class="data-table">
                <h3>üéØ An√°lisis de Suscripciones</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                    <div style="background: #0f0f0f; padding: 20px; border-radius: 8px;">
                        <h4 style="color: #00ff88; margin-bottom: 15px;">üìà Trial Conversion</h4>
                        <canvas id="conversionChart" width="400" height="200"></canvas>
                    </div>
                    <div style="background: #0f0f0f; padding: 20px; border-radius: 8px;">
                        <h4 style="color: #00ff88; margin-bottom: 15px;">‚ö†Ô∏è Churn Analysis</h4>
                        <canvas id="churnChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>

            <!-- Financial Alerts & Insights -->
            <div class="data-table">
                <h3>üö® Alertas Financieras</h3>
                <div id="financialAlerts" class="loading">Cargando alertas...</div>
            </div>

            <!-- Revenue Forecasting -->
            <div class="data-table">
                <h3>üîÆ Proyecci√≥n de Ingresos</h3>
                <div style="background: #0f0f0f; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h4 style="color: #00ff88; margin-bottom: 15px;">üìä Forecast 6 Meses</h4>
                    <canvas id="forecastChart" width="800" height="300"></canvas>
                </div>
            </div>

            <!-- Detailed Financial Tables -->
            <div class="data-table">
                <h3>üìã Detalles Financieros</h3>
                <div class="table-controls" style="padding: 15px; border-bottom: 1px solid #333;">
                    <select id="financialPeriod" style="background: #222; border: 1px solid #444; color: #e0e0e0; padding: 8px 12px; border-radius: 5px;">
                        <option value="month">Este Mes</option>
                        <option value="quarter">Este Trimestre</option>
                        <option value="year">Este A√±o</option>
                        <option value="all">Todo el tiempo</option>
                    </select>
                    <button class="action-btn secondary" onclick="exportFinancialData()" style="margin-left: 10px;">üìä Exportar</button>
                </div>
                <div id="detailedFinancials" class="loading">Cargando...</div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <!-- Incluir Auth Guard antes del script principal -->
    <script src="auth-guard.js"></script>
    
    <script>
        // Configuraci√≥n segura de Supabase - Sin service role key expuesta
        // SUPABASE_URL ya se declara en auth-guard.js, solo definir SERVICE_ROLE_KEY
        const SERVICE_ROLE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3bXlpb3ZhbWN4dmlub3hucHV0Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NjE3MDM4OSwiZXhwIjoyMDcxNzQ2Mzg5fQ.DfuFLgbxVNmrhfqXVgCRIoTCsDvUK02qR9wJqzik2PY';

        // Cliente Supabase Admin (protegido por Auth Guard)
        let supabase = null;
        let isAdminAuthenticated = false;

        // Funciones de navegaci√≥n
        function showTab(tabName) {
            // Clean up charts when switching away from financials
            const currentActiveTab = document.querySelector('.nav-tab.active');
            if (currentActiveTab && currentActiveTab.getAttribute('onclick').includes('financials') && tabName !== 'financials') {
                destroyFinancialCharts();
            }

            // Ocultar todas las secciones
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            
            // Mostrar secci√≥n seleccionada
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            // Cargar datos espec√≠ficos
            if (tabName === 'users') loadUsers();
            if (tabName === 'subscriptions') loadSubscriptions();
            if (tabName === 'pieces') loadPieces();
            if (tabName === 'analytics') loadAnalytics();
            if (tabName === 'financials') loadFinancials();
        }

        // Global variables for data
        let allUsers = [];
        let allSubscriptions = [];
        let allPieces = [];
        let allPieceVersions = [];
        let allPaymentTransactions = [];
        let allConfigProfiles = [];
        let allFilaments = [];

        // Global object to track Chart.js instances
        let chartInstances = {};
        let allUserUsage = [];

        // Verificar autenticaci√≥n antes de operaciones sensibles
        function checkAdminAuth() {
            if (!isAdminAuthenticated || !supabase) {
                console.error('‚ùå Operaci√≥n bloqueada: Admin no autenticado');
                alert('Error de autenticaci√≥n. Por favor inicia sesi√≥n nuevamente.');
                window.location.href = 'login.html';
                return false;
            }
            return true;
        }

        // Cargar estad√≠sticas del dashboard
        async function loadDashboard() {
            if (!checkAdminAuth()) return;
            try {
                console.log('üìä Cargando estad√≠sticas del dashboard...');

                // Cargar TODOS los usuarios desde auth.users
                const { data: users } = await supabase.auth.admin.listUsers();
                allUsers = users?.users || [];

                // Cargar suscripciones
                const { data: subscriptions } = await supabase
                    .from('subscriptions')
                    .select('*');
                allSubscriptions = subscriptions || [];

                // Cargar piezas para actividad
                const { data: pieces } = await supabase
                    .from('pieces')
                    .select('*')
                    .order('created_at', { ascending: false });
                allPieces = pieces || [];

                // Cargar datos adicionales para actividad expandida
                const { data: pieceVersions } = await supabase
                    .from('piece_versions')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(100);
                allPieceVersions = pieceVersions || [];

                const { data: paymentTransactions } = await supabase
                    .from('payment_transactions')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(100);
                allPaymentTransactions = paymentTransactions || [];

                const { data: configProfiles } = await supabase
                    .from('config_profiles')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(100);
                allConfigProfiles = configProfiles || [];

                const { data: filaments } = await supabase
                    .from('filaments')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(100);
                allFilaments = filaments || [];

                const { data: userUsage } = await supabase
                    .from('user_usage')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(100);
                allUserUsage = userUsage || [];

                // Calcular m√©tricas
                const totalUsers = allUsers.length;
                
                // Usuarios activos (√∫ltimos 30 d√≠as)
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                const activeUsers = allUsers.filter(user => 
                    user.last_sign_in_at && new Date(user.last_sign_in_at) > thirtyDaysAgo
                ).length;

                // Usuarios verificados
                const verifiedUsers = allUsers.filter(user => user.email_confirmed_at).length;

                // Suscripciones activas
                const activeSubs = allSubscriptions.filter(s => {
                    const isActive = s.active === true;
                    const notExpired = !s.expires_at || new Date(s.expires_at) > new Date();
                    return isActive && notExpired;
                }).length;

                // Ingresos totales
                const totalRevenue = allSubscriptions.reduce((sum, s) => {
                    return sum + (parseFloat(s.amount) || 0);
                }, 0);

                // Crecimiento mensual
                const lastMonth = new Date();
                lastMonth.setMonth(lastMonth.getMonth() - 1);
                const usersLastMonth = allUsers.filter(user => 
                    new Date(user.created_at) > lastMonth
                ).length;
                const usersBeforeLastMonth = totalUsers - usersLastMonth;
                const monthlyGrowth = usersBeforeLastMonth > 0 
                    ? ((usersLastMonth / usersBeforeLastMonth) * 100) 
                    : 0;

                // Actualizar UI
                document.getElementById('totalUsers').textContent = totalUsers;
                document.getElementById('activeUsers').textContent = activeUsers;
                document.getElementById('verifiedUsers').textContent = verifiedUsers;
                document.getElementById('activeSubscriptions').textContent = activeSubs;
                document.getElementById('totalRevenue').textContent = `$${totalRevenue.toLocaleString()}`;
                
                const growthEl = document.getElementById('monthlyGrowth');
                growthEl.textContent = `+${monthlyGrowth.toFixed(1)}%`;
                growthEl.className = monthlyGrowth > 0 ? 'growth-positive' : 
                                   monthlyGrowth < 0 ? 'growth-negative' : 'growth-neutral';

                // Cargar actividad reciente
                loadRecentActivity();

                console.log('‚úÖ Dashboard cargado:', { totalUsers, activeUsers, verifiedUsers, activeSubs, totalRevenue, monthlyGrowth });

            } catch (error) {
                console.error('‚ùå Error cargando dashboard:', error);
                document.querySelectorAll('.stat-card h3').forEach(el => el.textContent = 'Error');
            }
        }

        // Cargar actividad reciente expandida
        function loadRecentActivity() {
            const activities = [];

            // Nuevos usuarios
            allUsers.slice(-5).forEach(user => {
                activities.push({
                    type: 'user_register',
                    date: new Date(user.created_at),
                    description: `Nuevo usuario registrado: ${user.email}`,
                    icon: 'üë§'
                });
            });

            // C√°lculos de presupuestos (piece_versions)
            allPieceVersions.slice(-8).forEach(version => {
                const user = allUsers.find(u => u.id === version.user_id);
                const piece = allPieces.find(p => p.id === version.piece_id);
                const total = version.total ? `$${parseFloat(version.total).toLocaleString()}` : 'N/A';
                activities.push({
                    type: 'budget_calculated',
                    date: new Date(version.created_at),
                    description: `Presupuesto calculado: ${total} para "${piece?.title || 'Pieza'}"`,
                    icon: 'üí∞',
                    user: user?.email || 'Usuario desconocido',
                    amount: total
                });
            });

            // Transacciones de pago
            allPaymentTransactions.slice(-5).forEach(transaction => {
                const user = allUsers.find(u => u.id === transaction.user_id);
                const amount = `$${parseFloat(transaction.amount || 0).toLocaleString()}`;
                const statusIcon = transaction.status === 'approved' ? '‚úÖ' : '‚ùå';
                activities.push({
                    type: 'payment',
                    date: new Date(transaction.created_at),
                    description: `Pago ${transaction.status}: ${amount} (MP: ${transaction.mp_payment_id || 'N/A'})`,
                    icon: `üí≥ ${statusIcon}`,
                    user: user?.email || 'Usuario desconocido',
                    amount: amount
                });
            });

            // Perfiles de configuraci√≥n creados
            allConfigProfiles.slice(-5).forEach(config => {
                const user = allUsers.find(u => u.id === config.user_id);
                activities.push({
                    type: 'config_created',
                    date: new Date(config.created_at),
                    description: `Config creada: "${config.name}" (${config.consumo_w}W, $${config.precio_kwh}/kWh)`,
                    icon: '‚öôÔ∏è',
                    user: user?.email || 'Usuario desconocido'
                });
            });

            // Filamentos registrados
            allFilaments.slice(-5).forEach(filament => {
                const user = allUsers.find(u => u.id === filament.user_id);
                const price = `$${parseFloat(filament.price_per_kg_ars || 0).toLocaleString()}/kg`;
                activities.push({
                    type: 'filament_added',
                    date: new Date(filament.created_at),
                    description: `Filamento: ${filament.brand} ${filament.material} ${filament.color_name} (${price})`,
                    icon: 'üßµ',
                    user: user?.email || 'Usuario desconocido'
                });
            });

            // Estad√≠sticas de uso mensual
            allUserUsage.slice(-3).forEach(usage => {
                const user = allUsers.find(u => u.id === usage.user_id);
                activities.push({
                    type: 'monthly_usage',
                    date: new Date(usage.created_at),
                    description: `Uso mensual: ${usage.calculations_used} c√°lculos, ${usage.pieces_created} piezas, ${usage.html_exports} exports`,
                    icon: 'üìä',
                    user: user?.email || 'Usuario desconocido'
                });
            });

            // Nuevas suscripciones
            allSubscriptions.slice(-3).forEach(sub => {
                const user = allUsers.find(u => u.id === sub.user_id);
                activities.push({
                    type: 'subscription',
                    date: new Date(sub.created_at),
                    description: `Suscripci√≥n ${sub.plan_type}: $${parseFloat(sub.amount || 0).toLocaleString()}`,
                    icon: 'üíé',
                    user: user?.email || 'Usuario desconocido',
                    amount: `$${parseFloat(sub.amount || 0).toLocaleString()}`
                });
            });

            // Ordenar por fecha (m√°s recientes primero)
            activities.sort((a, b) => b.date - a.date);

            let html = '';
            activities.slice(0, 25).forEach(activity => {
                html += `
                    <div class="activity-item">
                        <div>
                            <span class="activity-icon">${activity.icon}</span>
                            ${activity.description}
                            ${activity.user ? `<br><small style="color: #888;">por ${activity.user}</small>` : ''}
                        </div>
                        <div style="text-align: right;">
                            ${activity.amount ? `<div class="activity-amount">${activity.amount}</div>` : ''}
                            <div class="activity-date">${activity.date.toLocaleString('es-ES')}</div>
                        </div>
                    </div>
                `;
            });

            document.getElementById('recentActivity').innerHTML = html || '<p>No hay actividad reciente</p>';
        }

        // Cargar TODOS los usuarios
        async function loadUsers() {
            if (!checkAdminAuth()) return;
            try {
                console.log('üë• Cargando todos los usuarios...');
                
                if (allUsers.length === 0) {
                    await loadDashboard(); // Cargar datos si no est√°n disponibles
                }

                displayUsers(allUsers);
                
                // Configurar filtros y b√∫squeda
                setupUserFilters();

                console.log('‚úÖ Usuarios cargados:', allUsers.length);

            } catch (error) {
                console.error('‚ùå Error cargando usuarios:', error);
                document.getElementById('usersContent').innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        // Mostrar usuarios en tabla
        function displayUsers(users) {
            if (!users || users.length === 0) {
                document.getElementById('usersContent').innerHTML = '<p>No hay usuarios registrados</p>';
                return;
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Verificado</th>
                            <th>Registrado</th>
                            <th>√öltimo Acceso</th>
                            <th>Piezas</th>
                            <th>Suscripci√≥n</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            users.forEach(user => {
                // Calcular estad√≠sticas del usuario
                const userPieces = allPieces.filter(p => p.user_id === user.id);
                const userSubscription = allSubscriptions.find(s => s.user_id === user.id && s.active);
                
                const isVerified = user.email_confirmed_at ? 'S√≠' : 'No';
                const verifiedClass = user.email_confirmed_at ? 'status-active' : 'status-inactive';
                
                const registeredDate = new Date(user.created_at).toLocaleDateString('es-ES');
                const lastLogin = user.last_sign_in_at ? new Date(user.last_sign_in_at).toLocaleDateString('es-ES') : 'Nunca';
                
                const subStatus = userSubscription ? userSubscription.plan_type : 'Ninguna';
                const subClass = userSubscription ? 'status-active' : 'status-inactive';

                html += `
                    <tr>
                        <td><strong>${user.email}</strong></td>
                        <td><span class="status-badge ${verifiedClass}">${isVerified}</span></td>
                        <td>${registeredDate}</td>
                        <td>${lastLogin}</td>
                        <td><strong>${userPieces.length}</strong></td>
                        <td><span class="status-badge ${subClass}">${subStatus}</span></td>
                        <td>
                            <button class="action-btn" onclick="editUser('${user.id}')">‚úèÔ∏è Editar</button>
                            <button class="action-btn secondary" onclick="viewUserActivity('${user.id}')">üìä Actividad</button>
                            <button class="action-btn danger" onclick="suspendUser('${user.id}')">‚õî Suspender</button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            document.getElementById('usersContent').innerHTML = html;
        }

        // Configurar filtros y b√∫squeda
        function setupUserFilters() {
            const searchInput = document.getElementById('userSearch');
            const filterSelect = document.getElementById('userFilter');

            searchInput.addEventListener('input', filterUsers);
            filterSelect.addEventListener('change', filterUsers);
        }

        // Filtrar usuarios
        function filterUsers() {
            const searchTerm = document.getElementById('userSearch').value.toLowerCase();
            const filterType = document.getElementById('userFilter').value;

            let filteredUsers = allUsers.filter(user => 
                user.email.toLowerCase().includes(searchTerm)
            );

            switch (filterType) {
                case 'verified':
                    filteredUsers = filteredUsers.filter(user => user.email_confirmed_at);
                    break;
                case 'unverified':
                    filteredUsers = filteredUsers.filter(user => !user.email_confirmed_at);
                    break;
                case 'active':
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    filteredUsers = filteredUsers.filter(user => 
                        user.last_sign_in_at && new Date(user.last_sign_in_at) > thirtyDaysAgo
                    );
                    break;
                case 'subscribed':
                    filteredUsers = filteredUsers.filter(user => 
                        allSubscriptions.some(s => s.user_id === user.id && s.active)
                    );
                    break;
            }

            displayUsers(filteredUsers);
        }

        // Editar usuario
        async function editUser(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;

            const userSubscription = allSubscriptions.find(s => s.user_id === userId && s.active);

            const modalContent = `
                <form id="editUserForm" onsubmit="saveUser(event, '${userId}')">
                    <div class="form-group">
                        <label>Email:</label>
                        <input type="email" name="email" value="${user.email}" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Estado de verificaci√≥n:</label>
                        <select name="emailVerified">
                            <option value="true" ${user.email_confirmed_at ? 'selected' : ''}>Verificado</option>
                            <option value="false" ${!user.email_confirmed_at ? 'selected' : ''}>No verificado</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Tipo de suscripci√≥n:</label>
                        <select name="subscriptionType">
                            <option value="none" ${!userSubscription ? 'selected' : ''}>Sin suscripci√≥n</option>
                            <option value="monthly" ${userSubscription?.plan_type === 'monthly' ? 'selected' : ''}>Mensual</option>
                            <option value="trial" ${userSubscription?.plan_type === 'trial' ? 'selected' : ''}>Trial</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Notas admin:</label>
                        <textarea name="adminNotes" placeholder="Notas internas sobre este usuario..." rows="3">${user.raw_user_meta_data?.admin_notes || ''}</textarea>
                    </div>

                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                        <button type="button" class="action-btn secondary" onclick="closeUserModal()">Cancelar</button>
                        <button type="submit" class="action-btn">üíæ Guardar</button>
                        <button type="button" class="action-btn danger" onclick="resetUserPassword('${userId}')">üîë Reset Password</button>
                    </div>
                </form>
            `;

            document.getElementById('userEditContent').innerHTML = modalContent;
            document.getElementById('userEditModal').style.display = 'block';
        }

        // Cerrar modal
        function closeUserModal() {
            document.getElementById('userEditModal').style.display = 'none';
        }

        // Guardar cambios de usuario
        async function saveUser(event, userId) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            console.log('üíæ Saving user changes for:', userId);
            console.log('üìã Form data:', {
                email: formData.get('email'),
                subscriptionType: formData.get('subscriptionType'),
                emailVerified: formData.get('emailVerified')
            });

            try {
                // Actualizar metadata del usuario
                const updates = {
                    email: formData.get('email'),
                    email_confirm: formData.get('emailVerified') === 'true',
                    user_metadata: {
                        admin_notes: formData.get('adminNotes')
                    }
                };

                await supabase.auth.admin.updateUserById(userId, updates);

                // Actualizar suscripci√≥n si es necesario
                const subscriptionType = formData.get('subscriptionType');
                console.log('üîÑ Processing subscription update:', subscriptionType);
                
                if (subscriptionType !== 'none') {
                    const existingSub = allSubscriptions.find(s => s.user_id === userId && s.active);
                    console.log('üìã Existing subscription found:', existingSub);
                    
                    // Calcular fecha de expiraci√≥n seg√∫n el tipo de suscripci√≥n
                    const now = new Date();
                    let expiresAt = null;
                    let amount = 0;
                    
                    if (subscriptionType === 'monthly') {
                        expiresAt = new Date(now.getTime() + (30 * 24 * 60 * 60 * 1000)); // 30 d√≠as
                        amount = 5000; // $5000 ARS mensuales
                    } else if (subscriptionType === 'trial') {
                        expiresAt = new Date(now.getTime() + (7 * 24 * 60 * 60 * 1000)); // 7 d√≠as
                        amount = 0; // Trial gratuito
                    }
                    
                    const subscriptionData = {
                        plan_type: subscriptionType,
                        expires_at: expiresAt ? expiresAt.toISOString() : null,
                        amount: amount,
                        active: true
                    };
                    
                    console.log('üìä Subscription data to save:', subscriptionData);
                    
                    if (existingSub) {
                        // Actualizar suscripci√≥n existente
                        console.log('üîÑ Updating existing subscription ID:', existingSub.id);
                        const { data, error } = await supabase
                            .from('subscriptions')
                            .update(subscriptionData)
                            .eq('id', existingSub.id);
                            
                        if (error) {
                            console.error('‚ùå Error updating subscription:', error);
                            throw error;
                        }
                        console.log('‚úÖ Subscription updated successfully:', data);
                    } else {
                        // Crear nueva suscripci√≥n
                        console.log('‚ûï Creating new subscription for user:', userId);
                        const insertData = {
                            user_id: userId,
                            ...subscriptionData,
                            payment_status: subscriptionType === 'trial' ? 'free' : 'pending'
                        };
                        console.log('üìä Insert data:', insertData);
                        
                        const { data, error } = await supabase
                            .from('subscriptions')
                            .insert(insertData);
                            
                        if (error) {
                            console.error('‚ùå Error creating subscription:', error);
                            throw error;
                        }
                        console.log('‚úÖ Subscription created successfully:', data);
                    }
                } else {
                    // Desactivar suscripci√≥n existente
                    console.log('‚õî Deactivating existing subscription for user:', userId);
                    const { data, error } = await supabase
                        .from('subscriptions')
                        .update({ active: false })
                        .eq('user_id', userId);
                        
                    if (error) {
                        console.error('‚ùå Error deactivating subscription:', error);
                        throw error;
                    }
                    console.log('‚úÖ Subscription deactivated successfully:', data);
                }

                alert('Usuario actualizado correctamente');
                closeUserModal();
                loadDashboard(); // Recargar datos
                loadUsers(); // Recargar tabla

            } catch (error) {
                console.error('Error actualizando usuario:', error);
                alert('Error actualizando usuario: ' + error.message);
            }
        }

        // Ver actividad expandida del usuario
        function viewUserActivity(userId) {
            const user = allUsers.find(u => u.id === userId);
            const userPieces = allPieces.filter(p => p.user_id === userId);
            const userSubscriptions = allSubscriptions.filter(s => s.user_id === userId);
            const userPieceVersions = allPieceVersions.filter(pv => pv.user_id === userId);
            const userPayments = allPaymentTransactions.filter(pt => pt.user_id === userId);
            const userConfigs = allConfigProfiles.filter(cp => cp.user_id === userId);
            const userFilaments = allFilaments.filter(f => f.user_id === userId);
            const userUsageStats = allUserUsage.filter(uu => uu.user_id === userId);

            const activities = [];

            // Registro del usuario
            activities.push({
                icon: 'üë§',
                description: 'Usuario registrado',
                date: new Date(user.created_at)
            });

            // Verificaci√≥n de email
            if (user.email_confirmed_at) {
                activities.push({
                    icon: '‚úÖ',
                    description: 'Email verificado',
                    date: new Date(user.email_confirmed_at)
                });
            }

            // √öltimo acceso
            if (user.last_sign_in_at) {
                activities.push({
                    icon: 'üîë',
                    description: '√öltimo acceso',
                    date: new Date(user.last_sign_in_at)
                });
            }

            // Suscripciones
            userSubscriptions.forEach(sub => {
                const amount = `$${parseFloat(sub.amount || 0).toLocaleString()}`;
                activities.push({
                    icon: 'üíé',
                    description: `Suscripci√≥n ${sub.plan_type} ${sub.active ? 'activada' : 'desactivada'}`,
                    date: new Date(sub.created_at),
                    amount: amount
                });
            });

            // C√°lculos de presupuestos
            userPieceVersions.forEach(version => {
                const piece = allPieces.find(p => p.id === version.piece_id);
                const total = version.total ? `$${parseFloat(version.total).toLocaleString()}` : 'N/A';
                const mlPrice = version.ml_price ? `(ML: $${parseFloat(version.ml_price).toLocaleString()})` : '';
                activities.push({
                    icon: 'üí∞',
                    description: `Presupuesto calculado para "${piece?.title || 'Pieza'}" ${mlPrice}`,
                    date: new Date(version.created_at),
                    amount: total
                });
            });

            // Pagos realizados
            userPayments.forEach(payment => {
                const amount = `$${parseFloat(payment.amount || 0).toLocaleString()}`;
                const statusIcon = payment.status === 'approved' ? '‚úÖ' : '‚ùå';
                activities.push({
                    icon: `üí≥ ${statusIcon}`,
                    description: `Pago ${payment.status}: ${payment.description || 'Sin descripci√≥n'} (MP ID: ${payment.mp_payment_id || 'N/A'})`,
                    date: new Date(payment.created_at),
                    amount: amount,
                    isNegative: payment.status !== 'approved'
                });
            });

            // Configuraciones creadas
            userConfigs.forEach(config => {
                activities.push({
                    icon: '‚öôÔ∏è',
                    description: `Config creada: "${config.name}" (${config.consumo_w}W, $${config.precio_kwh}/kWh)`,
                    date: new Date(config.created_at)
                });
            });

            // Filamentos registrados
            userFilaments.forEach(filament => {
                const price = `$${parseFloat(filament.price_per_kg_ars || 0).toLocaleString()}/kg`;
                activities.push({
                    icon: 'üßµ',
                    description: `Filamento registrado: ${filament.brand} ${filament.material} ${filament.color_name}`,
                    date: new Date(filament.created_at),
                    amount: price
                });
            });

            // Estad√≠sticas de uso mensual
            userUsageStats.forEach(usage => {
                activities.push({
                    icon: 'üìä',
                    description: `Uso mensual (${usage.month_year}): ${usage.calculations_used} c√°lculos, ${usage.pieces_created} piezas, ${usage.html_exports} exports HTML`,
                    date: new Date(usage.created_at || usage.month_year + '-01')
                });
            });

            // Piezas creadas
            userPieces.forEach(piece => {
                activities.push({
                    icon: 'üîß',
                    description: `Pieza creada: "${piece.title}"`,
                    date: new Date(piece.created_at)
                });
            });

            // Ordenar por fecha descendente
            activities.sort((a, b) => b.date - a.date);

            let activityHtml = `
                <h4>üìä Actividad Completa de ${user.email}</h4>
                <p style="color: #888; margin-bottom: 15px;">
                    Total: ${userPieces.length} piezas | ${userPieceVersions.length} c√°lculos | ${userPayments.length} pagos | ${userFilaments.length} filamentos
                </p>
                <div class="user-activity">
            `;

            activities.forEach(activity => {
                const amountClass = activity.isNegative ? 'activity-negative' : '';
                activityHtml += `
                    <div class="activity-item">
                        <div>
                            <span class="activity-icon">${activity.icon}</span>
                            ${activity.description}
                        </div>
                        <div style="text-align: right;">
                            ${activity.amount ? `<div class="activity-amount ${amountClass}">${activity.amount}</div>` : ''}
                            <div class="activity-date">${activity.date.toLocaleString('es-ES')}</div>
                        </div>
                    </div>
                `;
            });

            activityHtml += '</div>';

            const modalContent = `
                ${activityHtml}
                <div style="text-align: right; margin-top: 20px;">
                    <button class="action-btn secondary" onclick="closeUserModal()">Cerrar</button>
                </div>
            `;

            document.getElementById('userEditContent').innerHTML = modalContent;
            document.getElementById('userEditModal').style.display = 'block';
        }

        // Suspender usuario
        async function suspendUser(userId) {
            if (!confirm('¬øEst√°s seguro de suspender este usuario?')) return;

            try {
                // En Supabase, suspender = desactivar todas las suscripciones
                await supabase
                    .from('subscriptions')
                    .update({ active: false })
                    .eq('user_id', userId);

                alert('Usuario suspendido correctamente');
                loadDashboard();
                loadUsers();

            } catch (error) {
                console.error('Error suspendiendo usuario:', error);
                alert('Error suspendiendo usuario: ' + error.message);
            }
        }

        // Reset password
        async function resetUserPassword(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!confirm(`¬øEnviar email de reset de password a ${user.email}?`)) return;

            try {
                await supabase.auth.resetPasswordForEmail(user.email);
                alert('Email de reset enviado correctamente');
            } catch (error) {
                console.error('Error enviando reset:', error);
                alert('Error enviando email: ' + error.message);
            }
        }

        // Cargar suscripciones mejoradas con detalles del usuario
        async function loadSubscriptions() {
            try {
                console.log('üí≥ Cargando suscripciones mejoradas...');
                
                const { data: subscriptions } = await supabase
                    .from('subscriptions')
                    .select('id, user_id, plan_type, active, amount, expires_at, created_at, payment_status')
                    .order('created_at', { ascending: false });

                if (!subscriptions || subscriptions.length === 0) {
                    document.getElementById('subscriptionsContent').innerHTML = '<p>No hay suscripciones registradas</p>';
                    return;
                }

                let html = `
                    <table>
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>Plan</th>
                                <th>Estado</th>
                                <th>Monto</th>
                                <th>Creada</th>
                                <th>Expira</th>
                                <th>D√≠as Restantes</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                subscriptions.forEach(sub => {
                    const user = allUsers.find(u => u.id === sub.user_id);
                    const userEmail = user ? user.email : 'Usuario no encontrado';
                    
                    const now = new Date();
                    const createdDate = new Date(sub.created_at);
                    const expiry = sub.expires_at ? new Date(sub.expires_at) : null;
                    
                    let status = 'inactive';
                    let statusText = 'Inactiva';
                    let daysRemaining = 'N/A';
                    let daysClass = '';
                    
                    if (sub.active) {
                        if (expiry && expiry > now) {
                            status = 'active';
                            statusText = 'Activa';
                            const timeDiff = expiry.getTime() - now.getTime();
                            const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
                            daysRemaining = daysDiff;
                            daysClass = daysDiff <= 7 ? 'days-expired' : daysDiff <= 30 ? 'days-remaining' : '';
                        } else if (expiry && expiry < now) {
                            status = 'inactive';
                            statusText = 'Expirada';
                            const timeDiff = now.getTime() - expiry.getTime();
                            const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
                            daysRemaining = `-${daysDiff}`;
                            daysClass = 'days-expired';
                        } else {
                            status = 'active';
                            statusText = 'Activa';
                            daysRemaining = '‚àû';
                        }
                    }

                    if (sub.plan_type === 'trial') {
                        status = 'trial';
                        statusText = 'Trial';
                    }

                    html += `
                        <tr>
                            <td><strong>${userEmail}</strong></td>
                            <td>
                                <span style="text-transform: capitalize;">
                                    ${sub.plan_type.replace('_', ' ')}
                                </span>
                            </td>
                            <td><span class="status-badge status-${status}">${statusText}</span></td>
                            <td>$${sub.amount ? parseFloat(sub.amount).toLocaleString() : '0'}</td>
                            <td>${createdDate.toLocaleDateString('es-ES')}</td>
                            <td>${expiry ? expiry.toLocaleDateString('es-ES') : 'Sin vencimiento'}</td>
                            <td>
                                <span class="${daysClass}">
                                    ${daysRemaining === 'N/A' ? 'N/A' : 
                                      daysRemaining === '‚àû' ? '‚àû' : 
                                      daysRemaining > 0 ? `${daysRemaining} d√≠as` : 
                                      `Expir√≥ hace ${Math.abs(daysRemaining)} d√≠as`}
                                </span>
                            </td>
                            <td>
                                <button class="action-btn" onclick="extendSubscription('${sub.id}')">‚è∞ Extender</button>
                                <button class="action-btn secondary" onclick="viewSubscriptionDetails('${sub.id}')">üëÅÔ∏è Ver</button>
                                <button class="action-btn danger" onclick="cancelSubscription('${sub.id}')">‚ùå Cancelar</button>
                            </td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                document.getElementById('subscriptionsContent').innerHTML = html;

                console.log('‚úÖ Suscripciones mejoradas cargadas:', subscriptions.length);

            } catch (error) {
                console.error('‚ùå Error cargando suscripciones:', error);
                document.getElementById('subscriptionsContent').innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        // Extender suscripci√≥n
        async function extendSubscription(subscriptionId) {
            const days = prompt('¬øCu√°ntos d√≠as extender la suscripci√≥n?', '30');
            if (!days || isNaN(days)) return;
            
            try {
                const subscription = allSubscriptions.find(s => s.id == subscriptionId);
                const currentExpiry = subscription.expires_at ? new Date(subscription.expires_at) : new Date();
                const newExpiry = new Date(currentExpiry.getTime() + (parseInt(days) * 24 * 60 * 60 * 1000));
                
                await supabase
                    .from('subscriptions')
                    .update({ 
                        expires_at: newExpiry.toISOString(),
                        active: true
                    })
                    .eq('id', subscriptionId);
                
                alert(`Suscripci√≥n extendida ${days} d√≠as hasta ${newExpiry.toLocaleDateString('es-ES')}`);
                loadDashboard();
                loadSubscriptions();
                
            } catch (error) {
                alert('Error extendiendo suscripci√≥n: ' + error.message);
            }
        }

        // Ver detalles de suscripci√≥n
        function viewSubscriptionDetails(subscriptionId) {
            const subscription = allSubscriptions.find(s => s.id == subscriptionId);
            const user = allUsers.find(u => u.id === subscription.user_id);
            
            const modalContent = `
                <h4>üí≥ Detalles de Suscripci√≥n</h4>
                <div style="background: #0f0f0f; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <p><strong>ID:</strong> ${subscription.id}</p>
                    <p><strong>Usuario:</strong> ${user?.email || 'No encontrado'}</p>
                    <p><strong>Plan:</strong> ${subscription.plan_type}</p>
                    <p><strong>Estado:</strong> ${subscription.active ? 'Activa' : 'Inactiva'}</p>
                    <p><strong>Monto:</strong> $${parseFloat(subscription.amount || 0).toLocaleString()}</p>
                    <p><strong>Creada:</strong> ${new Date(subscription.created_at).toLocaleString('es-ES')}</p>
                    <p><strong>Expira:</strong> ${subscription.expires_at ? new Date(subscription.expires_at).toLocaleString('es-ES') : 'Sin vencimiento'}</p>
                    <p><strong>Estado de pago:</strong> ${subscription.payment_status || 'N/A'}</p>
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button class="action-btn secondary" onclick="closeUserModal()">Cerrar</button>
                </div>
            `;
            
            document.getElementById('userEditContent').innerHTML = modalContent;
            document.getElementById('userEditModal').style.display = 'block';
        }

        // Cancelar suscripci√≥n
        async function cancelSubscription(subscriptionId) {
            if (!confirm('¬øEst√°s seguro de cancelar esta suscripci√≥n?')) return;
            
            try {
                await supabase
                    .from('subscriptions')
                    .update({ active: false })
                    .eq('id', subscriptionId);
                
                alert('Suscripci√≥n cancelada correctamente');
                loadDashboard();
                loadSubscriptions();
                
            } catch (error) {
                alert('Error cancelando suscripci√≥n: ' + error.message);
            }
        }

        // ================ PIECES MANAGEMENT FUNCTIONS ================

        // Cargar piezas
        async function loadPieces() {
            try {
                console.log('üîß Cargando piezas...');
                
                if (allPieces.length === 0 || allUsers.length === 0) {
                    await loadDashboard(); // Cargar datos si no est√°n disponibles
                }

                // Calcular estad√≠sticas de piezas
                loadPiecesStatistics();
                
                // Mostrar tabla de piezas
                displayPieces(allPieces);
                
                // Configurar filtros
                setupPieceFilters();

                console.log('‚úÖ Piezas cargadas:', allPieces.length);

            } catch (error) {
                console.error('‚ùå Error cargando piezas:', error);
                document.getElementById('piecesContent').innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        // Calcular estad√≠sticas de piezas
        function loadPiecesStatistics() {
            const totalPieces = allPieces.length;
            
            // Piezas este mes
            const thisMonth = new Date();
            thisMonth.setDate(1); // Primer d√≠a del mes
            const piecesThisMonth = allPieces.filter(piece => 
                new Date(piece.created_at) >= thisMonth
            ).length;

            // Precio promedio
            const averagePrice = totalPieces > 0 
                ? allPieces.reduce((sum, piece) => sum + (parseFloat(piece.est_price_ars) || 0), 0) / totalPieces
                : 0;

            // Tiempo promedio de impresi√≥n (en minutos)
            const averagePrintTimeMinutes = totalPieces > 0
                ? allPieces.reduce((sum, piece) => sum + (parseInt(piece.est_print_time_min) || 0), 0) / totalPieces
                : 0;

            // Convertir a horas y minutos
            const hours = Math.floor(averagePrintTimeMinutes / 60);
            const minutes = Math.round(averagePrintTimeMinutes % 60);

            // Actualizar UI
            document.getElementById('totalPieces').textContent = totalPieces;
            document.getElementById('piecesThisMonth').textContent = piecesThisMonth;
            document.getElementById('averagePrice').textContent = `$${averagePrice.toLocaleString()}`;
            document.getElementById('averagePrintTime').textContent = `${hours}h ${minutes}m`;
        }

        // Mostrar piezas en tabla
        function displayPieces(pieces) {
            if (!pieces || pieces.length === 0) {
                document.getElementById('piecesContent').innerHTML = '<p>No hay piezas registradas</p>';
                return;
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>T√≠tulo</th>
                            <th>Usuario</th>
                            <th>Categor√≠a</th>
                            <th>Peso (g)</th>
                            <th>Tiempo</th>
                            <th>Precio</th>
                            <th>Creada</th>
                            <th>Versiones</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            pieces.forEach(piece => {
                const user = allUsers.find(u => u.id === piece.user_id);
                const userEmail = user ? user.email : 'Usuario no encontrado';
                
                const pieceVersions = allPieceVersions.filter(pv => pv.piece_id === piece.id);
                const versionsCount = pieceVersions.length;

                const weight = piece.est_weight_grams ? `${piece.est_weight_grams}g` : 'N/A';
                const printTime = piece.est_print_time_min ? `${Math.floor(piece.est_print_time_min / 60)}h ${piece.est_print_time_min % 60}m` : 'N/A';
                const price = piece.est_price_ars ? `$${parseFloat(piece.est_price_ars).toLocaleString()}` : 'N/A';
                const category = piece.category || 'Sin categor√≠a';
                const createdDate = new Date(piece.created_at).toLocaleDateString('es-ES');

                html += `
                    <tr>
                        <td>
                            <strong>${piece.title}</strong>
                            ${piece.image_url ? `<br><small style="color: #00ff88;">üì∑ Con imagen</small>` : ''}
                        </td>
                        <td>${userEmail}</td>
                        <td><span class="status-badge" style="background: #666; color: white;">${category}</span></td>
                        <td>${weight}</td>
                        <td>${printTime}</td>
                        <td><strong>${price}</strong></td>
                        <td>${createdDate}</td>
                        <td><strong>${versionsCount}</strong></td>
                        <td>
                            <button class="action-btn" onclick="viewPieceDetails('${piece.id}')">üëÅÔ∏è Ver</button>
                            <button class="action-btn secondary" onclick="viewPieceVersions('${piece.id}')">üìä Historial</button>
                            <button class="action-btn danger" onclick="deletePiece('${piece.id}')">üóëÔ∏è Eliminar</button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            document.getElementById('piecesContent').innerHTML = html;
        }

        // Configurar filtros de piezas
        function setupPieceFilters() {
            const searchInput = document.getElementById('pieceSearch');
            const userSearchInput = document.getElementById('pieceUserSearch');
            const categoryFilter = document.getElementById('pieceCategoryFilter');
            const dateFromInput = document.getElementById('pieceDateFrom');
            const dateToInput = document.getElementById('pieceDateTo');

            searchInput.addEventListener('input', filterPieces);
            userSearchInput.addEventListener('input', filterPieces);
            categoryFilter.addEventListener('change', filterPieces);
            dateFromInput.addEventListener('change', filterPieces);
            dateToInput.addEventListener('change', filterPieces);
        }

        // Filtrar piezas
        function filterPieces() {
            const searchTerm = document.getElementById('pieceSearch').value.toLowerCase();
            const userSearchTerm = document.getElementById('pieceUserSearch').value.toLowerCase();
            const categoryFilter = document.getElementById('pieceCategoryFilter').value;
            const dateFrom = document.getElementById('pieceDateFrom').value;
            const dateTo = document.getElementById('pieceDateTo').value;

            let filteredPieces = allPieces.filter(piece => {
                // Filtro por t√≠tulo
                if (searchTerm && !piece.title.toLowerCase().includes(searchTerm)) {
                    return false;
                }

                // Filtro por usuario
                if (userSearchTerm) {
                    const user = allUsers.find(u => u.id === piece.user_id);
                    const userEmail = user ? user.email.toLowerCase() : '';
                    if (!userEmail.includes(userSearchTerm)) {
                        return false;
                    }
                }

                // Filtro por categor√≠a
                if (categoryFilter !== 'all' && piece.category !== categoryFilter) {
                    return false;
                }

                // Filtro por fecha
                const pieceDate = new Date(piece.created_at).toISOString().split('T')[0];
                if (dateFrom && pieceDate < dateFrom) {
                    return false;
                }
                if (dateTo && pieceDate > dateTo) {
                    return false;
                }

                return true;
            });

            displayPieces(filteredPieces);
        }

        // Limpiar filtros
        function clearPieceFilters() {
            document.getElementById('pieceSearch').value = '';
            document.getElementById('pieceUserSearch').value = '';
            document.getElementById('pieceCategoryFilter').value = 'all';
            document.getElementById('pieceDateFrom').value = '';
            document.getElementById('pieceDateTo').value = '';
            displayPieces(allPieces);
        }

        // Ver detalles de pieza
        function viewPieceDetails(pieceId) {
            const piece = allPieces.find(p => p.id === pieceId);
            const user = allUsers.find(u => u.id === piece.user_id);
            if (!piece) return;

            const modalContent = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <h4 style="color: #00ff88; margin-bottom: 10px;">üìã Informaci√≥n B√°sica</h4>
                        <div style="background: #0f0f0f; padding: 15px; border-radius: 8px;">
                            <p><strong>ID:</strong> ${piece.id}</p>
                            <p><strong>T√≠tulo:</strong> ${piece.title}</p>
                            <p><strong>Usuario:</strong> ${user?.email || 'No encontrado'}</p>
                            <p><strong>Categor√≠a:</strong> ${piece.category || 'Sin categor√≠a'}</p>
                            <p><strong>Creada:</strong> ${new Date(piece.created_at).toLocaleString('es-ES')}</p>
                            <p><strong>Actualizada:</strong> ${new Date(piece.updated_at).toLocaleString('es-ES')}</p>
                        </div>
                    </div>
                    <div>
                        <h4 style="color: #00ff88; margin-bottom: 10px;">üìä Estimaciones</h4>
                        <div style="background: #0f0f0f; padding: 15px; border-radius: 8px;">
                            <p><strong>Peso estimado:</strong> ${piece.est_weight_grams || 'N/A'} gramos</p>
                            <p><strong>Tiempo impresi√≥n:</strong> ${piece.est_print_time_min ? `${Math.floor(piece.est_print_time_min / 60)}h ${piece.est_print_time_min % 60}m` : 'N/A'}</p>
                            <p><strong>Precio estimado:</strong> ${piece.est_price_ars ? `$${parseFloat(piece.est_price_ars).toLocaleString()}` : 'N/A'}</p>
                            <p><strong>Filamento ID:</strong> ${piece.filament_id || 'No especificado'}</p>
                        </div>
                    </div>
                </div>
                
                ${piece.image_url ? `
                    <h4 style="color: #00ff88; margin-bottom: 10px;">üñºÔ∏è Imagen</h4>
                    <div style="background: #0f0f0f; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
                        <img src="${piece.image_url}" alt="${piece.title}" style="max-width: 300px; max-height: 200px; border-radius: 8px;" onerror="this.style.display='none'; this.nextSibling.style.display='block'">
                        <p style="display: none; color: #888;">Error cargando imagen</p>
                    </div>
                ` : ''}
                
                ${piece.notes ? `
                    <h4 style="color: #00ff88; margin-bottom: 10px;">üìù Notas</h4>
                    <div style="background: #0f0f0f; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <p>${piece.notes}</p>
                    </div>
                ` : ''}

                <div style="text-align: right; margin-top: 20px;">
                    <button class="action-btn secondary" onclick="viewPieceVersions('${piece.id}')">üìä Ver Historial</button>
                    <button class="action-btn danger" onclick="deletePieceConfirm('${piece.id}')" style="margin-left: 10px;">üóëÔ∏è Eliminar</button>
                    <button class="action-btn secondary" onclick="closePieceModal()" style="margin-left: 10px;">Cerrar</button>
                </div>
            `;

            document.getElementById('pieceDetailContent').innerHTML = modalContent;
            document.getElementById('pieceDetailModal').style.display = 'block';
        }

        // Ver versiones de pieza
        function viewPieceVersions(pieceId) {
            const piece = allPieces.find(p => p.id === pieceId);
            const user = allUsers.find(u => u.id === piece.user_id);
            const pieceVersions = allPieceVersions.filter(pv => pv.piece_id === pieceId);

            if (!piece) return;

            let versionsHtml = '';
            if (pieceVersions.length === 0) {
                versionsHtml = '<p>No hay versiones guardadas para esta pieza.</p>';
            } else {
                versionsHtml = `
                    <div style="max-height: 400px; overflow-y: auto;">
                        ${pieceVersions.map((version, index) => {
                            const versionDate = new Date(version.created_at).toLocaleString('es-ES');
                            const total = version.total ? `$${parseFloat(version.total).toLocaleString()}` : 'N/A';
                            const mlPrice = version.ml_price ? `$${parseFloat(version.ml_price).toLocaleString()}` : 'N/A';
                            
                            // Parsear par√°metros si existen
                            let paramsHtml = '';
                            if (version.params) {
                                try {
                                    const params = typeof version.params === 'string' ? JSON.parse(version.params) : version.params;
                                    paramsHtml = `
                                        <div style="margin-top: 10px; font-size: 0.9em; color: #888;">
                                            <strong>Par√°metros:</strong> 
                                            Filamento: ${params.gramos || 'N/A'}g, 
                                            Tiempo: ${params.tiempo_h || 0}h ${params.tiempo_min || 0}m,
                                            Energ√≠a: ${params.energia_kwh || 'N/A'} kWh
                                        </div>
                                    `;
                                } catch (e) {
                                    paramsHtml = '<div style="margin-top: 10px; font-size: 0.9em; color: #888;">Par√°metros no disponibles</div>';
                                }
                            }

                            return `
                                <div style="background: #0f0f0f; padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #333;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <strong>Versi√≥n #${pieceVersions.length - index}</strong>
                                            <small style="color: #888; margin-left: 10px;">${versionDate}</small>
                                        </div>
                                        <div style="text-align: right;">
                                            <div><strong>Total: ${total}</strong></div>
                                            <div style="color: #888; font-size: 0.9em;">ML: ${mlPrice}</div>
                                        </div>
                                    </div>
                                    ${paramsHtml}
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }

            const modalContent = `
                <h4 style="color: #00ff88; margin-bottom: 15px;">üìä Historial de C√°lculos - "${piece.title}"</h4>
                <p style="color: #888; margin-bottom: 20px;">
                    Usuario: ${user?.email || 'No encontrado'} | Total de versiones: ${pieceVersions.length}
                </p>
                ${versionsHtml}
                <div style="text-align: right; margin-top: 20px;">
                    <button class="action-btn secondary" onclick="closePieceModal()">Cerrar</button>
                </div>
            `;

            document.getElementById('pieceDetailContent').innerHTML = modalContent;
            document.getElementById('pieceDetailModal').style.display = 'block';
        }

        // Eliminar pieza (con confirmaci√≥n)
        function deletePieceConfirm(pieceId) {
            const piece = allPieces.find(p => p.id === pieceId);
            if (!confirm(`¬øEst√°s seguro de eliminar la pieza "${piece.title}"? Esta acci√≥n eliminar√° tambi√©n todas sus versiones y no se puede deshacer.`)) return;
            
            deletePiece(pieceId);
        }

        // Eliminar pieza
        async function deletePiece(pieceId) {
            if (!checkAdminAuth()) return;
            try {
                // Registrar actividad de eliminaci√≥n
                const adminSession = window.authGuard?.getCurrentAdmin();
                if (adminSession) {
                    window.authGuard?.logActivity(
                        adminSession.admin_id,
                        'DELETE',
                        'PIECE',
                        pieceId,
                        { action: 'delete_piece_with_versions' }
                    );
                }
                // Eliminar versiones primero
                await supabase
                    .from('piece_versions')
                    .delete()
                    .eq('piece_id', pieceId);

                // Eliminar pieza
                await supabase
                    .from('pieces')
                    .delete()
                    .eq('id', pieceId);

                alert('Pieza eliminada correctamente');
                closePieceModal();
                loadDashboard(); // Recargar datos
                loadPieces(); // Recargar tabla

            } catch (error) {
                console.error('Error eliminando pieza:', error);
                alert('Error eliminando pieza: ' + error.message);
            }
        }

        // Cerrar modal de pieza
        function closePieceModal() {
            document.getElementById('pieceDetailModal').style.display = 'none';
        }

        // ================ ANALYTICS FUNCTIONS ================

        // Cargar an√°lisis avanzado
        async function loadAnalytics() {
            if (!checkAdminAuth()) return;
            try {
                console.log('üìä Cargando an√°lisis avanzado...');
                
                if (allUsers.length === 0) {
                    await loadDashboard(); // Cargar datos si no est√°n disponibles
                }

                // Calcular y mostrar puntuaciones de salud
                const healthScores = calculateUserHealthScores();
                displayHealthMetrics(healthScores);
                displayUserHealthTable(healthScores);
                
                // Mostrar an√°lisis de tendencias
                displayMonthlyAnalytics();
                displayRetentionAnalysis();

                console.log('‚úÖ Analytics cargado correctamente');

            } catch (error) {
                console.error('‚ùå Error cargando analytics:', error);
                document.getElementById('healthScoreContent').innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        // Calcular puntuaciones de salud de usuarios
        function calculateUserHealthScores() {
            const healthScores = [];
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

            allUsers.forEach(user => {
                let score = 0;
                let factors = [];

                // Factor 1: Usuario verificado (+20 puntos)
                if (user.email_confirmed_at) {
                    score += 20;
                    factors.push('Email verificado: +20');
                } else {
                    factors.push('Email no verificado: 0');
                }

                // Factor 2: Actividad reciente (+30 puntos)
                const lastLogin = user.last_sign_in_at ? new Date(user.last_sign_in_at) : null;
                if (lastLogin && lastLogin > sevenDaysAgo) {
                    score += 30;
                    factors.push('Login reciente (7 d√≠as): +30');
                } else if (lastLogin && lastLogin > thirtyDaysAgo) {
                    score += 15;
                    factors.push('Login medio (30 d√≠as): +15');
                } else {
                    factors.push('Sin actividad reciente: 0');
                }

                // Factor 3: Piezas creadas (+25 puntos)
                const userPieces = allPieces.filter(p => p.user_id === user.id);
                if (userPieces.length >= 5) {
                    score += 25;
                    factors.push(`${userPieces.length} piezas (5+): +25`);
                } else if (userPieces.length >= 1) {
                    score += 10;
                    factors.push(`${userPieces.length} piezas: +10`);
                } else {
                    factors.push('Sin piezas: 0');
                }

                // Factor 4: Suscripci√≥n activa (+25 puntos)
                const userSubscription = allSubscriptions.find(s => s.user_id === user.id && s.active);
                if (userSubscription) {
                    const expiry = userSubscription.expires_at ? new Date(userSubscription.expires_at) : null;
                    if (!expiry || expiry > new Date()) {
                        score += 25;
                        factors.push(`Suscripci√≥n ${userSubscription.plan_type}: +25`);
                    } else {
                        score += 5;
                        factors.push('Suscripci√≥n expirada: +5');
                    }
                } else {
                    factors.push('Sin suscripci√≥n: 0');
                }

                // Determinar categor√≠a de salud
                let healthCategory = 'churning';
                let healthLabel = 'Abandonando';
                let healthColor = '#ff4444';

                if (score >= 80) {
                    healthCategory = 'healthy';
                    healthLabel = 'Saludable';
                    healthColor = '#00ff88';
                } else if (score >= 50) {
                    healthCategory = 'at-risk';
                    healthLabel = 'En Riesgo';
                    healthColor = '#ffaa00';
                }

                healthScores.push({
                    user,
                    score,
                    factors,
                    category: healthCategory,
                    label: healthLabel,
                    color: healthColor,
                    pieces: userPieces.length,
                    subscription: userSubscription ? userSubscription.plan_type : 'Ninguna',
                    lastActivity: lastLogin ? lastLogin.toLocaleDateString('es-ES') : 'Nunca'
                });
            });

            // Ordenar por puntuaci√≥n descendente
            healthScores.sort((a, b) => b.score - a.score);
            return healthScores;
        }

        // Mostrar m√©tricas de salud
        function displayHealthMetrics(healthScores) {
            const healthy = healthScores.filter(h => h.category === 'healthy').length;
            const atRisk = healthScores.filter(h => h.category === 'at-risk').length;
            const churning = healthScores.filter(h => h.category === 'churning').length;
            const averageScore = healthScores.reduce((sum, h) => sum + h.score, 0) / healthScores.length;

            document.getElementById('healthyUsers').textContent = healthy;
            document.getElementById('atRiskUsers').textContent = atRisk;
            document.getElementById('churningUsers').textContent = churning;
            document.getElementById('averageHealthScore').textContent = Math.round(averageScore);
        }

        // Mostrar tabla de salud de usuarios
        function displayUserHealthTable(healthScores) {
            if (!healthScores || healthScores.length === 0) {
                document.getElementById('healthScoreContent').innerHTML = '<p>No hay datos de usuarios</p>';
                return;
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Usuario</th>
                            <th>Puntuaci√≥n</th>
                            <th>Estado</th>
                            <th>Piezas</th>
                            <th>Suscripci√≥n</th>
                            <th>√öltima Actividad</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            healthScores.forEach(userHealth => {
                const progressBar = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="background: #333; border-radius: 10px; width: 100px; height: 8px; overflow: hidden;">
                            <div style="background: ${userHealth.color}; height: 100%; width: ${userHealth.score}%; transition: width 0.3s ease;"></div>
                        </div>
                        <strong>${userHealth.score}</strong>
                    </div>
                `;

                html += `
                    <tr>
                        <td><strong>${userHealth.user.email}</strong></td>
                        <td>${progressBar}</td>
                        <td><span class="status-badge" style="background: ${userHealth.color}; color: ${userHealth.category === 'healthy' ? '#000' : '#fff'};">${userHealth.label}</span></td>
                        <td><strong>${userHealth.pieces}</strong></td>
                        <td><span class="status-badge ${userHealth.subscription === 'Ninguna' ? 'status-inactive' : 'status-active'}">${userHealth.subscription}</span></td>
                        <td>${userHealth.lastActivity}</td>
                        <td>
                            <button class="action-btn" onclick="viewHealthDetails('${userHealth.user.id}')">üìä Detalles</button>
                            <button class="action-btn secondary" onclick="contactUser('${userHealth.user.id}', '${userHealth.category}')">üìß Contactar</button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            document.getElementById('healthScoreContent').innerHTML = html;

            // Configurar filtro de salud
            setupHealthFilter(healthScores);
        }

        // Configurar filtro de salud
        function setupHealthFilter(healthScores) {
            const healthFilter = document.getElementById('healthFilter');
            healthFilter.addEventListener('change', () => {
                const filterValue = healthFilter.value;
                let filteredScores = healthScores;

                if (filterValue !== 'all') {
                    filteredScores = healthScores.filter(h => h.category === filterValue);
                }

                displayUserHealthTable(filteredScores);
            });
        }

        // Ver detalles de salud del usuario
        function viewHealthDetails(userId) {
            const healthData = calculateUserHealthScores().find(h => h.user.id === userId);
            if (!healthData) return;

            const modalContent = `
                <h4 style="color: #00ff88; margin-bottom: 15px;">üìä An√°lisis de Salud - ${healthData.user.email}</h4>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <h5 style="color: ${healthData.color}; margin-bottom: 10px;">Puntuaci√≥n: ${healthData.score}/100</h5>
                        <div style="background: #333; border-radius: 10px; height: 20px; overflow: hidden; margin-bottom: 15px;">
                            <div style="background: ${healthData.color}; height: 100%; width: ${healthData.score}%; transition: width 0.3s ease;"></div>
                        </div>
                        <p><strong>Categor√≠a:</strong> <span style="color: ${healthData.color};">${healthData.label}</span></p>
                    </div>
                    <div>
                        <h5 style="color: #00ff88; margin-bottom: 10px;">Estad√≠sticas R√°pidas</h5>
                        <p><strong>Piezas creadas:</strong> ${healthData.pieces}</p>
                        <p><strong>Suscripci√≥n:</strong> ${healthData.subscription}</p>
                        <p><strong>√öltima actividad:</strong> ${healthData.lastActivity}</p>
                        <p><strong>Verificado:</strong> ${healthData.user.email_confirmed_at ? 'S√≠' : 'No'}</p>
                    </div>
                </div>

                <h5 style="color: #00ff88; margin-bottom: 10px;">Factores de Puntuaci√≥n:</h5>
                <div style="background: #0f0f0f; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    ${healthData.factors.map(factor => `<p style="margin: 5px 0; color: #e0e0e0;">‚Ä¢ ${factor}</p>`).join('')}
                </div>

                <h5 style="color: #00ff88; margin-bottom: 10px;">Recomendaciones:</h5>
                <div style="background: #0f0f0f; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    ${getHealthRecommendations(healthData)}
                </div>

                <div style="text-align: right; margin-top: 20px;">
                    <button class="action-btn secondary" onclick="contactUser('${userId}', '${healthData.category}')">üìß Contactar Usuario</button>
                    <button class="action-btn secondary" onclick="closeUserModal()" style="margin-left: 10px;">Cerrar</button>
                </div>
            `;

            document.getElementById('userEditContent').innerHTML = modalContent;
            document.getElementById('userEditModal').style.display = 'block';
        }

        // Obtener recomendaciones basadas en la salud del usuario
        function getHealthRecommendations(healthData) {
            let recommendations = [];

            if (!healthData.user.email_confirmed_at) {
                recommendations.push('<p style="color: #ff4444;">‚Ä¢ Enviar recordatorio de verificaci√≥n de email</p>');
            }

            if (healthData.pieces === 0) {
                recommendations.push('<p style="color: #ffaa00;">‚Ä¢ Enviar tutorial de uso de la calculadora</p>');
            } else if (healthData.pieces < 3) {
                recommendations.push('<p style="color: #ffaa00;">‚Ä¢ Incentivar a crear m√°s piezas con ejemplos</p>');
            }

            if (healthData.subscription === 'Ninguna') {
                recommendations.push('<p style="color: #00ff88;">‚Ä¢ Ofrecer trial gratuito de suscripci√≥n premium</p>');
            }

            const lastLogin = healthData.user.last_sign_in_at ? new Date(healthData.user.last_sign_in_at) : null;
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

            if (!lastLogin || lastLogin < sevenDaysAgo) {
                recommendations.push('<p style="color: #ff4444;">‚Ä¢ Enviar email de reactivaci√≥n</p>');
            }

            if (healthData.category === 'healthy') {
                recommendations.push('<p style="color: #00ff88;">‚Ä¢ Usuario saludable - considerar para programa de referidos</p>');
            }

            return recommendations.length > 0 ? recommendations.join('') : '<p style="color: #888;">No hay recomendaciones espec√≠ficas</p>';
        }

        // Contactar usuario (placeholder)
        function contactUser(userId, category) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;

            let template = '';
            switch (category) {
                case 'churning':
                    template = 'Reactivaci√≥n - Usuario inactivo';
                    break;
                case 'at-risk':
                    template = 'Retenci√≥n - Usuario en riesgo';
                    break;
                case 'healthy':
                    template = 'Engagement - Usuario activo';
                    break;
            }

            const modalContent = `
                <h4 style="color: #00ff88; margin-bottom: 15px;">üìß Contactar Usuario - ${user.email}</h4>
                
                <div class="form-group">
                    <label>Template sugerido:</label>
                    <input type="text" value="${template}" readonly style="background: #333;">
                </div>

                <div class="form-group">
                    <label>Mensaje personalizado:</label>
                    <textarea placeholder="Escribir mensaje..." rows="6" id="contactMessage"></textarea>
                </div>

                <div style="text-align: right; margin-top: 20px;">
                    <button class="action-btn secondary" onclick="closeUserModal()">Cancelar</button>
                    <button class="action-btn" onclick="sendUserMessage('${userId}')">üìß Enviar Email</button>
                </div>
            `;

            document.getElementById('userEditContent').innerHTML = modalContent;
            document.getElementById('userEditModal').style.display = 'block';
        }

        // Enviar mensaje (placeholder)
        function sendUserMessage(userId) {
            const message = document.getElementById('contactMessage').value;
            if (!message.trim()) {
                alert('Por favor escribe un mensaje');
                return;
            }
            
            // Aqu√≠ ir√≠a la integraci√≥n con sistema de email
            alert('Funcionalidad de env√≠o de emails en desarrollo.\n\nMensaje preparado para: ' + allUsers.find(u => u.id === userId)?.email);
            closeUserModal();
        }

        // Exportar datos de salud
        function exportHealthData() {
            const healthScores = calculateUserHealthScores();
            const csvContent = [
                ['Email', 'Puntuaci√≥n', 'Categor√≠a', 'Piezas', 'Suscripci√≥n', '√öltima Actividad', 'Email Verificado'],
                ...healthScores.map(h => [
                    h.user.email,
                    h.score,
                    h.label,
                    h.pieces,
                    h.subscription,
                    h.lastActivity,
                    h.user.email_confirmed_at ? 'S√≠' : 'No'
                ])
            ].map(row => row.join(',')).join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `zetalab-health-scores-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Mostrar an√°lisis mensual
        function displayMonthlyAnalytics() {
            // An√°lisis de actividad mensual
            const monthlyData = {};
            
            // Registros de usuarios por mes
            allUsers.forEach(user => {
                const month = new Date(user.created_at).toLocaleDateString('es-ES', { year: 'numeric', month: 'short' });
                if (!monthlyData[month]) monthlyData[month] = { users: 0, pieces: 0, revenue: 0 };
                monthlyData[month].users++;
            });

            // Piezas por mes
            allPieces.forEach(piece => {
                const month = new Date(piece.created_at).toLocaleDateString('es-ES', { year: 'numeric', month: 'short' });
                if (!monthlyData[month]) monthlyData[month] = { users: 0, pieces: 0, revenue: 0 };
                monthlyData[month].pieces++;
            });

            // Ingresos por mes
            allSubscriptions.forEach(sub => {
                const month = new Date(sub.created_at).toLocaleDateString('es-ES', { year: 'numeric', month: 'short' });
                if (!monthlyData[month]) monthlyData[month] = { users: 0, pieces: 0, revenue: 0 };
                monthlyData[month].revenue += parseFloat(sub.amount || 0);
            });

            // Crear gr√°fico simple de actividad
            let activityHtml = '<div style="max-height: 300px; overflow-y: auto;">';
            Object.entries(monthlyData).sort().forEach(([month, data]) => {
                const maxUsers = Math.max(...Object.values(monthlyData).map(d => d.users));
                const widthPercentage = maxUsers > 0 ? (data.users / maxUsers) * 100 : 0;
                
                activityHtml += `
                    <div style="margin-bottom: 10px; padding: 8px; background: #1a1a1a; border-radius: 5px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <strong>${month}</strong>
                            <span>${data.users} usuarios, ${data.pieces} piezas</span>
                        </div>
                        <div style="background: #333; height: 6px; border-radius: 3px; overflow: hidden;">
                            <div style="background: #00ff88; height: 100%; width: ${widthPercentage}%; transition: width 0.3s ease;"></div>
                        </div>
                    </div>
                `;
            });
            activityHtml += '</div>';

            document.getElementById('monthlyActivityChart').innerHTML = activityHtml;

            // Crear gr√°fico de ingresos
            let revenueHtml = '<div style="max-height: 300px; overflow-y: auto;">';
            const maxRevenue = Math.max(...Object.values(monthlyData).map(d => d.revenue));
            
            Object.entries(monthlyData).sort().forEach(([month, data]) => {
                const widthPercentage = maxRevenue > 0 ? (data.revenue / maxRevenue) * 100 : 0;
                
                revenueHtml += `
                    <div style="margin-bottom: 10px; padding: 8px; background: #1a1a1a; border-radius: 5px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <strong>${month}</strong>
                            <span>$${data.revenue.toLocaleString()}</span>
                        </div>
                        <div style="background: #333; height: 6px; border-radius: 3px; overflow: hidden;">
                            <div style="background: #ffaa00; height: 100%; width: ${widthPercentage}%; transition: width 0.3s ease;"></div>
                        </div>
                    </div>
                `;
            });
            revenueHtml += '</div>';

            document.getElementById('monthlyRevenueChart').innerHTML = revenueHtml;
        }

        // Mostrar an√°lisis de retenci√≥n
        function displayRetentionAnalysis() {
            const now = new Date();
            const thirtyDaysAgo = new Date(now.getTime() - (30 * 24 * 60 * 60 * 1000));
            const sixtyDaysAgo = new Date(now.getTime() - (60 * 24 * 60 * 60 * 1000));
            const ninetyDaysAgo = new Date(now.getTime() - (90 * 24 * 60 * 60 * 1000));

            // Usuarios nuevos en diferentes per√≠odos
            const newUsers30 = allUsers.filter(u => new Date(u.created_at) > thirtyDaysAgo).length;
            const newUsers60 = allUsers.filter(u => new Date(u.created_at) > sixtyDaysAgo && new Date(u.created_at) <= thirtyDaysAgo).length;
            const newUsers90 = allUsers.filter(u => new Date(u.created_at) > ninetyDaysAgo && new Date(u.created_at) <= sixtyDaysAgo).length;

            // Usuarios activos en diferentes per√≠odos
            const activeUsers30 = allUsers.filter(u => u.last_sign_in_at && new Date(u.last_sign_in_at) > thirtyDaysAgo).length;
            const activeUsers60 = allUsers.filter(u => u.last_sign_in_at && new Date(u.last_sign_in_at) > sixtyDaysAgo && new Date(u.last_sign_in_at) <= thirtyDaysAgo).length;

            // Calcular tasas de retenci√≥n
            const retention30 = newUsers60 > 0 ? ((activeUsers30 / newUsers60) * 100).toFixed(1) : '0';
            const retention60 = newUsers90 > 0 ? ((activeUsers60 / newUsers90) * 100).toFixed(1) : '0';

            const retentionHtml = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div style="background: #1a1a1a; padding: 15px; border-radius: 8px; text-align: center;">
                        <h4 style="color: #00ff88; margin-bottom: 10px;">Nuevos (30d)</h4>
                        <div style="font-size: 2em; font-weight: bold;">${newUsers30}</div>
                        <div style="color: #888;">usuarios</div>
                    </div>
                    <div style="background: #1a1a1a; padding: 15px; border-radius: 8px; text-align: center;">
                        <h4 style="color: #ffaa00; margin-bottom: 10px;">Retenci√≥n 30d</h4>
                        <div style="font-size: 2em; font-weight: bold;">${retention30}%</div>
                        <div style="color: #888;">de usuarios del mes anterior</div>
                    </div>
                    <div style="background: #1a1a1a; padding: 15px; border-radius: 8px; text-align: center;">
                        <h4 style="color: #ff4444; margin-bottom: 10px;">Retenci√≥n 60d</h4>
                        <div style="font-size: 2em; font-weight: bold;">${retention60}%</div>
                        <div style="color: #888;">de usuarios hace 2 meses</div>
                    </div>
                    <div style="background: #1a1a1a; padding: 15px; border-radius: 8px; text-align: center;">
                        <h4 style="color: #666; margin-bottom: 10px;">Total Activos</h4>
                        <div style="font-size: 2em; font-weight: bold;">${activeUsers30}</div>
                        <div style="color: #888;">√∫ltimos 30 d√≠as</div>
                    </div>
                </div>

                <div style="margin-top: 20px; padding: 15px; background: #1a1a1a; border-radius: 8px;">
                    <h5 style="color: #00ff88; margin-bottom: 10px;">üìà Insights de Retenci√≥n</h5>
                    <ul style="color: #e0e0e0; list-style: none; padding: 0;">
                        <li style="margin: 5px 0;">‚Ä¢ ${retention30 > 50 ? '‚úÖ' : '‚ùå'} Retenci√≥n a 30 d√≠as: ${retention30}% ${retention30 > 50 ? '(Buena)' : '(Necesita mejora)'}</li>
                        <li style="margin: 5px 0;">‚Ä¢ ${newUsers30 > newUsers60 ? 'üìà' : 'üìâ'} Adquisici√≥n: ${newUsers30 > newUsers60 ? 'Creciendo' : 'Decreciendo'} (${newUsers30} vs ${newUsers60})</li>
                        <li style="margin: 5px 0;">‚Ä¢ ${activeUsers30 > (allUsers.length * 0.3) ? 'üí™' : '‚ö†Ô∏è'} Actividad: ${((activeUsers30 / allUsers.length) * 100).toFixed(1)}% de usuarios totales activos</li>
                    </ul>
                </div>
            `;

            document.getElementById('retentionAnalysis').innerHTML = retentionHtml;
        }

        // ===== FINANCIAL DASHBOARD FUNCTIONS =====

        async function loadFinancials() {
            if (!checkAdminAuth()) return;
            try {
                console.log('üí∞ Cargando an√°lisis financiero...');
                
                // Cargar datos si no est√°n disponibles
                if (allUsers.length === 0) await loadAllData();
                
                // Calcular m√©tricas financieras
                await calculateFinancialKPIs();
                await loadFinancialCharts();
                await loadFinancialAlerts();
                await loadDetailedFinancials();
                
                console.log('‚úÖ An√°lisis financiero cargado');
            } catch (error) {
                console.error('Error loading financials:', error);
                document.getElementById('financialAlerts').innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function calculateFinancialKPIs() {
            const now = new Date();
            const currentMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            const lastYear = new Date(now.getFullYear() - 1, now.getMonth(), 1);

            // Filtrar suscripciones activas y por fechas
            const activeSubscriptions = allSubscriptions.filter(sub => 
                sub.active && sub.payment_status === 'paid'
            );
            
            const currentMonthSubs = activeSubscriptions.filter(sub => 
                new Date(sub.created_at) >= currentMonth
            );
            
            const lastMonthSubs = activeSubscriptions.filter(sub => {
                const subDate = new Date(sub.created_at);
                return subDate >= lastMonth && subDate < currentMonth;
            });

            // 1. MRR Actual
            const currentMRR = activeSubscriptions.reduce((sum, sub) => {
                const amount = parseFloat(sub.amount) || 0;
                return sum + (sub.plan_type === 'monthly' ? amount : amount / 12);
            }, 0);

            const lastMonthMRR = allSubscriptions
                .filter(sub => {
                    const subDate = new Date(sub.created_at);
                    return subDate >= lastMonth && subDate < currentMonth && sub.active;
                })
                .reduce((sum, sub) => {
                    const amount = parseFloat(sub.amount) || 0;
                    return sum + (sub.plan_type === 'monthly' ? amount : amount / 12);
                }, 0);

            const mrrGrowth = lastMonthMRR > 0 ? ((currentMRR - lastMonthMRR) / lastMonthMRR * 100) : 0;

            // 2. Ingresos Totales
            const totalRevenue = allSubscriptions
                .filter(sub => sub.payment_status === 'paid')
                .reduce((sum, sub) => sum + (parseFloat(sub.amount) || 0), 0);

            const lastYearRevenue = allSubscriptions
                .filter(sub => {
                    const subDate = new Date(sub.created_at);
                    return subDate >= lastYear && subDate < new Date(lastYear.getTime() + 365*24*60*60*1000) && sub.payment_status === 'paid';
                })
                .reduce((sum, sub) => sum + (parseFloat(sub.amount) || 0), 0);

            const revenueGrowth = lastYearRevenue > 0 ? ((totalRevenue - lastYearRevenue) / lastYearRevenue * 100) : 0;

            // 3. ARPU - Average Revenue Per User
            const payingUsers = activeSubscriptions.length;
            const arpu = payingUsers > 0 ? currentMRR / payingUsers : 0;
            
            // 4. Churn Rate
            const expiredThisMonth = allSubscriptions.filter(sub => {
                const expDate = new Date(sub.expires_at);
                return expDate >= currentMonth && expDate < new Date(currentMonth.getTime() + 32*24*60*60*1000) && !sub.active;
            }).length;
            
            const activeLastMonth = allSubscriptions.filter(sub => {
                const subDate = new Date(sub.created_at);
                return subDate < currentMonth && sub.active;
            }).length;

            const churnRate = activeLastMonth > 0 ? (expiredThisMonth / activeLastMonth * 100) : 0;

            // 5. Customer LTV (simplificado)
            const avgSubscriptionLength = 12; // meses estimado
            const customerLTV = arpu * avgSubscriptionLength;

            // 6. Payment Success Rate
            const totalPayments = allSubscriptions.length;
            const successfulPayments = allSubscriptions.filter(sub => sub.payment_status === 'paid').length;
            const paymentSuccessRate = totalPayments > 0 ? (successfulPayments / totalPayments * 100) : 0;

            // Actualizar UI
            document.getElementById('currentMRR').textContent = `$${currentMRR.toFixed(2)}`;
            document.getElementById('mrrGrowth').textContent = `${mrrGrowth >= 0 ? '+' : ''}${mrrGrowth.toFixed(1)}%`;
            document.getElementById('mrrGrowth').style.color = mrrGrowth >= 0 ? '#00ff88' : '#ff4444';

            document.getElementById('totalRevenue').textContent = `$${totalRevenue.toFixed(2)}`;
            document.getElementById('revenueGrowth').textContent = `${revenueGrowth >= 0 ? '+' : ''}${revenueGrowth.toFixed(1)}%`;
            document.getElementById('revenueGrowth').style.color = revenueGrowth >= 0 ? '#00ff88' : '#ff4444';

            document.getElementById('avgRevenuePU').textContent = `$${arpu.toFixed(2)}`;
            
            document.getElementById('churnRate').textContent = `${churnRate.toFixed(1)}%`;
            document.getElementById('churnTrend').style.color = churnRate <= 5 ? '#00ff88' : '#ff4444';

            document.getElementById('customerLTV').textContent = `$${customerLTV.toFixed(2)}`;
            
            document.getElementById('paymentSuccessRate').textContent = `${paymentSuccessRate.toFixed(1)}%`;
            document.getElementById('paymentTrend').style.color = paymentSuccessRate >= 90 ? '#00ff88' : '#ff4444';
        }

        // Function to destroy all existing financial charts
        function destroyFinancialCharts() {
            const chartIds = ['mrrChart', 'revenueByPlanChart', 'cohortRevenueChart', 'conversionChart', 'churnChart', 'forecastChart'];
            
            chartIds.forEach(chartId => {
                try {
                    if (chartInstances[chartId]) {
                        chartInstances[chartId].destroy();
                        delete chartInstances[chartId];
                    }
                } catch (error) {
                    console.warn(`Error destroying chart ${chartId}:`, error);
                    // Still delete the reference to prevent memory leaks
                    delete chartInstances[chartId];
                }
            });
        }

        async function loadFinancialCharts() {
            // Destroy existing charts before creating new ones
            destroyFinancialCharts();

            // Preparar datos para charts
            const monthlyData = prepareMonthlyRevenueData();
            const planData = preparePlanRevenueData();
            const cohortData = prepareCohortData();
            const conversionData = prepareConversionData();
            const churnAnalysisData = prepareChurnData();
            const forecastData = prepareForecastData();

            // MRR Chart
            createMRRChart(monthlyData);
            
            // Revenue by Plan Chart
            createRevenueByPlanChart(planData);
            
            // Cohort Revenue Chart
            createCohortRevenueChart(cohortData);
            
            // Conversion Chart
            createConversionChart(conversionData);
            
            // Churn Chart
            createChurnChart(churnAnalysisData);
            
            // Forecast Chart
            createForecastChart(forecastData);
        }

        function prepareMonthlyRevenueData() {
            const monthlyRevenue = {};
            const now = new Date();
            
            // √öltimos 12 meses
            for (let i = 11; i >= 0; i--) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const key = date.toISOString().substring(0, 7);
                monthlyRevenue[key] = 0;
            }

            allSubscriptions
                .filter(sub => sub.payment_status === 'paid')
                .forEach(sub => {
                    const date = new Date(sub.created_at);
                    const key = date.toISOString().substring(0, 7);
                    if (monthlyRevenue.hasOwnProperty(key)) {
                        monthlyRevenue[key] += parseFloat(sub.amount) || 0;
                    }
                });

            return {
                labels: Object.keys(monthlyRevenue).map(key => {
                    const date = new Date(key + '-01');
                    return date.toLocaleDateString('es-ES', { month: 'short', year: '2-digit' });
                }),
                data: Object.values(monthlyRevenue)
            };
        }

        function preparePlanRevenueData() {
            const planRevenue = {};
            
            allSubscriptions
                .filter(sub => sub.payment_status === 'paid' && sub.active)
                .forEach(sub => {
                    const plan = sub.plan_type || 'unknown';
                    planRevenue[plan] = (planRevenue[plan] || 0) + (parseFloat(sub.amount) || 0);
                });

            return {
                labels: Object.keys(planRevenue),
                data: Object.values(planRevenue)
            };
        }

        function prepareCohortData() {
            // An√°lisis de cohortes simplificado por mes de registro
            const cohorts = {};
            
            allUsers.forEach(user => {
                const registerDate = new Date(user.created_at);
                const cohortKey = registerDate.toISOString().substring(0, 7);
                
                if (!cohorts[cohortKey]) {
                    cohorts[cohortKey] = { users: 0, revenue: 0 };
                }
                
                cohorts[cohortKey].users++;
                
                // Buscar suscripciones de este usuario
                const userSubs = allSubscriptions.filter(sub => sub.user_id === user.id && sub.payment_status === 'paid');
                cohorts[cohortKey].revenue += userSubs.reduce((sum, sub) => sum + (parseFloat(sub.amount) || 0), 0);
            });

            return Object.keys(cohorts)
                .sort()
                .slice(-6) // √öltimos 6 meses
                .map(key => ({
                    month: key,
                    users: cohorts[key].users,
                    revenue: cohorts[key].revenue,
                    arpu: cohorts[key].users > 0 ? cohorts[key].revenue / cohorts[key].users : 0
                }));
        }

        function prepareConversionData() {
            const trialUsers = allSubscriptions.filter(sub => sub.plan_type === 'trial').length;
            const paidUsers = allSubscriptions.filter(sub => sub.plan_type !== 'trial' && sub.active).length;
            const totalUsers = allUsers.length;
            
            const trialConversion = trialUsers > 0 ? (paidUsers / trialUsers * 100) : 0;
            const overallConversion = totalUsers > 0 ? (paidUsers / totalUsers * 100) : 0;
            
            return {
                trialConversion,
                overallConversion,
                trialUsers,
                paidUsers,
                totalUsers
            };
        }

        function prepareChurnData() {
            const now = new Date();
            const periods = [];
            
            // √öltimos 6 meses
            for (let i = 5; i >= 0; i--) {
                const monthStart = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const monthEnd = new Date(now.getFullYear(), now.getMonth() - i + 1, 0);
                
                const activeStart = allSubscriptions.filter(sub => {
                    const subDate = new Date(sub.created_at);
                    return subDate < monthStart && sub.active;
                }).length;
                
                const churned = allSubscriptions.filter(sub => {
                    const expDate = new Date(sub.expires_at);
                    return expDate >= monthStart && expDate <= monthEnd && !sub.active;
                }).length;
                
                const churnRate = activeStart > 0 ? (churned / activeStart * 100) : 0;
                
                periods.push({
                    month: monthStart.toLocaleDateString('es-ES', { month: 'short', year: '2-digit' }),
                    churnRate
                });
            }
            
            return periods;
        }

        function prepareForecastData() {
            const currentMRR = allSubscriptions
                .filter(sub => sub.active && sub.payment_status === 'paid')
                .reduce((sum, sub) => {
                    const amount = parseFloat(sub.amount) || 0;
                    return sum + (sub.plan_type === 'monthly' ? amount : amount / 12);
                }, 0);

            const avgGrowthRate = 0.15; // 15% crecimiento mensual estimado
            const forecast = [];
            
            for (let i = 0; i < 6; i++) {
                const date = new Date();
                date.setMonth(date.getMonth() + i);
                
                const projectedMRR = currentMRR * Math.pow(1 + avgGrowthRate, i);
                
                forecast.push({
                    month: date.toLocaleDateString('es-ES', { month: 'short', year: '2-digit' }),
                    projectedMRR
                });
            }
            
            return forecast;
        }

        function createMRRChart(data) {
            try {
                const ctx = document.getElementById('mrrChart').getContext('2d');
                chartInstances.mrrChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'MRR ($)',
                        data: data.data,
                        borderColor: '#00ff88',
                        backgroundColor: 'rgba(0, 255, 136, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: { color: '#e0e0e0' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#888' },
                            grid: { color: 'rgba(136, 136, 136, 0.2)' }
                        },
                        y: {
                            ticks: { 
                                color: '#888',
                                callback: function(value) {
                                    return '$' + value.toFixed(0);
                                }
                            },
                            grid: { color: 'rgba(136, 136, 136, 0.2)' }
                        }
                    }
                }
            });
            } catch (error) {
                console.error('Error creating MRR chart:', error);
            }
        }

        function createRevenueByPlanChart(data) {
            const ctx = document.getElementById('revenueByPlanChart').getContext('2d');
            chartInstances.revenueByPlanChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.labels,
                    datasets: [{
                        data: data.data,
                        backgroundColor: [
                            '#00ff88',
                            '#ff6b6b',
                            '#4ecdc4',
                            '#45b7d1',
                            '#f9ca24'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: { color: '#e0e0e0' },
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function createCohortRevenueChart(data) {
            const ctx = document.getElementById('cohortRevenueChart').getContext('2d');
            chartInstances.cohortRevenueChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.month),
                    datasets: [
                        {
                            label: 'Revenue ($)',
                            data: data.map(d => d.revenue),
                            backgroundColor: 'rgba(0, 255, 136, 0.7)',
                            yAxisID: 'y'
                        },
                        {
                            label: 'ARPU ($)',
                            data: data.map(d => d.arpu),
                            type: 'line',
                            borderColor: '#ff6b6b',
                            backgroundColor: 'rgba(255, 107, 107, 0.1)',
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: { color: '#e0e0e0' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#888' },
                            grid: { color: 'rgba(136, 136, 136, 0.2)' }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            ticks: { 
                                color: '#888',
                                callback: function(value) {
                                    return '$' + value.toFixed(0);
                                }
                            },
                            grid: { color: 'rgba(136, 136, 136, 0.2)' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            ticks: { 
                                color: '#888',
                                callback: function(value) {
                                    return '$' + value.toFixed(0);
                                }
                            },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }

        function createConversionChart(data) {
            const ctx = document.getElementById('conversionChart').getContext('2d');
            chartInstances.conversionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Trial ‚Üí Paid', 'Overall Conversion'],
                    datasets: [{
                        label: 'Conversion Rate (%)',
                        data: [data.trialConversion, data.overallConversion],
                        backgroundColor: ['#00ff88', '#4ecdc4']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: { color: '#e0e0e0' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#888' },
                            grid: { color: 'rgba(136, 136, 136, 0.2)' }
                        },
                        y: {
                            ticks: { 
                                color: '#888',
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            grid: { color: 'rgba(136, 136, 136, 0.2)' }
                        }
                    }
                }
            });
        }

        function createChurnChart(data) {
            const ctx = document.getElementById('churnChart').getContext('2d');
            chartInstances.churnChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.month),
                    datasets: [{
                        label: 'Churn Rate (%)',
                        data: data.map(d => d.churnRate),
                        borderColor: '#ff6b6b',
                        backgroundColor: 'rgba(255, 107, 107, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: { color: '#e0e0e0' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#888' },
                            grid: { color: 'rgba(136, 136, 136, 0.2)' }
                        },
                        y: {
                            ticks: { 
                                color: '#888',
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            grid: { color: 'rgba(136, 136, 136, 0.2)' }
                        }
                    }
                }
            });
        }

        function createForecastChart(data) {
            const ctx = document.getElementById('forecastChart').getContext('2d');
            chartInstances.forecastChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.month),
                    datasets: [{
                        label: 'Projected MRR ($)',
                        data: data.map(d => d.projectedMRR),
                        borderColor: '#f9ca24',
                        backgroundColor: 'rgba(249, 202, 36, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderDash: [5, 5]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: { color: '#e0e0e0' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#888' },
                            grid: { color: 'rgba(136, 136, 136, 0.2)' }
                        },
                        y: {
                            ticks: { 
                                color: '#888',
                                callback: function(value) {
                                    return '$' + value.toFixed(0);
                                }
                            },
                            grid: { color: 'rgba(136, 136, 136, 0.2)' }
                        }
                    }
                }
            });
        }

        async function loadFinancialAlerts() {
            const alerts = [];
            
            // Alert 1: Failed Payments
            const failedPayments = allSubscriptions.filter(sub => 
                sub.payment_status === 'failed' || sub.payment_status === 'pending'
            );
            
            if (failedPayments.length > 0) {
                alerts.push({
                    type: 'danger',
                    icon: 'üí≥',
                    title: 'Pagos Fallidos',
                    message: `${failedPayments.length} suscripciones con problemas de pago`,
                    action: 'Revisar pagos'
                });
            }

            // Alert 2: Expiring Subscriptions
            const now = new Date();
            const next7Days = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
            const expiringSoon = allSubscriptions.filter(sub => {
                const expDate = new Date(sub.expires_at);
                return sub.active && expDate <= next7Days && expDate > now;
            });

            if (expiringSoon.length > 0) {
                alerts.push({
                    type: 'warning',
                    icon: '‚è∞',
                    title: 'Suscripciones por Vencer',
                    message: `${expiringSoon.length} suscripciones vencen en los pr√≥ximos 7 d√≠as`,
                    action: 'Recordatorios de renovaci√≥n'
                });
            }

            // Alert 3: High Churn Risk
            const churnData = prepareChurnData();
            const avgChurn = churnData.reduce((sum, d) => sum + d.churnRate, 0) / churnData.length;
            
            if (avgChurn > 10) {
                alerts.push({
                    type: 'danger',
                    icon: 'üìâ',
                    title: 'Alto Riesgo de Churn',
                    message: `Tasa de churn promedio: ${avgChurn.toFixed(1)}%`,
                    action: 'Estrategias de retenci√≥n'
                });
            }

            // Alert 4: Revenue Milestones
            const currentRevenue = allSubscriptions
                .filter(sub => sub.payment_status === 'paid')
                .reduce((sum, sub) => sum + (parseFloat(sub.amount) || 0), 0);

            const milestones = [1000, 5000, 10000, 25000, 50000];
            const nextMilestone = milestones.find(m => m > currentRevenue);
            
            if (nextMilestone) {
                const remaining = nextMilestone - currentRevenue;
                const progress = (currentRevenue / nextMilestone * 100);
                
                if (progress > 80) {
                    alerts.push({
                        type: 'success',
                        icon: 'üéØ',
                        title: 'Cerca del Objetivo',
                        message: `Faltan $${remaining.toFixed(2)} para llegar a $${nextMilestone}`,
                        action: `${progress.toFixed(1)}% completado`
                    });
                }
            }

            // Render alerts
            if (alerts.length === 0) {
                document.getElementById('financialAlerts').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #00ff88;">
                        <h4>‚úÖ Todo se ve bien</h4>
                        <p>No hay alertas financieras cr√≠ticas en este momento.</p>
                    </div>
                `;
            } else {
                const alertsHtml = alerts.map(alert => `
                    <div style="background: ${alert.type === 'danger' ? 'rgba(255, 68, 68, 0.1)' : 
                                             alert.type === 'warning' ? 'rgba(249, 202, 36, 0.1)' : 
                                             'rgba(0, 255, 136, 0.1)'}; 
                                border-left: 4px solid ${alert.type === 'danger' ? '#ff4444' : 
                                                        alert.type === 'warning' ? '#f9ca24' : 
                                                        '#00ff88'}; 
                                padding: 15px; margin: 10px 0; border-radius: 5px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h5 style="color: #e0e0e0; margin: 0 0 5px 0;">${alert.icon} ${alert.title}</h5>
                                <p style="margin: 0; color: #ccc;">${alert.message}</p>
                            </div>
                            <button class="action-btn ${alert.type === 'danger' ? 'danger' : 'secondary'}" style="margin-left: 15px;">
                                ${alert.action}
                            </button>
                        </div>
                    </div>
                `).join('');

                document.getElementById('financialAlerts').innerHTML = alertsHtml;
            }
        }

        async function loadDetailedFinancials() {
            const period = document.getElementById('financialPeriod').value;
            let filteredSubs = allSubscriptions;
            
            const now = new Date();
            
            switch (period) {
                case 'month':
                    filteredSubs = allSubscriptions.filter(sub => {
                        const subDate = new Date(sub.created_at);
                        return subDate.getMonth() === now.getMonth() && subDate.getFullYear() === now.getFullYear();
                    });
                    break;
                case 'quarter':
                    const quarterStart = new Date(now.getFullYear(), Math.floor(now.getMonth() / 3) * 3, 1);
                    filteredSubs = allSubscriptions.filter(sub => {
                        const subDate = new Date(sub.created_at);
                        return subDate >= quarterStart;
                    });
                    break;
                case 'year':
                    filteredSubs = allSubscriptions.filter(sub => {
                        const subDate = new Date(sub.created_at);
                        return subDate.getFullYear() === now.getFullYear();
                    });
                    break;
            }

            // Estad√≠sticas detalladas
            const stats = {
                totalSubscriptions: filteredSubs.length,
                activeSubscriptions: filteredSubs.filter(sub => sub.active).length,
                paidSubscriptions: filteredSubs.filter(sub => sub.payment_status === 'paid').length,
                failedPayments: filteredSubs.filter(sub => sub.payment_status === 'failed').length,
                totalRevenue: filteredSubs.filter(sub => sub.payment_status === 'paid')
                    .reduce((sum, sub) => sum + (parseFloat(sub.amount) || 0), 0),
                avgOrderValue: 0
            };

            stats.avgOrderValue = stats.paidSubscriptions > 0 ? stats.totalRevenue / stats.paidSubscriptions : 0;

            // Plan breakdown
            const planBreakdown = {};
            filteredSubs.forEach(sub => {
                const plan = sub.plan_type || 'unknown';
                if (!planBreakdown[plan]) {
                    planBreakdown[plan] = { count: 0, revenue: 0 };
                }
                planBreakdown[plan].count++;
                if (sub.payment_status === 'paid') {
                    planBreakdown[plan].revenue += parseFloat(sub.amount) || 0;
                }
            });

            const detailsHtml = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                    <div style="background: #0f0f0f; padding: 20px; border-radius: 8px;">
                        <h4 style="color: #00ff88; margin-bottom: 15px;">üìä Resumen del Per√≠odo</h4>
                        <div style="display: grid; gap: 10px;">
                            <div style="display: flex; justify-content: space-between;">
                                <span>Total Suscripciones:</span>
                                <strong>${stats.totalSubscriptions}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>Activas:</span>
                                <strong style="color: #00ff88;">${stats.activeSubscriptions}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>Pagadas:</span>
                                <strong style="color: #00ff88;">${stats.paidSubscriptions}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>Pagos Fallidos:</span>
                                <strong style="color: #ff4444;">${stats.failedPayments}</strong>
                            </div>
                            <hr style="border-color: #333; margin: 10px 0;">
                            <div style="display: flex; justify-content: space-between;">
                                <span>Ingresos Totales:</span>
                                <strong style="color: #00ff88;">$${stats.totalRevenue.toFixed(2)}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>Valor Promedio:</span>
                                <strong>$${stats.avgOrderValue.toFixed(2)}</strong>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #0f0f0f; padding: 20px; border-radius: 8px;">
                        <h4 style="color: #00ff88; margin-bottom: 15px;">üìã Por Tipo de Plan</h4>
                        <div style="display: grid; gap: 10px;">
                            ${Object.entries(planBreakdown).map(([plan, data]) => `
                                <div style="background: #1a1a1a; padding: 10px; border-radius: 5px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                        <strong style="text-transform: capitalize;">${plan}</strong>
                                        <span>${data.count} suscripciones</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; font-size: 0.9em; color: #888;">
                                        <span>Ingresos:</span>
                                        <span style="color: #00ff88;">$${data.revenue.toFixed(2)}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
                
                <div style="background: #0f0f0f; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h4 style="color: #00ff88; margin-bottom: 15px;">üí° Insights Financieros</h4>
                    <ul style="color: #e0e0e0; list-style: none; padding: 0;">
                        <li style="margin: 8px 0; padding: 8px; background: #1a1a1a; border-radius: 4px;">
                            ‚Ä¢ ${stats.paidSubscriptions > 0 ? '‚úÖ' : '‚ùå'} Tasa de √©xito en pagos: ${((stats.paidSubscriptions / stats.totalSubscriptions) * 100).toFixed(1)}%
                        </li>
                        <li style="margin: 8px 0; padding: 8px; background: #1a1a1a; border-radius: 4px;">
                            ‚Ä¢ ${stats.avgOrderValue > 50 ? 'üìà' : 'üìâ'} Valor promedio por pedido: $${stats.avgOrderValue.toFixed(2)} ${stats.avgOrderValue > 50 ? '(Bueno)' : '(Puede mejorar)'}
                        </li>
                        <li style="margin: 8px 0; padding: 8px; background: #1a1a1a; border-radius: 4px;">
                            ‚Ä¢ ${stats.failedPayments < stats.totalSubscriptions * 0.05 ? '‚úÖ' : '‚ö†Ô∏è'} Tasa de fallos: ${((stats.failedPayments / stats.totalSubscriptions) * 100).toFixed(1)}% ${stats.failedPayments < stats.totalSubscriptions * 0.05 ? '(Excelente)' : '(Revisar)'}
                        </li>
                    </ul>
                </div>
            `;

            document.getElementById('detailedFinancials').innerHTML = detailsHtml;
        }

        function exportFinancialData() {
            const period = document.getElementById('financialPeriod').value;
            const data = allSubscriptions.map(sub => ({
                id: sub.id,
                user_id: sub.user_id,
                plan_type: sub.plan_type,
                amount: sub.amount,
                payment_status: sub.payment_status,
                active: sub.active,
                created_at: sub.created_at,
                expires_at: sub.expires_at
            }));

            const csvContent = "data:text/csv;charset=utf-8," + 
                "ID,User ID,Plan Type,Amount,Payment Status,Active,Created,Expires\n" +
                data.map(row => `${row.id},"${row.user_id}","${row.plan_type}",${row.amount},"${row.payment_status}",${row.active},"${row.created_at}","${row.expires_at}"`).join("\n");

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `financial_data_${period}_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Event listener for period changes
        document.addEventListener('DOMContentLoaded', function() {
            const periodSelect = document.getElementById('financialPeriod');
            if (periodSelect) {
                periodSelect.addEventListener('change', loadDetailedFinancials);
            }
        });

        // Inicializar dashboard con autenticaci√≥n
        async function initSecureDashboard() {
            try {
                console.log('üîê Verificando autenticaci√≥n de administrador...');
                
                // El Auth Guard ya se ejecut√≥, verificar si estamos autenticados
                const adminSession = window.authGuard?.getCurrentAdmin();
                
                if (!adminSession) {
                    console.error('‚ùå No hay sesi√≥n de admin v√°lida');
                    return;
                }
                
                // Crear cliente Supabase con service role SOLO si est√° autenticado
                // Usar SUPABASE_URL del auth-guard.js que ya est√° disponible globalmente
                supabase = window.supabase.createClient(window.SUPABASE_URL, SERVICE_ROLE_KEY);
                isAdminAuthenticated = true;
                
                console.log('‚úÖ Admin autenticado:', adminSession.email);
                console.log('üöÄ Inicializando dashboard seguro...');
                
                // Cargar dashboard solo si est√° autenticado
                loadDashboard();
                
                // Registrar acceso al dashboard
                window.authGuard?.logActivity(
                    adminSession.admin_id, 
                    'ACCESS', 
                    'DASHBOARD', 
                    null,
                    { page: 'simple-real-data-dashboard' }
                );
                
            } catch (error) {
                console.error('‚ùå Error inicializando dashboard seguro:', error);
            }
        }

        // Cargar dashboard al inicializar (despu√©s de auth guard)
        document.addEventListener('DOMContentLoaded', function() {
            // Esperar a que el auth guard termine y verificar m√∫ltiples veces
            let attempts = 0;
            const maxAttempts = 10;
            
            const tryInit = () => {
                attempts++;
                console.log(`üîÑ Intento ${attempts} de inicializaci√≥n del dashboard...`);
                
                const adminSession = window.authGuard?.getCurrentAdmin();
                if (adminSession) {
                    console.log('‚úÖ Sesi√≥n admin encontrada, iniciando dashboard');
                    initSecureDashboard();
                } else if (attempts < maxAttempts) {
                    console.log('‚è≥ Esperando autenticaci√≥n admin...');
                    setTimeout(tryInit, 200);
                } else {
                    console.log('‚ùå Timeout esperando autenticaci√≥n, redirigiendo...');
                    window.location.href = 'login.html';
                }
            };
            
            // Esperar un poco para que auth guard se complete
            setTimeout(tryInit, 100);

            // Cerrar modal al hacer click fuera
            document.getElementById('userEditModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeUserModal();
                }
            });

            // Cerrar modal de piezas al hacer click fuera
            document.getElementById('pieceDetailModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closePieceModal();
                }
            });
        });
    </script>
</body>
</html>