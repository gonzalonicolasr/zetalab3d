<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZETALAB Admin - Dashboard Completo</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #00ff88;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .nav-tabs {
            display: flex;
            background: #1a1a1a;
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 30px;
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            background: transparent;
            border: none;
            color: #888;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            background: #00ff88;
            color: #000;
            font-weight: bold;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #333;
            text-align: center;
        }

        .stat-card h3 {
            color: #00ff88;
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .stat-card p {
            color: #888;
            font-size: 0.9rem;
        }

        .data-table {
            background: #1a1a1a;
            border-radius: 10px;
            border: 2px solid #333;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .data-table h3 {
            color: #00ff88;
            padding: 20px;
            border-bottom: 1px solid #333;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #333;
        }

        th {
            background: #222;
            color: #00ff88;
            font-weight: bold;
        }

        tr:hover {
            background: #222;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .status-active { background: #00ff88; color: #000; }
        .status-trial { background: #ffaa00; color: #000; }
        .status-inactive { background: #ff4444; color: white; }

        .loading {
            text-align: center;
            color: #888;
            padding: 20px;
        }

        .error {
            color: #ff4444;
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid #ff4444;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .action-btn {
            background: #00ff88;
            color: #000;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            margin: 2px;
            transition: all 0.2s ease;
        }

        .action-btn:hover { background: #00dd77; }
        .action-btn.danger { background: #ff4444; color: white; }
        .action-btn.danger:hover { background: #dd3333; }
        .action-btn.secondary { background: #666; color: white; }
        .action-btn.secondary:hover { background: #777; }

        .user-activity {
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            background: #0f0f0f;
            border-radius: 5px;
            margin-top: 10px;
        }

        .activity-item {
            padding: 8px 0;
            border-bottom: 1px solid #333;
            font-size: 0.9em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .activity-item:last-child { border-bottom: none; }
        
        .activity-date { color: #888; font-size: 0.8em; }
        
        .activity-icon { 
            margin-right: 8px; 
            font-size: 1.1em; 
        }
        
        .activity-amount { 
            color: #00ff88; 
            font-weight: bold; 
            margin-left: 8px; 
        }
        
        .activity-negative { 
            color: #ff4444; 
        }
        
        .days-remaining {
            color: #ffaa00;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .days-expired {
            color: #ff4444;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #00ff88;
            font-weight: bold;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            background: #222;
            border: 1px solid #444;
            color: #e0e0e0;
            padding: 8px 12px;
            border-radius: 5px;
        }

        .growth-positive { color: #00ff88; }
        .growth-negative { color: #ff4444; }
        .growth-neutral { color: #ffaa00; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß ZETALAB Admin Dashboard</h1>
            <p>Panel administrativo completo con gesti√≥n de usuarios y m√©tricas avanzadas</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('dashboard')">Dashboard</button>
            <button class="nav-tab" onclick="showTab('users')">Usuarios</button>
            <button class="nav-tab" onclick="showTab('subscriptions')">Suscripciones</button>
            <button class="nav-tab" onclick="showTab('pieces')">Piezas</button>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard" class="section active">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="totalUsers">0</h3>
                    <p>Total Usuarios Registrados</p>
                </div>
                <div class="stat-card">
                    <h3 id="activeUsers">0</h3>
                    <p>Usuarios Activos (30 d√≠as)</p>
                </div>
                <div class="stat-card">
                    <h3 id="verifiedUsers">0</h3>
                    <p>Usuarios Verificados</p>
                </div>
                <div class="stat-card">
                    <h3 id="activeSubscriptions">0</h3>
                    <p>Suscripciones Activas</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalRevenue">$0</h3>
                    <p>Ingresos Totales</p>
                </div>
                <div class="stat-card">
                    <h3 id="monthlyGrowth">+0%</h3>
                    <p>Crecimiento Mensual</p>
                </div>
            </div>

            <div class="data-table">
                <h3>üìà Actividad Reciente</h3>
                <div id="recentActivity" class="loading">Cargando...</div>
            </div>
        </div>

        <!-- Users Section -->
        <div id="users" class="section">
            <div class="data-table">
                <h3>üë• Todos los Usuarios Registrados</h3>
                <div class="table-controls" style="padding: 15px; border-bottom: 1px solid #333;">
                    <input type="text" id="userSearch" placeholder="üîç Buscar por email..." 
                           style="background: #222; border: 1px solid #444; color: #e0e0e0; padding: 8px 12px; border-radius: 5px; width: 300px;">
                    <select id="userFilter" style="background: #222; border: 1px solid #444; color: #e0e0e0; padding: 8px 12px; border-radius: 5px; margin-left: 10px;">
                        <option value="all">Todos los usuarios</option>
                        <option value="verified">Solo verificados</option>
                        <option value="unverified">No verificados</option>
                        <option value="active">Activos (30 d√≠as)</option>
                        <option value="subscribed">Con suscripci√≥n</option>
                    </select>
                </div>
                <div id="usersContent" class="loading">Cargando...</div>
            </div>

            <!-- User Edit Modal -->
            <div id="userEditModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000;">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1a1a1a; padding: 30px; border-radius: 10px; width: 500px; max-width: 90%; border: 2px solid #333;">
                    <h3 style="color: #00ff88; margin-bottom: 20px;">‚úèÔ∏è Editar Usuario</h3>
                    <div id="userEditContent"></div>
                </div>
            </div>
        </div>

        <!-- Subscriptions Section -->
        <div id="subscriptions" class="section">
            <div class="data-table">
                <h3>Suscripciones Reales</h3>
                <div id="subscriptionsContent" class="loading">Cargando...</div>
            </div>
        </div>

        <!-- Pieces Section -->
        <div id="pieces" class="section">
            <!-- Pieces Statistics -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="totalPieces">0</h3>
                    <p>Total Piezas</p>
                </div>
                <div class="stat-card">
                    <h3 id="piecesThisMonth">0</h3>
                    <p>Piezas Este Mes</p>
                </div>
                <div class="stat-card">
                    <h3 id="averagePrice">$0</h3>
                    <p>Precio Promedio</p>
                </div>
                <div class="stat-card">
                    <h3 id="averagePrintTime">0h</h3>
                    <p>Tiempo Impresi√≥n Promedio</p>
                </div>
            </div>

            <div class="data-table">
                <h3>üîß Gesti√≥n de Piezas</h3>
                <div class="table-controls" style="padding: 15px; border-bottom: 1px solid #333;">
                    <input type="text" id="pieceSearch" placeholder="üîç Buscar por t√≠tulo..." 
                           style="background: #222; border: 1px solid #444; color: #e0e0e0; padding: 8px 12px; border-radius: 5px; width: 200px;">
                    <input type="text" id="pieceUserSearch" placeholder="üë§ Buscar por usuario..." 
                           style="background: #222; border: 1px solid #444; color: #e0e0e0; padding: 8px 12px; border-radius: 5px; width: 200px; margin-left: 10px;">
                    <select id="pieceCategoryFilter" style="background: #222; border: 1px solid #444; color: #e0e0e0; padding: 8px 12px; border-radius: 5px; margin-left: 10px;">
                        <option value="all">Todas las categor√≠as</option>
                        <option value="decorativo">Decorativo</option>
                        <option value="funcional">Funcional</option>
                        <option value="prototipo">Prototipo</option>
                        <option value="repuesto">Repuesto</option>
                        <option value="miniatura">Miniatura</option>
                        <option value="herramienta">Herramienta</option>
                        <option value="juguete">Juguete</option>
                        <option value="otro">Otro</option>
                    </select>
                    <input type="date" id="pieceDateFrom" 
                           style="background: #222; border: 1px solid #444; color: #e0e0e0; padding: 8px 12px; border-radius: 5px; margin-left: 10px;" 
                           title="Desde fecha">
                    <input type="date" id="pieceDateTo" 
                           style="background: #222; border: 1px solid #444; color: #e0e0e0; padding: 8px 12px; border-radius: 5px; margin-left: 10px;" 
                           title="Hasta fecha">
                    <button class="action-btn secondary" onclick="clearPieceFilters()" style="margin-left: 10px;">üóëÔ∏è Limpiar</button>
                </div>
                <div id="piecesContent" class="loading">Cargando...</div>
            </div>

            <!-- Piece Detail Modal -->
            <div id="pieceDetailModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000;">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1a1a1a; padding: 30px; border-radius: 10px; width: 800px; max-width: 90%; max-height: 90%; overflow-y: auto; border: 2px solid #333;">
                    <h3 style="color: #00ff88; margin-bottom: 20px;">üîß Detalles de Pieza</h3>
                    <div id="pieceDetailContent"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <!-- Incluir Auth Guard antes del script principal -->
    <script src="auth-guard.js"></script>
    
    <script>
        // Configuraci√≥n segura de Supabase - Sin service role key expuesta
        const SUPABASE_URL = 'https://fwmyiovamcxvinoxnput.supabase.co';
        const SERVICE_ROLE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3bXlpb3ZhbWN4dmlub3hucHV0Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NjE3MDM4OSwiZXhwIjoyMDcxNzQ2Mzg5fQ.DfuFLgbxVNmrhfqXVgCRIoTCsDvUK02qR9wJqzik2PY';

        // Cliente Supabase Admin (protegido por Auth Guard)
        let supabase = null;
        let isAdminAuthenticated = false;

        // Funciones de navegaci√≥n
        function showTab(tabName) {
            // Ocultar todas las secciones
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            
            // Mostrar secci√≥n seleccionada
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            // Cargar datos espec√≠ficos
            if (tabName === 'users') loadUsers();
            if (tabName === 'subscriptions') loadSubscriptions();
            if (tabName === 'pieces') loadPieces();
        }

        // Global variables for data
        let allUsers = [];
        let allSubscriptions = [];
        let allPieces = [];
        let allPieceVersions = [];
        let allPaymentTransactions = [];
        let allConfigProfiles = [];
        let allFilaments = [];
        let allUserUsage = [];

        // Verificar autenticaci√≥n antes de operaciones sensibles
        function checkAdminAuth() {
            if (!isAdminAuthenticated || !supabase) {
                console.error('‚ùå Operaci√≥n bloqueada: Admin no autenticado');
                alert('Error de autenticaci√≥n. Por favor inicia sesi√≥n nuevamente.');
                window.location.href = 'login.html';
                return false;
            }
            return true;
        }

        // Cargar estad√≠sticas del dashboard
        async function loadDashboard() {
            if (!checkAdminAuth()) return;
            try {
                console.log('üìä Cargando estad√≠sticas del dashboard...');

                // Cargar TODOS los usuarios desde auth.users
                const { data: users } = await supabase.auth.admin.listUsers();
                allUsers = users?.users || [];

                // Cargar suscripciones
                const { data: subscriptions } = await supabase
                    .from('subscriptions')
                    .select('*');
                allSubscriptions = subscriptions || [];

                // Cargar piezas para actividad
                const { data: pieces } = await supabase
                    .from('pieces')
                    .select('*')
                    .order('created_at', { ascending: false });
                allPieces = pieces || [];

                // Cargar datos adicionales para actividad expandida
                const { data: pieceVersions } = await supabase
                    .from('piece_versions')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(100);
                allPieceVersions = pieceVersions || [];

                const { data: paymentTransactions } = await supabase
                    .from('payment_transactions')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(100);
                allPaymentTransactions = paymentTransactions || [];

                const { data: configProfiles } = await supabase
                    .from('config_profiles')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(100);
                allConfigProfiles = configProfiles || [];

                const { data: filaments } = await supabase
                    .from('filaments')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(100);
                allFilaments = filaments || [];

                const { data: userUsage } = await supabase
                    .from('user_usage')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(100);
                allUserUsage = userUsage || [];

                // Calcular m√©tricas
                const totalUsers = allUsers.length;
                
                // Usuarios activos (√∫ltimos 30 d√≠as)
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                const activeUsers = allUsers.filter(user => 
                    user.last_sign_in_at && new Date(user.last_sign_in_at) > thirtyDaysAgo
                ).length;

                // Usuarios verificados
                const verifiedUsers = allUsers.filter(user => user.email_confirmed_at).length;

                // Suscripciones activas
                const activeSubs = allSubscriptions.filter(s => {
                    const isActive = s.active === true;
                    const notExpired = !s.expires_at || new Date(s.expires_at) > new Date();
                    return isActive && notExpired;
                }).length;

                // Ingresos totales
                const totalRevenue = allSubscriptions.reduce((sum, s) => {
                    return sum + (parseFloat(s.amount) || 0);
                }, 0);

                // Crecimiento mensual
                const lastMonth = new Date();
                lastMonth.setMonth(lastMonth.getMonth() - 1);
                const usersLastMonth = allUsers.filter(user => 
                    new Date(user.created_at) > lastMonth
                ).length;
                const usersBeforeLastMonth = totalUsers - usersLastMonth;
                const monthlyGrowth = usersBeforeLastMonth > 0 
                    ? ((usersLastMonth / usersBeforeLastMonth) * 100) 
                    : 0;

                // Actualizar UI
                document.getElementById('totalUsers').textContent = totalUsers;
                document.getElementById('activeUsers').textContent = activeUsers;
                document.getElementById('verifiedUsers').textContent = verifiedUsers;
                document.getElementById('activeSubscriptions').textContent = activeSubs;
                document.getElementById('totalRevenue').textContent = `$${totalRevenue.toLocaleString()}`;
                
                const growthEl = document.getElementById('monthlyGrowth');
                growthEl.textContent = `+${monthlyGrowth.toFixed(1)}%`;
                growthEl.className = monthlyGrowth > 0 ? 'growth-positive' : 
                                   monthlyGrowth < 0 ? 'growth-negative' : 'growth-neutral';

                // Cargar actividad reciente
                loadRecentActivity();

                console.log('‚úÖ Dashboard cargado:', { totalUsers, activeUsers, verifiedUsers, activeSubs, totalRevenue, monthlyGrowth });

            } catch (error) {
                console.error('‚ùå Error cargando dashboard:', error);
                document.querySelectorAll('.stat-card h3').forEach(el => el.textContent = 'Error');
            }
        }

        // Cargar actividad reciente expandida
        function loadRecentActivity() {
            const activities = [];

            // Nuevos usuarios
            allUsers.slice(-5).forEach(user => {
                activities.push({
                    type: 'user_register',
                    date: new Date(user.created_at),
                    description: `Nuevo usuario registrado: ${user.email}`,
                    icon: 'üë§'
                });
            });

            // C√°lculos de presupuestos (piece_versions)
            allPieceVersions.slice(-8).forEach(version => {
                const user = allUsers.find(u => u.id === version.user_id);
                const piece = allPieces.find(p => p.id === version.piece_id);
                const total = version.total ? `$${parseFloat(version.total).toLocaleString()}` : 'N/A';
                activities.push({
                    type: 'budget_calculated',
                    date: new Date(version.created_at),
                    description: `Presupuesto calculado: ${total} para "${piece?.title || 'Pieza'}"`,
                    icon: 'üí∞',
                    user: user?.email || 'Usuario desconocido',
                    amount: total
                });
            });

            // Transacciones de pago
            allPaymentTransactions.slice(-5).forEach(transaction => {
                const user = allUsers.find(u => u.id === transaction.user_id);
                const amount = `$${parseFloat(transaction.amount || 0).toLocaleString()}`;
                const statusIcon = transaction.status === 'approved' ? '‚úÖ' : '‚ùå';
                activities.push({
                    type: 'payment',
                    date: new Date(transaction.created_at),
                    description: `Pago ${transaction.status}: ${amount} (MP: ${transaction.mp_payment_id || 'N/A'})`,
                    icon: `üí≥ ${statusIcon}`,
                    user: user?.email || 'Usuario desconocido',
                    amount: amount
                });
            });

            // Perfiles de configuraci√≥n creados
            allConfigProfiles.slice(-5).forEach(config => {
                const user = allUsers.find(u => u.id === config.user_id);
                activities.push({
                    type: 'config_created',
                    date: new Date(config.created_at),
                    description: `Config creada: "${config.name}" (${config.consumo_w}W, $${config.precio_kwh}/kWh)`,
                    icon: '‚öôÔ∏è',
                    user: user?.email || 'Usuario desconocido'
                });
            });

            // Filamentos registrados
            allFilaments.slice(-5).forEach(filament => {
                const user = allUsers.find(u => u.id === filament.user_id);
                const price = `$${parseFloat(filament.price_per_kg_ars || 0).toLocaleString()}/kg`;
                activities.push({
                    type: 'filament_added',
                    date: new Date(filament.created_at),
                    description: `Filamento: ${filament.brand} ${filament.material} ${filament.color_name} (${price})`,
                    icon: 'üßµ',
                    user: user?.email || 'Usuario desconocido'
                });
            });

            // Estad√≠sticas de uso mensual
            allUserUsage.slice(-3).forEach(usage => {
                const user = allUsers.find(u => u.id === usage.user_id);
                activities.push({
                    type: 'monthly_usage',
                    date: new Date(usage.created_at),
                    description: `Uso mensual: ${usage.calculations_used} c√°lculos, ${usage.pieces_created} piezas, ${usage.html_exports} exports`,
                    icon: 'üìä',
                    user: user?.email || 'Usuario desconocido'
                });
            });

            // Nuevas suscripciones
            allSubscriptions.slice(-3).forEach(sub => {
                const user = allUsers.find(u => u.id === sub.user_id);
                activities.push({
                    type: 'subscription',
                    date: new Date(sub.created_at),
                    description: `Suscripci√≥n ${sub.plan_type}: $${parseFloat(sub.amount || 0).toLocaleString()}`,
                    icon: 'üíé',
                    user: user?.email || 'Usuario desconocido',
                    amount: `$${parseFloat(sub.amount || 0).toLocaleString()}`
                });
            });

            // Ordenar por fecha (m√°s recientes primero)
            activities.sort((a, b) => b.date - a.date);

            let html = '';
            activities.slice(0, 25).forEach(activity => {
                html += `
                    <div class="activity-item">
                        <div>
                            <span class="activity-icon">${activity.icon}</span>
                            ${activity.description}
                            ${activity.user ? `<br><small style="color: #888;">por ${activity.user}</small>` : ''}
                        </div>
                        <div style="text-align: right;">
                            ${activity.amount ? `<div class="activity-amount">${activity.amount}</div>` : ''}
                            <div class="activity-date">${activity.date.toLocaleString('es-ES')}</div>
                        </div>
                    </div>
                `;
            });

            document.getElementById('recentActivity').innerHTML = html || '<p>No hay actividad reciente</p>';
        }

        // Cargar TODOS los usuarios
        async function loadUsers() {
            if (!checkAdminAuth()) return;
            try {
                console.log('üë• Cargando todos los usuarios...');
                
                if (allUsers.length === 0) {
                    await loadDashboard(); // Cargar datos si no est√°n disponibles
                }

                displayUsers(allUsers);
                
                // Configurar filtros y b√∫squeda
                setupUserFilters();

                console.log('‚úÖ Usuarios cargados:', allUsers.length);

            } catch (error) {
                console.error('‚ùå Error cargando usuarios:', error);
                document.getElementById('usersContent').innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        // Mostrar usuarios en tabla
        function displayUsers(users) {
            if (!users || users.length === 0) {
                document.getElementById('usersContent').innerHTML = '<p>No hay usuarios registrados</p>';
                return;
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Verificado</th>
                            <th>Registrado</th>
                            <th>√öltimo Acceso</th>
                            <th>Piezas</th>
                            <th>Suscripci√≥n</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            users.forEach(user => {
                // Calcular estad√≠sticas del usuario
                const userPieces = allPieces.filter(p => p.user_id === user.id);
                const userSubscription = allSubscriptions.find(s => s.user_id === user.id && s.active);
                
                const isVerified = user.email_confirmed_at ? 'S√≠' : 'No';
                const verifiedClass = user.email_confirmed_at ? 'status-active' : 'status-inactive';
                
                const registeredDate = new Date(user.created_at).toLocaleDateString('es-ES');
                const lastLogin = user.last_sign_in_at ? new Date(user.last_sign_in_at).toLocaleDateString('es-ES') : 'Nunca';
                
                const subStatus = userSubscription ? userSubscription.plan_type : 'Ninguna';
                const subClass = userSubscription ? 'status-active' : 'status-inactive';

                html += `
                    <tr>
                        <td><strong>${user.email}</strong></td>
                        <td><span class="status-badge ${verifiedClass}">${isVerified}</span></td>
                        <td>${registeredDate}</td>
                        <td>${lastLogin}</td>
                        <td><strong>${userPieces.length}</strong></td>
                        <td><span class="status-badge ${subClass}">${subStatus}</span></td>
                        <td>
                            <button class="action-btn" onclick="editUser('${user.id}')">‚úèÔ∏è Editar</button>
                            <button class="action-btn secondary" onclick="viewUserActivity('${user.id}')">üìä Actividad</button>
                            <button class="action-btn danger" onclick="suspendUser('${user.id}')">‚õî Suspender</button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            document.getElementById('usersContent').innerHTML = html;
        }

        // Configurar filtros y b√∫squeda
        function setupUserFilters() {
            const searchInput = document.getElementById('userSearch');
            const filterSelect = document.getElementById('userFilter');

            searchInput.addEventListener('input', filterUsers);
            filterSelect.addEventListener('change', filterUsers);
        }

        // Filtrar usuarios
        function filterUsers() {
            const searchTerm = document.getElementById('userSearch').value.toLowerCase();
            const filterType = document.getElementById('userFilter').value;

            let filteredUsers = allUsers.filter(user => 
                user.email.toLowerCase().includes(searchTerm)
            );

            switch (filterType) {
                case 'verified':
                    filteredUsers = filteredUsers.filter(user => user.email_confirmed_at);
                    break;
                case 'unverified':
                    filteredUsers = filteredUsers.filter(user => !user.email_confirmed_at);
                    break;
                case 'active':
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    filteredUsers = filteredUsers.filter(user => 
                        user.last_sign_in_at && new Date(user.last_sign_in_at) > thirtyDaysAgo
                    );
                    break;
                case 'subscribed':
                    filteredUsers = filteredUsers.filter(user => 
                        allSubscriptions.some(s => s.user_id === user.id && s.active)
                    );
                    break;
            }

            displayUsers(filteredUsers);
        }

        // Editar usuario
        async function editUser(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;

            const userSubscription = allSubscriptions.find(s => s.user_id === userId && s.active);

            const modalContent = `
                <form id="editUserForm" onsubmit="saveUser(event, '${userId}')">
                    <div class="form-group">
                        <label>Email:</label>
                        <input type="email" name="email" value="${user.email}" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Estado de verificaci√≥n:</label>
                        <select name="emailVerified">
                            <option value="true" ${user.email_confirmed_at ? 'selected' : ''}>Verificado</option>
                            <option value="false" ${!user.email_confirmed_at ? 'selected' : ''}>No verificado</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Tipo de suscripci√≥n:</label>
                        <select name="subscriptionType">
                            <option value="none" ${!userSubscription ? 'selected' : ''}>Sin suscripci√≥n</option>
                            <option value="monthly" ${userSubscription?.plan_type === 'monthly' ? 'selected' : ''}>Mensual</option>
                            <option value="trial" ${userSubscription?.plan_type === 'trial' ? 'selected' : ''}>Trial</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Notas admin:</label>
                        <textarea name="adminNotes" placeholder="Notas internas sobre este usuario..." rows="3">${user.raw_user_meta_data?.admin_notes || ''}</textarea>
                    </div>

                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                        <button type="button" class="action-btn secondary" onclick="closeUserModal()">Cancelar</button>
                        <button type="submit" class="action-btn">üíæ Guardar</button>
                        <button type="button" class="action-btn danger" onclick="resetUserPassword('${userId}')">üîë Reset Password</button>
                    </div>
                </form>
            `;

            document.getElementById('userEditContent').innerHTML = modalContent;
            document.getElementById('userEditModal').style.display = 'block';
        }

        // Cerrar modal
        function closeUserModal() {
            document.getElementById('userEditModal').style.display = 'none';
        }

        // Guardar cambios de usuario
        async function saveUser(event, userId) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            console.log('üíæ Saving user changes for:', userId);
            console.log('üìã Form data:', {
                email: formData.get('email'),
                subscriptionType: formData.get('subscriptionType'),
                emailVerified: formData.get('emailVerified')
            });

            try {
                // Actualizar metadata del usuario
                const updates = {
                    email: formData.get('email'),
                    email_confirm: formData.get('emailVerified') === 'true',
                    user_metadata: {
                        admin_notes: formData.get('adminNotes')
                    }
                };

                await supabase.auth.admin.updateUserById(userId, updates);

                // Actualizar suscripci√≥n si es necesario
                const subscriptionType = formData.get('subscriptionType');
                console.log('üîÑ Processing subscription update:', subscriptionType);
                
                if (subscriptionType !== 'none') {
                    const existingSub = allSubscriptions.find(s => s.user_id === userId && s.active);
                    console.log('üìã Existing subscription found:', existingSub);
                    
                    // Calcular fecha de expiraci√≥n seg√∫n el tipo de suscripci√≥n
                    const now = new Date();
                    let expiresAt = null;
                    let amount = 0;
                    
                    if (subscriptionType === 'monthly') {
                        expiresAt = new Date(now.getTime() + (30 * 24 * 60 * 60 * 1000)); // 30 d√≠as
                        amount = 5000; // $5000 ARS mensuales
                    } else if (subscriptionType === 'trial') {
                        expiresAt = new Date(now.getTime() + (7 * 24 * 60 * 60 * 1000)); // 7 d√≠as
                        amount = 0; // Trial gratuito
                    }
                    
                    const subscriptionData = {
                        plan_type: subscriptionType,
                        expires_at: expiresAt ? expiresAt.toISOString() : null,
                        amount: amount,
                        active: true
                    };
                    
                    console.log('üìä Subscription data to save:', subscriptionData);
                    
                    if (existingSub) {
                        // Actualizar suscripci√≥n existente
                        console.log('üîÑ Updating existing subscription ID:', existingSub.id);
                        const { data, error } = await supabase
                            .from('subscriptions')
                            .update(subscriptionData)
                            .eq('id', existingSub.id);
                            
                        if (error) {
                            console.error('‚ùå Error updating subscription:', error);
                            throw error;
                        }
                        console.log('‚úÖ Subscription updated successfully:', data);
                    } else {
                        // Crear nueva suscripci√≥n
                        console.log('‚ûï Creating new subscription for user:', userId);
                        const insertData = {
                            user_id: userId,
                            ...subscriptionData,
                            payment_status: subscriptionType === 'trial' ? 'free' : 'pending'
                        };
                        console.log('üìä Insert data:', insertData);
                        
                        const { data, error } = await supabase
                            .from('subscriptions')
                            .insert(insertData);
                            
                        if (error) {
                            console.error('‚ùå Error creating subscription:', error);
                            throw error;
                        }
                        console.log('‚úÖ Subscription created successfully:', data);
                    }
                } else {
                    // Desactivar suscripci√≥n existente
                    console.log('‚õî Deactivating existing subscription for user:', userId);
                    const { data, error } = await supabase
                        .from('subscriptions')
                        .update({ active: false })
                        .eq('user_id', userId);
                        
                    if (error) {
                        console.error('‚ùå Error deactivating subscription:', error);
                        throw error;
                    }
                    console.log('‚úÖ Subscription deactivated successfully:', data);
                }

                alert('Usuario actualizado correctamente');
                closeUserModal();
                loadDashboard(); // Recargar datos
                loadUsers(); // Recargar tabla

            } catch (error) {
                console.error('Error actualizando usuario:', error);
                alert('Error actualizando usuario: ' + error.message);
            }
        }

        // Ver actividad expandida del usuario
        function viewUserActivity(userId) {
            const user = allUsers.find(u => u.id === userId);
            const userPieces = allPieces.filter(p => p.user_id === userId);
            const userSubscriptions = allSubscriptions.filter(s => s.user_id === userId);
            const userPieceVersions = allPieceVersions.filter(pv => pv.user_id === userId);
            const userPayments = allPaymentTransactions.filter(pt => pt.user_id === userId);
            const userConfigs = allConfigProfiles.filter(cp => cp.user_id === userId);
            const userFilaments = allFilaments.filter(f => f.user_id === userId);
            const userUsageStats = allUserUsage.filter(uu => uu.user_id === userId);

            const activities = [];

            // Registro del usuario
            activities.push({
                icon: 'üë§',
                description: 'Usuario registrado',
                date: new Date(user.created_at)
            });

            // Verificaci√≥n de email
            if (user.email_confirmed_at) {
                activities.push({
                    icon: '‚úÖ',
                    description: 'Email verificado',
                    date: new Date(user.email_confirmed_at)
                });
            }

            // √öltimo acceso
            if (user.last_sign_in_at) {
                activities.push({
                    icon: 'üîë',
                    description: '√öltimo acceso',
                    date: new Date(user.last_sign_in_at)
                });
            }

            // Suscripciones
            userSubscriptions.forEach(sub => {
                const amount = `$${parseFloat(sub.amount || 0).toLocaleString()}`;
                activities.push({
                    icon: 'üíé',
                    description: `Suscripci√≥n ${sub.plan_type} ${sub.active ? 'activada' : 'desactivada'}`,
                    date: new Date(sub.created_at),
                    amount: amount
                });
            });

            // C√°lculos de presupuestos
            userPieceVersions.forEach(version => {
                const piece = allPieces.find(p => p.id === version.piece_id);
                const total = version.total ? `$${parseFloat(version.total).toLocaleString()}` : 'N/A';
                const mlPrice = version.ml_price ? `(ML: $${parseFloat(version.ml_price).toLocaleString()})` : '';
                activities.push({
                    icon: 'üí∞',
                    description: `Presupuesto calculado para "${piece?.title || 'Pieza'}" ${mlPrice}`,
                    date: new Date(version.created_at),
                    amount: total
                });
            });

            // Pagos realizados
            userPayments.forEach(payment => {
                const amount = `$${parseFloat(payment.amount || 0).toLocaleString()}`;
                const statusIcon = payment.status === 'approved' ? '‚úÖ' : '‚ùå';
                activities.push({
                    icon: `üí≥ ${statusIcon}`,
                    description: `Pago ${payment.status}: ${payment.description || 'Sin descripci√≥n'} (MP ID: ${payment.mp_payment_id || 'N/A'})`,
                    date: new Date(payment.created_at),
                    amount: amount,
                    isNegative: payment.status !== 'approved'
                });
            });

            // Configuraciones creadas
            userConfigs.forEach(config => {
                activities.push({
                    icon: '‚öôÔ∏è',
                    description: `Config creada: "${config.name}" (${config.consumo_w}W, $${config.precio_kwh}/kWh)`,
                    date: new Date(config.created_at)
                });
            });

            // Filamentos registrados
            userFilaments.forEach(filament => {
                const price = `$${parseFloat(filament.price_per_kg_ars || 0).toLocaleString()}/kg`;
                activities.push({
                    icon: 'üßµ',
                    description: `Filamento registrado: ${filament.brand} ${filament.material} ${filament.color_name}`,
                    date: new Date(filament.created_at),
                    amount: price
                });
            });

            // Estad√≠sticas de uso mensual
            userUsageStats.forEach(usage => {
                activities.push({
                    icon: 'üìä',
                    description: `Uso mensual (${usage.month_year}): ${usage.calculations_used} c√°lculos, ${usage.pieces_created} piezas, ${usage.html_exports} exports HTML`,
                    date: new Date(usage.created_at || usage.month_year + '-01')
                });
            });

            // Piezas creadas
            userPieces.forEach(piece => {
                activities.push({
                    icon: 'üîß',
                    description: `Pieza creada: "${piece.title}"`,
                    date: new Date(piece.created_at)
                });
            });

            // Ordenar por fecha descendente
            activities.sort((a, b) => b.date - a.date);

            let activityHtml = `
                <h4>üìä Actividad Completa de ${user.email}</h4>
                <p style="color: #888; margin-bottom: 15px;">
                    Total: ${userPieces.length} piezas | ${userPieceVersions.length} c√°lculos | ${userPayments.length} pagos | ${userFilaments.length} filamentos
                </p>
                <div class="user-activity">
            `;

            activities.forEach(activity => {
                const amountClass = activity.isNegative ? 'activity-negative' : '';
                activityHtml += `
                    <div class="activity-item">
                        <div>
                            <span class="activity-icon">${activity.icon}</span>
                            ${activity.description}
                        </div>
                        <div style="text-align: right;">
                            ${activity.amount ? `<div class="activity-amount ${amountClass}">${activity.amount}</div>` : ''}
                            <div class="activity-date">${activity.date.toLocaleString('es-ES')}</div>
                        </div>
                    </div>
                `;
            });

            activityHtml += '</div>';

            const modalContent = `
                ${activityHtml}
                <div style="text-align: right; margin-top: 20px;">
                    <button class="action-btn secondary" onclick="closeUserModal()">Cerrar</button>
                </div>
            `;

            document.getElementById('userEditContent').innerHTML = modalContent;
            document.getElementById('userEditModal').style.display = 'block';
        }

        // Suspender usuario
        async function suspendUser(userId) {
            if (!confirm('¬øEst√°s seguro de suspender este usuario?')) return;

            try {
                // En Supabase, suspender = desactivar todas las suscripciones
                await supabase
                    .from('subscriptions')
                    .update({ active: false })
                    .eq('user_id', userId);

                alert('Usuario suspendido correctamente');
                loadDashboard();
                loadUsers();

            } catch (error) {
                console.error('Error suspendiendo usuario:', error);
                alert('Error suspendiendo usuario: ' + error.message);
            }
        }

        // Reset password
        async function resetUserPassword(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!confirm(`¬øEnviar email de reset de password a ${user.email}?`)) return;

            try {
                await supabase.auth.resetPasswordForEmail(user.email);
                alert('Email de reset enviado correctamente');
            } catch (error) {
                console.error('Error enviando reset:', error);
                alert('Error enviando email: ' + error.message);
            }
        }

        // Cargar suscripciones mejoradas con detalles del usuario
        async function loadSubscriptions() {
            try {
                console.log('üí≥ Cargando suscripciones mejoradas...');
                
                const { data: subscriptions } = await supabase
                    .from('subscriptions')
                    .select('id, user_id, plan_type, active, amount, expires_at, created_at, payment_status')
                    .order('created_at', { ascending: false });

                if (!subscriptions || subscriptions.length === 0) {
                    document.getElementById('subscriptionsContent').innerHTML = '<p>No hay suscripciones registradas</p>';
                    return;
                }

                let html = `
                    <table>
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>Plan</th>
                                <th>Estado</th>
                                <th>Monto</th>
                                <th>Creada</th>
                                <th>Expira</th>
                                <th>D√≠as Restantes</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                subscriptions.forEach(sub => {
                    const user = allUsers.find(u => u.id === sub.user_id);
                    const userEmail = user ? user.email : 'Usuario no encontrado';
                    
                    const now = new Date();
                    const createdDate = new Date(sub.created_at);
                    const expiry = sub.expires_at ? new Date(sub.expires_at) : null;
                    
                    let status = 'inactive';
                    let statusText = 'Inactiva';
                    let daysRemaining = 'N/A';
                    let daysClass = '';
                    
                    if (sub.active) {
                        if (expiry && expiry > now) {
                            status = 'active';
                            statusText = 'Activa';
                            const timeDiff = expiry.getTime() - now.getTime();
                            const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
                            daysRemaining = daysDiff;
                            daysClass = daysDiff <= 7 ? 'days-expired' : daysDiff <= 30 ? 'days-remaining' : '';
                        } else if (expiry && expiry < now) {
                            status = 'inactive';
                            statusText = 'Expirada';
                            const timeDiff = now.getTime() - expiry.getTime();
                            const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
                            daysRemaining = `-${daysDiff}`;
                            daysClass = 'days-expired';
                        } else {
                            status = 'active';
                            statusText = 'Activa';
                            daysRemaining = '‚àû';
                        }
                    }

                    if (sub.plan_type === 'trial') {
                        status = 'trial';
                        statusText = 'Trial';
                    }

                    html += `
                        <tr>
                            <td><strong>${userEmail}</strong></td>
                            <td>
                                <span style="text-transform: capitalize;">
                                    ${sub.plan_type.replace('_', ' ')}
                                </span>
                            </td>
                            <td><span class="status-badge status-${status}">${statusText}</span></td>
                            <td>$${sub.amount ? parseFloat(sub.amount).toLocaleString() : '0'}</td>
                            <td>${createdDate.toLocaleDateString('es-ES')}</td>
                            <td>${expiry ? expiry.toLocaleDateString('es-ES') : 'Sin vencimiento'}</td>
                            <td>
                                <span class="${daysClass}">
                                    ${daysRemaining === 'N/A' ? 'N/A' : 
                                      daysRemaining === '‚àû' ? '‚àû' : 
                                      daysRemaining > 0 ? `${daysRemaining} d√≠as` : 
                                      `Expir√≥ hace ${Math.abs(daysRemaining)} d√≠as`}
                                </span>
                            </td>
                            <td>
                                <button class="action-btn" onclick="extendSubscription('${sub.id}')">‚è∞ Extender</button>
                                <button class="action-btn secondary" onclick="viewSubscriptionDetails('${sub.id}')">üëÅÔ∏è Ver</button>
                                <button class="action-btn danger" onclick="cancelSubscription('${sub.id}')">‚ùå Cancelar</button>
                            </td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                document.getElementById('subscriptionsContent').innerHTML = html;

                console.log('‚úÖ Suscripciones mejoradas cargadas:', subscriptions.length);

            } catch (error) {
                console.error('‚ùå Error cargando suscripciones:', error);
                document.getElementById('subscriptionsContent').innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        // Extender suscripci√≥n
        async function extendSubscription(subscriptionId) {
            const days = prompt('¬øCu√°ntos d√≠as extender la suscripci√≥n?', '30');
            if (!days || isNaN(days)) return;
            
            try {
                const subscription = allSubscriptions.find(s => s.id == subscriptionId);
                const currentExpiry = subscription.expires_at ? new Date(subscription.expires_at) : new Date();
                const newExpiry = new Date(currentExpiry.getTime() + (parseInt(days) * 24 * 60 * 60 * 1000));
                
                await supabase
                    .from('subscriptions')
                    .update({ 
                        expires_at: newExpiry.toISOString(),
                        active: true
                    })
                    .eq('id', subscriptionId);
                
                alert(`Suscripci√≥n extendida ${days} d√≠as hasta ${newExpiry.toLocaleDateString('es-ES')}`);
                loadDashboard();
                loadSubscriptions();
                
            } catch (error) {
                alert('Error extendiendo suscripci√≥n: ' + error.message);
            }
        }

        // Ver detalles de suscripci√≥n
        function viewSubscriptionDetails(subscriptionId) {
            const subscription = allSubscriptions.find(s => s.id == subscriptionId);
            const user = allUsers.find(u => u.id === subscription.user_id);
            
            const modalContent = `
                <h4>üí≥ Detalles de Suscripci√≥n</h4>
                <div style="background: #0f0f0f; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <p><strong>ID:</strong> ${subscription.id}</p>
                    <p><strong>Usuario:</strong> ${user?.email || 'No encontrado'}</p>
                    <p><strong>Plan:</strong> ${subscription.plan_type}</p>
                    <p><strong>Estado:</strong> ${subscription.active ? 'Activa' : 'Inactiva'}</p>
                    <p><strong>Monto:</strong> $${parseFloat(subscription.amount || 0).toLocaleString()}</p>
                    <p><strong>Creada:</strong> ${new Date(subscription.created_at).toLocaleString('es-ES')}</p>
                    <p><strong>Expira:</strong> ${subscription.expires_at ? new Date(subscription.expires_at).toLocaleString('es-ES') : 'Sin vencimiento'}</p>
                    <p><strong>Estado de pago:</strong> ${subscription.payment_status || 'N/A'}</p>
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button class="action-btn secondary" onclick="closeUserModal()">Cerrar</button>
                </div>
            `;
            
            document.getElementById('userEditContent').innerHTML = modalContent;
            document.getElementById('userEditModal').style.display = 'block';
        }

        // Cancelar suscripci√≥n
        async function cancelSubscription(subscriptionId) {
            if (!confirm('¬øEst√°s seguro de cancelar esta suscripci√≥n?')) return;
            
            try {
                await supabase
                    .from('subscriptions')
                    .update({ active: false })
                    .eq('id', subscriptionId);
                
                alert('Suscripci√≥n cancelada correctamente');
                loadDashboard();
                loadSubscriptions();
                
            } catch (error) {
                alert('Error cancelando suscripci√≥n: ' + error.message);
            }
        }

        // ================ PIECES MANAGEMENT FUNCTIONS ================

        // Cargar piezas
        async function loadPieces() {
            try {
                console.log('üîß Cargando piezas...');
                
                if (allPieces.length === 0 || allUsers.length === 0) {
                    await loadDashboard(); // Cargar datos si no est√°n disponibles
                }

                // Calcular estad√≠sticas de piezas
                loadPiecesStatistics();
                
                // Mostrar tabla de piezas
                displayPieces(allPieces);
                
                // Configurar filtros
                setupPieceFilters();

                console.log('‚úÖ Piezas cargadas:', allPieces.length);

            } catch (error) {
                console.error('‚ùå Error cargando piezas:', error);
                document.getElementById('piecesContent').innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        // Calcular estad√≠sticas de piezas
        function loadPiecesStatistics() {
            const totalPieces = allPieces.length;
            
            // Piezas este mes
            const thisMonth = new Date();
            thisMonth.setDate(1); // Primer d√≠a del mes
            const piecesThisMonth = allPieces.filter(piece => 
                new Date(piece.created_at) >= thisMonth
            ).length;

            // Precio promedio
            const averagePrice = totalPieces > 0 
                ? allPieces.reduce((sum, piece) => sum + (parseFloat(piece.est_price_ars) || 0), 0) / totalPieces
                : 0;

            // Tiempo promedio de impresi√≥n (en minutos)
            const averagePrintTimeMinutes = totalPieces > 0
                ? allPieces.reduce((sum, piece) => sum + (parseInt(piece.est_print_time_min) || 0), 0) / totalPieces
                : 0;

            // Convertir a horas y minutos
            const hours = Math.floor(averagePrintTimeMinutes / 60);
            const minutes = Math.round(averagePrintTimeMinutes % 60);

            // Actualizar UI
            document.getElementById('totalPieces').textContent = totalPieces;
            document.getElementById('piecesThisMonth').textContent = piecesThisMonth;
            document.getElementById('averagePrice').textContent = `$${averagePrice.toLocaleString()}`;
            document.getElementById('averagePrintTime').textContent = `${hours}h ${minutes}m`;
        }

        // Mostrar piezas en tabla
        function displayPieces(pieces) {
            if (!pieces || pieces.length === 0) {
                document.getElementById('piecesContent').innerHTML = '<p>No hay piezas registradas</p>';
                return;
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>T√≠tulo</th>
                            <th>Usuario</th>
                            <th>Categor√≠a</th>
                            <th>Peso (g)</th>
                            <th>Tiempo</th>
                            <th>Precio</th>
                            <th>Creada</th>
                            <th>Versiones</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            pieces.forEach(piece => {
                const user = allUsers.find(u => u.id === piece.user_id);
                const userEmail = user ? user.email : 'Usuario no encontrado';
                
                const pieceVersions = allPieceVersions.filter(pv => pv.piece_id === piece.id);
                const versionsCount = pieceVersions.length;

                const weight = piece.est_weight_grams ? `${piece.est_weight_grams}g` : 'N/A';
                const printTime = piece.est_print_time_min ? `${Math.floor(piece.est_print_time_min / 60)}h ${piece.est_print_time_min % 60}m` : 'N/A';
                const price = piece.est_price_ars ? `$${parseFloat(piece.est_price_ars).toLocaleString()}` : 'N/A';
                const category = piece.category || 'Sin categor√≠a';
                const createdDate = new Date(piece.created_at).toLocaleDateString('es-ES');

                html += `
                    <tr>
                        <td>
                            <strong>${piece.title}</strong>
                            ${piece.image_url ? `<br><small style="color: #00ff88;">üì∑ Con imagen</small>` : ''}
                        </td>
                        <td>${userEmail}</td>
                        <td><span class="status-badge" style="background: #666; color: white;">${category}</span></td>
                        <td>${weight}</td>
                        <td>${printTime}</td>
                        <td><strong>${price}</strong></td>
                        <td>${createdDate}</td>
                        <td><strong>${versionsCount}</strong></td>
                        <td>
                            <button class="action-btn" onclick="viewPieceDetails('${piece.id}')">üëÅÔ∏è Ver</button>
                            <button class="action-btn secondary" onclick="viewPieceVersions('${piece.id}')">üìä Historial</button>
                            <button class="action-btn danger" onclick="deletePiece('${piece.id}')">üóëÔ∏è Eliminar</button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            document.getElementById('piecesContent').innerHTML = html;
        }

        // Configurar filtros de piezas
        function setupPieceFilters() {
            const searchInput = document.getElementById('pieceSearch');
            const userSearchInput = document.getElementById('pieceUserSearch');
            const categoryFilter = document.getElementById('pieceCategoryFilter');
            const dateFromInput = document.getElementById('pieceDateFrom');
            const dateToInput = document.getElementById('pieceDateTo');

            searchInput.addEventListener('input', filterPieces);
            userSearchInput.addEventListener('input', filterPieces);
            categoryFilter.addEventListener('change', filterPieces);
            dateFromInput.addEventListener('change', filterPieces);
            dateToInput.addEventListener('change', filterPieces);
        }

        // Filtrar piezas
        function filterPieces() {
            const searchTerm = document.getElementById('pieceSearch').value.toLowerCase();
            const userSearchTerm = document.getElementById('pieceUserSearch').value.toLowerCase();
            const categoryFilter = document.getElementById('pieceCategoryFilter').value;
            const dateFrom = document.getElementById('pieceDateFrom').value;
            const dateTo = document.getElementById('pieceDateTo').value;

            let filteredPieces = allPieces.filter(piece => {
                // Filtro por t√≠tulo
                if (searchTerm && !piece.title.toLowerCase().includes(searchTerm)) {
                    return false;
                }

                // Filtro por usuario
                if (userSearchTerm) {
                    const user = allUsers.find(u => u.id === piece.user_id);
                    const userEmail = user ? user.email.toLowerCase() : '';
                    if (!userEmail.includes(userSearchTerm)) {
                        return false;
                    }
                }

                // Filtro por categor√≠a
                if (categoryFilter !== 'all' && piece.category !== categoryFilter) {
                    return false;
                }

                // Filtro por fecha
                const pieceDate = new Date(piece.created_at).toISOString().split('T')[0];
                if (dateFrom && pieceDate < dateFrom) {
                    return false;
                }
                if (dateTo && pieceDate > dateTo) {
                    return false;
                }

                return true;
            });

            displayPieces(filteredPieces);
        }

        // Limpiar filtros
        function clearPieceFilters() {
            document.getElementById('pieceSearch').value = '';
            document.getElementById('pieceUserSearch').value = '';
            document.getElementById('pieceCategoryFilter').value = 'all';
            document.getElementById('pieceDateFrom').value = '';
            document.getElementById('pieceDateTo').value = '';
            displayPieces(allPieces);
        }

        // Ver detalles de pieza
        function viewPieceDetails(pieceId) {
            const piece = allPieces.find(p => p.id === pieceId);
            const user = allUsers.find(u => u.id === piece.user_id);
            if (!piece) return;

            const modalContent = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <h4 style="color: #00ff88; margin-bottom: 10px;">üìã Informaci√≥n B√°sica</h4>
                        <div style="background: #0f0f0f; padding: 15px; border-radius: 8px;">
                            <p><strong>ID:</strong> ${piece.id}</p>
                            <p><strong>T√≠tulo:</strong> ${piece.title}</p>
                            <p><strong>Usuario:</strong> ${user?.email || 'No encontrado'}</p>
                            <p><strong>Categor√≠a:</strong> ${piece.category || 'Sin categor√≠a'}</p>
                            <p><strong>Creada:</strong> ${new Date(piece.created_at).toLocaleString('es-ES')}</p>
                            <p><strong>Actualizada:</strong> ${new Date(piece.updated_at).toLocaleString('es-ES')}</p>
                        </div>
                    </div>
                    <div>
                        <h4 style="color: #00ff88; margin-bottom: 10px;">üìä Estimaciones</h4>
                        <div style="background: #0f0f0f; padding: 15px; border-radius: 8px;">
                            <p><strong>Peso estimado:</strong> ${piece.est_weight_grams || 'N/A'} gramos</p>
                            <p><strong>Tiempo impresi√≥n:</strong> ${piece.est_print_time_min ? `${Math.floor(piece.est_print_time_min / 60)}h ${piece.est_print_time_min % 60}m` : 'N/A'}</p>
                            <p><strong>Precio estimado:</strong> ${piece.est_price_ars ? `$${parseFloat(piece.est_price_ars).toLocaleString()}` : 'N/A'}</p>
                            <p><strong>Filamento ID:</strong> ${piece.filament_id || 'No especificado'}</p>
                        </div>
                    </div>
                </div>
                
                ${piece.image_url ? `
                    <h4 style="color: #00ff88; margin-bottom: 10px;">üñºÔ∏è Imagen</h4>
                    <div style="background: #0f0f0f; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
                        <img src="${piece.image_url}" alt="${piece.title}" style="max-width: 300px; max-height: 200px; border-radius: 8px;" onerror="this.style.display='none'; this.nextSibling.style.display='block'">
                        <p style="display: none; color: #888;">Error cargando imagen</p>
                    </div>
                ` : ''}
                
                ${piece.notes ? `
                    <h4 style="color: #00ff88; margin-bottom: 10px;">üìù Notas</h4>
                    <div style="background: #0f0f0f; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <p>${piece.notes}</p>
                    </div>
                ` : ''}

                <div style="text-align: right; margin-top: 20px;">
                    <button class="action-btn secondary" onclick="viewPieceVersions('${piece.id}')">üìä Ver Historial</button>
                    <button class="action-btn danger" onclick="deletePieceConfirm('${piece.id}')" style="margin-left: 10px;">üóëÔ∏è Eliminar</button>
                    <button class="action-btn secondary" onclick="closePieceModal()" style="margin-left: 10px;">Cerrar</button>
                </div>
            `;

            document.getElementById('pieceDetailContent').innerHTML = modalContent;
            document.getElementById('pieceDetailModal').style.display = 'block';
        }

        // Ver versiones de pieza
        function viewPieceVersions(pieceId) {
            const piece = allPieces.find(p => p.id === pieceId);
            const user = allUsers.find(u => u.id === piece.user_id);
            const pieceVersions = allPieceVersions.filter(pv => pv.piece_id === pieceId);

            if (!piece) return;

            let versionsHtml = '';
            if (pieceVersions.length === 0) {
                versionsHtml = '<p>No hay versiones guardadas para esta pieza.</p>';
            } else {
                versionsHtml = `
                    <div style="max-height: 400px; overflow-y: auto;">
                        ${pieceVersions.map((version, index) => {
                            const versionDate = new Date(version.created_at).toLocaleString('es-ES');
                            const total = version.total ? `$${parseFloat(version.total).toLocaleString()}` : 'N/A';
                            const mlPrice = version.ml_price ? `$${parseFloat(version.ml_price).toLocaleString()}` : 'N/A';
                            
                            // Parsear par√°metros si existen
                            let paramsHtml = '';
                            if (version.params) {
                                try {
                                    const params = typeof version.params === 'string' ? JSON.parse(version.params) : version.params;
                                    paramsHtml = `
                                        <div style="margin-top: 10px; font-size: 0.9em; color: #888;">
                                            <strong>Par√°metros:</strong> 
                                            Filamento: ${params.gramos || 'N/A'}g, 
                                            Tiempo: ${params.tiempo_h || 0}h ${params.tiempo_min || 0}m,
                                            Energ√≠a: ${params.energia_kwh || 'N/A'} kWh
                                        </div>
                                    `;
                                } catch (e) {
                                    paramsHtml = '<div style="margin-top: 10px; font-size: 0.9em; color: #888;">Par√°metros no disponibles</div>';
                                }
                            }

                            return `
                                <div style="background: #0f0f0f; padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #333;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <strong>Versi√≥n #${pieceVersions.length - index}</strong>
                                            <small style="color: #888; margin-left: 10px;">${versionDate}</small>
                                        </div>
                                        <div style="text-align: right;">
                                            <div><strong>Total: ${total}</strong></div>
                                            <div style="color: #888; font-size: 0.9em;">ML: ${mlPrice}</div>
                                        </div>
                                    </div>
                                    ${paramsHtml}
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }

            const modalContent = `
                <h4 style="color: #00ff88; margin-bottom: 15px;">üìä Historial de C√°lculos - "${piece.title}"</h4>
                <p style="color: #888; margin-bottom: 20px;">
                    Usuario: ${user?.email || 'No encontrado'} | Total de versiones: ${pieceVersions.length}
                </p>
                ${versionsHtml}
                <div style="text-align: right; margin-top: 20px;">
                    <button class="action-btn secondary" onclick="closePieceModal()">Cerrar</button>
                </div>
            `;

            document.getElementById('pieceDetailContent').innerHTML = modalContent;
            document.getElementById('pieceDetailModal').style.display = 'block';
        }

        // Eliminar pieza (con confirmaci√≥n)
        function deletePieceConfirm(pieceId) {
            const piece = allPieces.find(p => p.id === pieceId);
            if (!confirm(`¬øEst√°s seguro de eliminar la pieza "${piece.title}"? Esta acci√≥n eliminar√° tambi√©n todas sus versiones y no se puede deshacer.`)) return;
            
            deletePiece(pieceId);
        }

        // Eliminar pieza
        async function deletePiece(pieceId) {
            if (!checkAdminAuth()) return;
            try {
                // Registrar actividad de eliminaci√≥n
                const adminSession = window.authGuard?.getCurrentAdmin();
                if (adminSession) {
                    window.authGuard?.logActivity(
                        adminSession.admin_id,
                        'DELETE',
                        'PIECE',
                        pieceId,
                        { action: 'delete_piece_with_versions' }
                    );
                }
                // Eliminar versiones primero
                await supabase
                    .from('piece_versions')
                    .delete()
                    .eq('piece_id', pieceId);

                // Eliminar pieza
                await supabase
                    .from('pieces')
                    .delete()
                    .eq('id', pieceId);

                alert('Pieza eliminada correctamente');
                closePieceModal();
                loadDashboard(); // Recargar datos
                loadPieces(); // Recargar tabla

            } catch (error) {
                console.error('Error eliminando pieza:', error);
                alert('Error eliminando pieza: ' + error.message);
            }
        }

        // Cerrar modal de pieza
        function closePieceModal() {
            document.getElementById('pieceDetailModal').style.display = 'none';
        }

        // Inicializar dashboard con autenticaci√≥n
        async function initSecureDashboard() {
            try {
                console.log('üîê Verificando autenticaci√≥n de administrador...');
                
                // El Auth Guard ya se ejecut√≥, verificar si estamos autenticados
                const adminSession = window.authGuard?.getCurrentAdmin();
                
                if (!adminSession) {
                    console.error('‚ùå No hay sesi√≥n de admin v√°lida');
                    return;
                }
                
                // Crear cliente Supabase con service role SOLO si est√° autenticado
                supabase = window.supabase.createClient(SUPABASE_URL, SERVICE_ROLE_KEY);
                isAdminAuthenticated = true;
                
                console.log('‚úÖ Admin autenticado:', adminSession.email);
                console.log('üöÄ Inicializando dashboard seguro...');
                
                // Cargar dashboard solo si est√° autenticado
                loadDashboard();
                
                // Registrar acceso al dashboard
                window.authGuard?.logActivity(
                    adminSession.admin_id, 
                    'ACCESS', 
                    'DASHBOARD', 
                    null,
                    { page: 'simple-real-data-dashboard' }
                );
                
            } catch (error) {
                console.error('‚ùå Error inicializando dashboard seguro:', error);
            }
        }

        // Cargar dashboard al inicializar (despu√©s de auth guard)
        document.addEventListener('DOMContentLoaded', function() {
            // Esperar a que el auth guard termine
            setTimeout(initSecureDashboard, 100);

            // Cerrar modal al hacer click fuera
            document.getElementById('userEditModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeUserModal();
                }
            });

            // Cerrar modal de piezas al hacer click fuera
            document.getElementById('pieceDetailModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closePieceModal();
                }
            });
        });
    </script>
</body>
</html>