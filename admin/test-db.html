<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Database Schema - ZETALAB Admin</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1e3a2e;
            color: #b9c7bf;
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: #2a4a3a;
            padding: 20px;
            border-radius: 8px;
        }
        h1 { color: #4f9a65; text-align: center; }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: #1e3a2e;
            border-radius: 5px;
            border: 1px solid #4f9a65;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .success { background: #065f46; color: #a7f3d0; }
        .error { background: #7f1d1d; color: #fecaca; }
        .info { background: #1e3a8a; color: #bfdbfe; }
        button {
            background: #4f9a65;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #10b981; }
        pre {
            background: #111827;
            color: #e5e7eb;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            max-height: 300px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Database Schema Test</h1>
        
        <div class="test-section">
            <h3>Test 1: Check Main Tables</h3>
            <button onclick="testMainTables()">Test Tables</button>
            <div id="tablesResult"></div>
        </div>

        <div class="test-section">
            <h3>Test 2: Check Pieces Data</h3>
            <button onclick="testPieces()">Test Pieces</button>
            <div id="piecesResult"></div>
        </div>

        <div class="test-section">
            <h3>Test 3: Check Subscriptions</h3>
            <button onclick="testSubscriptions()">Test Subscriptions</button>
            <div id="subscriptionsResult"></div>
        </div>

        <div class="test-section">
            <h3>Test 4: Check Piece Versions</h3>
            <button onclick="testVersions()">Test Versions</button>
            <div id="versionsResult"></div>
        </div>

        <div class="test-section">
            <h3>Test 5: Test All Queries</h3>
            <button onclick="runAllTests()">Run All Tests</button>
            <div id="allTestsResult"></div>
        </div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        // Supabase configuration
        const SUPABASE_URL = "https://fwmyiovamcxvinoxnput.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3bXlpb3ZhbWN4dmlub3hucHV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxNzAzODksImV4cCI6MjA3MTc0NjM4OX0.x94-SZj7-BR9CGMzeujkjyk_7iItajoHKkGRgIYPUTc";
        
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="result ${type}">${message}</div>`;
        }

        async function testMainTables() {
            try {
                showResult('tablesResult', 'Testing main tables...', 'info');
                
                const tables = ['pieces', 'subscriptions', 'piece_versions', 'payment_transactions'];
                let results = [];
                
                for (const table of tables) {
                    try {
                        const { count, error } = await supabase
                            .from(table)
                            .select('*', { count: 'exact', head: true });
                        
                        if (error) {
                            results.push(`‚ùå ${table}: ${error.message}`);
                        } else {
                            results.push(`‚úÖ ${table}: ${count} records`);
                        }
                    } catch (err) {
                        results.push(`‚ùå ${table}: ${err.message}`);
                    }
                }
                
                showResult('tablesResult', results.join('<br>'), 'success');
            } catch (error) {
                showResult('tablesResult', `Error: ${error.message}`, 'error');
            }
        }

        async function testPieces() {
            try {
                showResult('piecesResult', 'Testing pieces queries...', 'info');
                
                // Test basic pieces query
                const { data: pieces, error: piecesError } = await supabase
                    .from('pieces')
                    .select('user_id, created_at, title, est_price_ars')
                    .not('user_id', 'is', null)
                    .limit(5);

                if (piecesError) {
                    throw piecesError;
                }

                // Get unique users
                const uniqueUsers = new Set((pieces || []).map(p => p.user_id));
                
                let result = `
                    ‚úÖ Pieces query successful<br>
                    üìä Total pieces retrieved: ${pieces?.length || 0}<br>
                    üë• Unique users: ${uniqueUsers.size}<br>
                    üìã Sample data:<br>
                    <pre>${JSON.stringify(pieces?.slice(0, 2), null, 2)}</pre>
                `;
                
                showResult('piecesResult', result, 'success');
            } catch (error) {
                showResult('piecesResult', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function testSubscriptions() {
            try {
                showResult('subscriptionsResult', 'Testing subscriptions queries...', 'info');
                
                const { data: subs, error } = await supabase
                    .from('subscriptions')
                    .select('id, user_id, plan_type, active, expires_at, created_at, amount')
                    .limit(5);

                if (error) {
                    throw error;
                }

                const now = new Date();
                const activeSubs = (subs || []).filter(s => s.active && (!s.expires_at || new Date(s.expires_at) > now));
                
                let result = `
                    ‚úÖ Subscriptions query successful<br>
                    üìä Total subscriptions: ${subs?.length || 0}<br>
                    üü¢ Active subscriptions: ${activeSubs.length}<br>
                    üìã Sample data:<br>
                    <pre>${JSON.stringify(subs?.slice(0, 2), null, 2)}</pre>
                `;
                
                showResult('subscriptionsResult', result, 'success');
            } catch (error) {
                showResult('subscriptionsResult', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function testVersions() {
            try {
                showResult('versionsResult', 'Testing piece_versions queries...', 'info');
                
                const { count, error } = await supabase
                    .from('piece_versions')
                    .select('*', { count: 'exact', head: true });

                if (error) {
                    throw error;
                }

                // Test a sample query with data
                const { data: versions, error: dataError } = await supabase
                    .from('piece_versions')
                    .select('created_at, total, ml_price')
                    .order('created_at', { ascending: false })
                    .limit(3);

                if (dataError) {
                    throw dataError;
                }
                
                let result = `
                    ‚úÖ Piece versions query successful<br>
                    üìä Total versions: ${count || 0}<br>
                    üìã Recent versions:<br>
                    <pre>${JSON.stringify(versions, null, 2)}</pre>
                `;
                
                showResult('versionsResult', result, 'success');
            } catch (error) {
                showResult('versionsResult', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function runAllTests() {
            showResult('allTestsResult', 'Running comprehensive admin dashboard tests...', 'info');
            
            try {
                let results = [];
                
                // Test 1: User count from pieces
                const { data: pieceUsers } = await supabase
                    .from('pieces')
                    .select('user_id, created_at')
                    .not('user_id', 'is', null);

                const uniqueUsers = new Set((pieceUsers || []).map(p => p.user_id));
                results.push(`üë• Total users (from pieces): ${uniqueUsers.size}`);

                // Test 2: Subscription stats  
                const { data: subs } = await supabase
                    .from('subscriptions')
                    .select('id, user_id, plan_type, active, expires_at');

                const now = new Date();
                const activeSubs = (subs || []).filter(s => s.active && (!s.expires_at || new Date(s.expires_at) > now));
                results.push(`üí≥ Active subscriptions: ${activeSubs.length}`);

                // Test 3: Pieces stats
                const { count: totalPieces } = await supabase
                    .from('pieces')
                    .select('*', { count: 'exact', head: true });

                results.push(`üîß Total pieces: ${totalPieces || 0}`);

                // Test 4: Versions stats
                const { count: totalVersions } = await supabase
                    .from('piece_versions')
                    .select('*', { count: 'exact', head: true });

                results.push(`üìä Total calculations: ${totalVersions || 0}`);

                // Test 5: Recent activity
                const { data: recentPieces } = await supabase
                    .from('pieces')
                    .select('title, created_at, user_id')
                    .order('created_at', { ascending: false })
                    .limit(3);

                results.push(`üìù Recent pieces: ${(recentPieces || []).length} found`);

                // Test 6: Payment transactions
                try {
                    const { count: paymentCount } = await supabase
                        .from('payment_transactions')
                        .select('*', { count: 'exact', head: true });
                    
                    results.push(`üí∞ Payment transactions: ${paymentCount || 0}`);
                } catch (err) {
                    results.push(`‚ö†Ô∏è Payment transactions: Table not found or empty`);
                }

                const finalResult = `
                    <h4>üéâ All Tests Completed Successfully!</h4>
                    ${results.map(r => `<div>‚úÖ ${r}</div>`).join('')}
                    <br>
                    <div class="success">
                        üöÄ The admin dashboard should now work with real data!<br>
                        üîó <a href="index.html" style="color: #a7f3d0;">Open Admin Dashboard</a>
                    </div>
                `;

                showResult('allTestsResult', finalResult, 'success');
                
            } catch (error) {
                showResult('allTestsResult', `‚ùå Error in comprehensive test: ${error.message}`, 'error');
            }
        }

        // Auto-run basic test on page load
        window.onload = () => {
            testMainTables();
        };
    </script>
</body>
</html>