<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Refresh Schema Cache - ZETALAB</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .container {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #0056b3;
        }
        .success {
            color: #28a745;
            background: #1a2a1a;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            border-left: 4px solid #28a745;
        }
        .error {
            color: #dc3545;
            background: #2a1a1a;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            border-left: 4px solid #dc3545;
        }
        pre {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ Refrescar Schema Cache</h1>
        <p>Esta herramienta solucionar√° el problema de "consumo_w column not found" refrescando el cache del esquema de Supabase.</p>
    </div>

    <div class="container">
        <h3>Pasos autom√°ticos:</h3>
        <button onclick="runSchemaRefresh()">üîÑ Refrescar Schema Completo</button>
        <button onclick="testColumns()">üîç Verificar Columnas</button>
        <button onclick="testInsert()">üìù Probar Inserci√≥n</button>
        <button onclick="forceReconnect()">üîå Reconectar Supabase</button>
        
        <div id="results"></div>
    </div>

    <div class="container">
        <h3>SQL Manual (si lo autom√°tico no funciona):</h3>
        <p>Ejecuta estas queries una por una en Supabase SQL Editor:</p>
        <pre id="manual-sql"></pre>
        <button onclick="copySQL()">üìã Copiar SQL</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Configuraci√≥n de Supabase
        const SUPABASE_URL = 'https://fwmyiovamcxvinoxnput.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3bXlpb3ZhbWN4dmlub3hucHV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzI2NDI4NDQsImV4cCI6MjA0ODIxODg0NH0.YMqiAhCBJOeVKCTMYZEP-Cz3gWvNuWokkFQBE9Dx0Ak';
        
        let supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const manualSQL = \`-- 1. Verificar columnas existentes
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_schema = 'public' AND table_name = 'config_profiles';

-- 2. Agregar columnas faltantes
ALTER TABLE public.config_profiles ADD COLUMN IF NOT EXISTS consumo_w DECIMAL(10,2) DEFAULT 0;
ALTER TABLE public.config_profiles ADD COLUMN IF NOT EXISTS precio_kg DECIMAL(10,4) DEFAULT 0;
ALTER TABLE public.config_profiles ADD COLUMN IF NOT EXISTS precio_kwh DECIMAL(10,6) DEFAULT 0;
ALTER TABLE public.config_profiles ADD COLUMN IF NOT EXISTS horas_desgaste INTEGER DEFAULT 1;
ALTER TABLE public.config_profiles ADD COLUMN IF NOT EXISTS precio_repuestos DECIMAL(10,2) DEFAULT 0;
ALTER TABLE public.config_profiles ADD COLUMN IF NOT EXISTS margen_error DECIMAL(10,2) DEFAULT 0;
ALTER TABLE public.config_profiles ADD COLUMN IF NOT EXISTS multiplicador DECIMAL(10,2) DEFAULT 1;
ALTER TABLE public.config_profiles ADD COLUMN IF NOT EXISTS ml_fee DECIMAL(10,2) DEFAULT 0;

-- 3. Refrescar schema cache
SELECT pg_notify('pgrst', 'reload schema');\`;

        document.getElementById('manual-sql').textContent = manualSQL;

        async function runSchemaRefresh() {
            const results = document.getElementById('results');
            results.innerHTML = '<div class="success">üîÑ Iniciando refresh completo...</div>';

            try {
                // Paso 1: Verificar autenticaci√≥n
                const { data: { user }, error: authError } = await supa.auth.getUser();
                if (authError || !user) {
                    throw new Error('Usuario no autenticado');
                }

                // Paso 2: Forzar reconexi√≥n
                supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                    db: { schema: 'public' },
                    auth: { persistSession: true }
                });

                // Paso 3: Probar acceso a la tabla
                results.innerHTML += '<div class="success">üìä Verificando tabla...</div>';
                const { data: tableCheck, error: tableError } = await supa
                    .from('config_profiles')
                    .select('id')
                    .limit(1);

                if (tableError) {
                    throw new Error(\`Error de tabla: \${tableError.message}\`);
                }

                // Paso 4: Probar inserci√≥n con todas las columnas
                results.innerHTML += '<div class="success">üìù Probando inserci√≥n completa...</div>';
                const testData = {
                    user_id: user.id,
                    name: 'Schema Test - ' + Date.now(),
                    precio_kg: 25.50,
                    precio_kwh: 0.08,
                    consumo_w: 120,
                    horas_desgaste: 1000,
                    precio_repuestos: 30,
                    margen_error: 10,
                    multiplicador: 2.0,
                    ml_fee: 15
                };

                const { data: inserted, error: insertError } = await supa
                    .from('config_profiles')
                    .insert(testData)
                    .select()
                    .single();

                if (insertError) {
                    throw new Error(\`Error de inserci√≥n: \${insertError.message}\`);
                }

                // Paso 5: Eliminar registro de prueba
                await supa
                    .from('config_profiles')
                    .delete()
                    .eq('id', inserted.id);

                results.innerHTML += \`
                    <div class="success">
                        ‚úÖ <strong>¬°Schema refresh completado exitosamente!</strong><br>
                        ‚Ä¢ Tabla verificada<br>
                        ‚Ä¢ Todas las columnas funcionan<br>
                        ‚Ä¢ Cache actualizado<br><br>
                        <strong>Pr√≥ximo paso:</strong> Recarga tu aplicaci√≥n principal.
                    </div>
                \`;

                // Actualizar window.supa global si existe
                if (window.supa) {
                    window.supa = supa;
                }

            } catch (error) {
                results.innerHTML += \`
                    <div class="error">
                        ‚ùå <strong>Error durante el refresh:</strong><br>
                        \${error.message}<br><br>
                        <strong>Soluci√≥n:</strong> Ejecuta el SQL manual mostrado abajo.
                    </div>
                \`;
            }
        }

        async function testColumns() {
            const results = document.getElementById('results');
            
            try {
                // Usar RPC para consultar information_schema
                const { data, error } = await supa.rpc('exec_sql', {
                    query: \`
                        SELECT column_name, data_type, is_nullable, column_default
                        FROM information_schema.columns 
                        WHERE table_schema = 'public' AND table_name = 'config_profiles'
                        ORDER BY ordinal_position
                    \`
                });

                if (error) throw error;

                results.innerHTML = \`
                    <div class="success">
                        üìä <strong>Columnas en config_profiles:</strong>
                        <pre>\${JSON.stringify(data, null, 2)}</pre>
                    </div>
                \`;
            } catch (error) {
                results.innerHTML = \`
                    <div class="error">
                        ‚ùå No se pudo verificar columnas: \${error.message}<br>
                        Usa el SQL manual para verificar.
                    </div>
                \`;
            }
        }

        async function testInsert() {
            const results = document.getElementById('results');
            
            try {
                const { data: { user } } = await supa.auth.getUser();
                if (!user) throw new Error('No autenticado');

                const testData = {
                    user_id: user.id,
                    name: 'Test Insert - ' + Date.now(),
                    consumo_w: 150 // Campo que causaba problemas
                };

                const { data, error } = await supa
                    .from('config_profiles')
                    .insert(testData)
                    .select();

                if (error) throw error;

                // Limpiar despu√©s del test
                await supa.from('config_profiles').delete().eq('id', data[0].id);

                results.innerHTML = \`
                    <div class="success">
                        ‚úÖ <strong>Test de inserci√≥n exitoso!</strong><br>
                        La columna consumo_w funciona correctamente.
                    </div>
                \`;
            } catch (error) {
                results.innerHTML = \`
                    <div class="error">
                        ‚ùå <strong>Test de inserci√≥n fall√≥:</strong><br>
                        \${error.message}
                    </div>
                \`;
            }
        }

        async function forceReconnect() {
            const results = document.getElementById('results');
            
            try {
                // Crear nueva instancia de Supabase client
                supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                    auth: { persistSession: true }
                });

                // Test de conexi√≥n
                const { data, error } = await supa.from('config_profiles').select('count').limit(1);
                
                results.innerHTML = \`
                    <div class="success">
                        üîå <strong>Reconexi√≥n exitosa!</strong><br>
                        Nueva instancia de cliente creada.
                    </div>
                \`;
            } catch (error) {
                results.innerHTML = \`
                    <div class="error">
                        ‚ùå Error en reconexi√≥n: \${error.message}
                    </div>
                \`;
            }
        }

        function copySQL() {
            navigator.clipboard.writeText(manualSQL).then(() => {
                alert('‚úÖ SQL copiado al clipboard');
            }).catch(() => {
                alert('‚ùå Error copiando SQL');
            });
        }

        // Auto-verificar al cargar
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('results').innerHTML = '<div class="success">üìã Herramienta lista. Hace clic en "Refrescar Schema Completo" para comenzar.</div>';
        });
    </script>
</body>
</html>