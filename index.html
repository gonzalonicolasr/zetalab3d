<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ZETALAB • Ingresar</title>
  <style>
    :root{
      --bg:#0e1b17; --panel:#13251f; --panel2:#1a2f26;
      --text:#e8efe9; --muted:#b9c7bf; --border:#385f4d;
      --accent:#4f9a65; --accent-text:#ffffff;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
    main{max-width:420px;margin:40px auto;padding:20px}
    h1{margin:0 0 14px}
    .card{
      background:linear-gradient(145deg, var(--panel), var(--panel2));
      border:1px solid var(--border);
      border-radius:12px;
      padding:18px;
      box-shadow: 0 10px 30px rgba(0,0,0,.4), 0 0 15px rgba(79,154,101,.1);
      animation: cardSlideUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    .card::before{
      content:'';position:absolute;top:0;left:0;right:0;height:2px;
      background:linear-gradient(90deg,transparent,#4f9a65,#10b981,#4f9a65,transparent);
      opacity:0.8;
    }
    .tabs{display:flex;gap:8px;margin-bottom:12px}
    .tab{
      flex:1;padding:10px;border-radius:10px;border:1px solid var(--border);
      text-align:center;cursor:pointer;background:var(--panel2);
      transition:all 0.3s cubic-bezier(0.4,0,0.2,1);position:relative;overflow:hidden;
    }
    .tab:hover{transform:translateY(-1px);background:var(--panel)}
    .tab.active{
      background:var(--accent);color:var(--accent-text);border-color:var(--accent);
      box-shadow:0 4px 12px rgba(79,154,101,0.3);
    }
    label{display:block;margin-top:10px;transition:color 0.2s ease;cursor:pointer}
    label:hover{color:var(--accent)}
    input{
      width:100%;padding:10px;margin-top:6px;background:var(--panel2);
      border:1px solid var(--border);border-radius:10px;color:var(--text);
      transition:all 0.3s cubic-bezier(0.4,0,0.2,1);
    }
    input:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 3px rgba(79,154,101,0.3);
      background:var(--panel);
      transform:translateY(-1px) scale(1.01);
    }
    button{
      margin-top:14px;width:100%;padding:12px;border-radius:10px;
      border:1px solid var(--accent);background:linear-gradient(135deg,var(--accent),#10b981);
      color:var(--accent-text);font-weight:700;cursor:pointer;
      transition:all 0.3s cubic-bezier(0.4,0,0.2,1);position:relative;overflow:hidden;
    }
    button::before{
      content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;
      background:linear-gradient(90deg,transparent,rgba(255,255,255,0.3),transparent);
      transition:left 0.5s ease;
    }
    button:hover::before{left:100%}
    button:hover{
      transform:translateY(-2px) scale(1.02);
      box-shadow:0 8px 24px rgba(79,154,101,0.4);
    }
    button:active{transform:translateY(0) scale(0.98)}
    @keyframes cardSlideUp{
      0%{opacity:0;transform:translateY(40px) scale(0.95)}
      60%{opacity:0.8;transform:translateY(-5px) scale(1.01)}
      100%{opacity:1;transform:translateY(0) scale(1)}
    }
    .muted{color:var(--muted);font-size:.9rem}
    .row{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:8px}
    .link{color:var(--text);text-decoration:underline;cursor:pointer}
    .msg{margin-top:10px;min-height:20px}
    .center{text-align:center}
    /* Social login buttons styling */
    .social-section{
      margin:16px 0;position:relative;
    }
    .divider{
      display:flex;align-items:center;margin:14px 0;color:var(--muted);font-size:.85rem;
    }
    .divider::before,.divider::after{
      content:'';flex:1;height:1px;background:var(--border);
    }
    .divider span{margin:0 12px}
    .social-buttons{display:flex;gap:8px}
    .social-btn{
      flex:1;display:flex;align-items:center;justify-content:center;gap:8px;
      padding:10px;border-radius:10px;border:1px solid var(--border);
      background:var(--panel2);color:var(--text);text-decoration:none;
      cursor:pointer;transition:all 0.3s var(--ease-in-out);font-size:.9rem;
    }
    .social-btn:hover{
      background:var(--panel);border-color:var(--accent);transform:translateY(-1px);
      box-shadow:0 4px 12px rgba(79,154,101,0.2);
    }
    .social-btn:active{transform:translateY(0) scale(0.98)}
    .social-btn svg{width:18px;height:18px;flex-shrink:0}
    .google-btn:hover{border-color:#4285f4}
    .facebook-btn:hover{border-color:#1877f2}

    /* Admin Dashboard Styles */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .admin-section {
      display: none;
    }

    .admin-section.active {
      display: block;
    }

    .nav-tabs {
      display: flex;
      background: #1a1a1a;
      border-radius: 10px;
      padding: 5px;
      margin-bottom: 30px;
    }

    .nav-tab {
      flex: 1;
      padding: 15px 20px;
      text-align: center;
      background: transparent;
      border: none;
      color: #888;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .nav-tab.active {
      background: #4f9a65;
      color: #000;
      font-weight: bold;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: #1a2f26;
      padding: 20px;
      border-radius: 10px;
      border: 2px solid #385f4d;
      text-align: center;
    }

    .stat-card h3 {
      color: #4f9a65;
      font-size: 2rem;
      margin-bottom: 5px;
    }

    .stat-card p {
      color: #b9c7bf;
      font-size: 0.9rem;
    }

    .data-table {
      background: #1a2f26;
      border-radius: 10px;
      border: 2px solid #385f4d;
      overflow: hidden;
      margin-bottom: 20px;
    }

    .data-table h3 {
      color: #4f9a65;
      padding: 20px;
      border-bottom: 1px solid #385f4d;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #385f4d;
    }

    th {
      background: #13251f;
      color: #4f9a65;
      font-weight: bold;
    }

    tr:hover {
      background: #13251f;
    }

    .status-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.8em;
      font-weight: bold;
    }

    .status-active { background: #4f9a65; color: #000; }
    .status-trial { background: #ffaa00; color: #000; }
    .status-inactive { background: #ff4444; color: white; }

    .loading {
      text-align: center;
      color: #b9c7bf;
      padding: 20px;
    }

    .error {
      color: #ff4444;
      background: rgba(255, 68, 68, 0.1);
      border: 1px solid #ff4444;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
    }

    .action-btn {
      background: #4f9a65;
      color: #000;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8em;
      margin: 2px;
      transition: all 0.2s ease;
    }

    .action-btn:hover { background: #3d7a52; }
    .action-btn.danger { background: #ff4444; color: white; }
    .action-btn.danger:hover { background: #dd3333; }
    .action-btn.secondary { background: #666; color: white; }
    .action-btn.secondary:hover { background: #777; }

    .user-activity {
      max-height: 400px;
      overflow-y: auto;
      padding: 10px;
      background: #0e1b17;
      border-radius: 5px;
      margin-top: 10px;
    }

    .activity-item {
      padding: 8px 0;
      border-bottom: 1px solid #385f4d;
      font-size: 0.9em;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .activity-item:last-child { border-bottom: none; }
    
    .activity-date { color: #b9c7bf; font-size: 0.8em; }
    
    .activity-icon { 
      margin-right: 8px; 
      font-size: 1.1em; 
    }
    
    .activity-amount { 
      color: #4f9a65; 
      font-weight: bold; 
      margin-left: 8px; 
    }
    
    .activity-negative { 
      color: #ff4444; 
    }
    
    .days-remaining {
      color: #ffaa00;
      font-weight: bold;
      font-size: 0.9em;
    }
    
    .days-expired {
      color: #ff4444;
      font-weight: bold;
      font-size: 0.9em;
    }
    
    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: #4f9a65;
      font-weight: bold;
    }

    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      background: #13251f;
      border: 1px solid #385f4d;
      color: #e8efe9;
      padding: 8px 12px;
      border-radius: 5px;
    }

    .growth-positive { color: #4f9a65; }
    .growth-negative { color: #ff4444; }
    .growth-neutral { color: #ffaa00; }

    /* Admin Login Styles */
    .admin-login-container {
      background: #1a2f26;
      border: 2px solid #385f4d;
      border-radius: 15px;
      padding: 40px;
      width: 100%;
      max-width: 400px;
      margin: 40px auto;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }

    .admin-login-container .logo h1 {
      color: #4f9a65;
      font-size: 2.5rem;
      margin-bottom: 5px;
      text-shadow: 0 0 10px rgba(79, 154, 101, 0.3);
      text-align: center;
    }

    .admin-login-container .logo p {
      color: #b9c7bf;
      font-size: 0.9rem;
      margin-bottom: 20px;
      text-align: center;
    }

    .login-btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(45deg, #4f9a65, #3d7a52);
      border: none;
      border-radius: 8px;
      color: #000;
      font-size: 1.1rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 20px;
    }

    .login-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(79, 154, 101, 0.3);
    }

    .login-btn:active {
      transform: translateY(0);
    }

    .login-btn:disabled {
      background: #333;
      color: #666;
      cursor: not-allowed;
      transform: none;
    }

    .error-message, .success-message {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      text-align: center;
    }

    .error-message {
      background: rgba(255, 0, 0, 0.1);
      border: 1px solid #ff3333;
      color: #ff6666;
    }

    .success-message {
      background: rgba(79, 154, 101, 0.1);
      border: 1px solid #4f9a65;
      color: #4f9a65;
    }

    .back-link {
      text-align: center;
      margin-top: 20px;
    }

    .link-btn {
      background: none;
      border: none;
      color: #b9c7bf;
      cursor: pointer;
      font-size: 0.9rem;
      transition: color 0.3s ease;
    }

    .link-btn:hover {
      color: #4f9a65;
    }

    .loader {
      border: 2px solid #333;
      border-top: 2px solid #4f9a65;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-right: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
<main>
  <h1>Ingresá a ZETALAB</h1>
  <div class="card">
    <div class="tabs">
      <div id="tab-login" class="tab active">Iniciar sesión</div>
      <div id="tab-register" class="tab">Crear cuenta</div>
    </div>

    <!-- Social Login Section -->
    <div class="social-section">
      <div class="social-buttons">
        <button id="google-login" class="social-btn google-btn">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
            <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
            <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
            <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
          </svg>
          Google
        </button>
        <button id="facebook-login" class="social-btn facebook-btn">
          <svg viewBox="0 0 24 24" fill="#1877F2" xmlns="http://www.w3.org/2000/svg">
            <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
          </svg>
          Facebook
        </button>
      </div>
      <div class="divider">
        <span>o continúa con email</span>
      </div>
    </div>

    <!-- Login -->
    <form id="form-login">
      <label>Email<input id="login-email" type="email" autocomplete="email" required /></label>
      <label>Contraseña<input id="login-pass" type="password" autocomplete="current-password" required /></label>
      <button type="submit">Entrar</button>
      <div class="row">
        <span class="link" id="btn-magic">Entrar con link por email</span>
        <a class="link" id="btn-reset">Restablecer contraseña</a>
      </div>
      <div id="login-msg" class="msg muted"></div>
    </form>

    <!-- Registro -->
    <form id="form-register" style="display:none">
      <label>Email<input id="reg-email" type="email" autocomplete="email" required /></label>
      <label>Contraseña<input id="reg-pass" type="password" autocomplete="new-password" required /></label>
      <label>Repetir contraseña<input id="reg-pass2" type="password" autocomplete="new-password" required /></label>
      <button type="submit">Crear cuenta</button>
      <div class="muted" style="margin-top:8px">Te puede llegar un correo para confirmar la cuenta.</div>
      <div id="reg-msg" class="msg muted"></div>
    </form>

    <div class="center" style="margin-top:16px">
      <a class="link" href="calculadora.html">Ir a la calculadora</a> ·
      <a class="link" href="mis-piezas.html">Mis piezas</a> ·
      <button id="adminAccessBtn" class="link" style="background: none; border: none; color: var(--muted); text-decoration: underline; cursor: pointer; font-size: inherit;">Admin</button>
    </div>
  </div>
</main>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<!-- Load subscription service before auth logic -->
<script src="subscription-service.js"></script>

<!-- Admin Dashboard Container (Hidden by default) -->
<div id="adminDashboard" style="display: none;">
  <div class="container">
    <div class="header">
      <h1>🔧 ZETALAB Admin Dashboard</h1>
      <p>Panel administrativo completo con gestión de usuarios y métricas avanzadas</p>
    </div>

    <div class="nav-tabs">
      <button class="nav-tab active" onclick="showAdminTab('dashboard')">Dashboard</button>
      <button class="nav-tab" onclick="showAdminTab('users')">Usuarios</button>
      <button class="nav-tab" onclick="showAdminTab('subscriptions')">Suscripciones</button>
      <button class="nav-tab" onclick="showAdminTab('pieces')">Piezas</button>
    </div>

    <!-- Dashboard Section -->
    <div id="adminDashboardSection" class="admin-section active">
      <div class="stats-grid">
        <div class="stat-card">
          <h3 id="totalUsers">0</h3>
          <p>Total Usuarios Registrados</p>
        </div>
        <div class="stat-card">
          <h3 id="activeUsers">0</h3>
          <p>Usuarios Activos (30 días)</p>
        </div>
        <div class="stat-card">
          <h3 id="verifiedUsers">0</h3>
          <p>Usuarios Verificados</p>
        </div>
        <div class="stat-card">
          <h3 id="activeSubscriptions">0</h3>
          <p>Suscripciones Activas</p>
        </div>
        <div class="stat-card">
          <h3 id="totalRevenue">$0</h3>
          <p>Ingresos Totales</p>
        </div>
        <div class="stat-card">
          <h3 id="monthlyGrowth">+0%</h3>
          <p>Crecimiento Mensual</p>
        </div>
      </div>

      <div class="data-table">
        <h3>📈 Actividad Reciente</h3>
        <div id="recentActivity" class="loading">Cargando...</div>
      </div>
    </div>

    <!-- Users Section -->
    <div id="adminUsersSection" class="admin-section">
      <div class="data-table">
        <h3>👥 Todos los Usuarios Registrados</h3>
        <div class="table-controls" style="padding: 15px; border-bottom: 1px solid #333;">
          <input type="text" id="userSearch" placeholder="🔍 Buscar por email..." 
                 style="background: #222; border: 1px solid #444; color: #e0e0e0; padding: 8px 12px; border-radius: 5px; width: 300px;">
          <select id="userFilter" style="background: #222; border: 1px solid #444; color: #e0e0e0; padding: 8px 12px; border-radius: 5px; margin-left: 10px;">
            <option value="all">Todos los usuarios</option>
            <option value="verified">Solo verificados</option>
            <option value="unverified">No verificados</option>
            <option value="active">Activos (30 días)</option>
            <option value="subscribed">Con suscripción</option>
          </select>
        </div>
        <div id="usersContent" class="loading">Cargando...</div>
      </div>

      <!-- User Edit Modal -->
      <div id="userEditModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1a1a1a; padding: 30px; border-radius: 10px; width: 500px; max-width: 90%; border: 2px solid #333;">
          <h3 style="color: #00ff88; margin-bottom: 20px;">✏️ Editar Usuario</h3>
          <div id="userEditContent"></div>
        </div>
      </div>
    </div>

    <!-- Subscriptions Section -->
    <div id="adminSubscriptionsSection" class="admin-section">
      <div class="data-table">
        <h3>Suscripciones Reales</h3>
        <div id="subscriptionsContent" class="loading">Cargando...</div>
      </div>
    </div>

    <!-- Pieces Section -->
    <div id="adminPiecesSection" class="admin-section">
      <!-- Pieces Statistics -->
      <div class="stats-grid">
        <div class="stat-card">
          <h3 id="totalPieces">0</h3>
          <p>Total Piezas</p>
        </div>
        <div class="stat-card">
          <h3 id="piecesThisMonth">0</h3>
          <p>Piezas Este Mes</p>
        </div>
        <div class="stat-card">
          <h3 id="averagePrice">$0</h3>
          <p>Precio Promedio</p>
        </div>
        <div class="stat-card">
          <h3 id="averagePrintTime">0h</h3>
          <p>Tiempo Impresión Promedio</p>
        </div>
      </div>

      <div class="data-table">
        <h3>🔧 Gestión de Piezas</h3>
        <div class="table-controls" style="padding: 15px; border-bottom: 1px solid #333;">
          <input type="text" id="pieceSearch" placeholder="🔍 Buscar por título..." 
                 style="background: #222; border: 1px solid #444; color: #e0e0e0; padding: 8px 12px; border-radius: 5px; width: 200px;">
          <input type="text" id="pieceUserSearch" placeholder="👤 Buscar por usuario..." 
                 style="background: #222; border: 1px solid #444; color: #e0e0e0; padding: 8px 12px; border-radius: 5px; width: 200px; margin-left: 10px;">
          <select id="pieceCategoryFilter" style="background: #222; border: 1px solid #444; color: #e0e0e0; padding: 8px 12px; border-radius: 5px; margin-left: 10px;">
            <option value="all">Todas las categorías</option>
            <option value="decorativo">Decorativo</option>
            <option value="funcional">Funcional</option>
            <option value="prototipo">Prototipo</option>
            <option value="repuesto">Repuesto</option>
            <option value="miniatura">Miniatura</option>
            <option value="herramienta">Herramienta</option>
            <option value="juguete">Juguete</option>
            <option value="otro">Otro</option>
          </select>
          <input type="date" id="pieceDateFrom" 
                 style="background: #222; border: 1px solid #444; color: #e0e0e0; padding: 8px 12px; border-radius: 5px; margin-left: 10px;" 
                 title="Desde fecha">
          <input type="date" id="pieceDateTo" 
                 style="background: #222; border: 1px solid #444; color: #e0e0e0; padding: 8px 12px; border-radius: 5px; margin-left: 10px;" 
                 title="Hasta fecha">
          <button class="action-btn secondary" onclick="clearPieceFilters()" style="margin-left: 10px;">🗑️ Limpiar</button>
        </div>
        <div id="piecesContent" class="loading">Cargando...</div>
      </div>

      <!-- Piece Detail Modal -->
      <div id="pieceDetailModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1a1a1a; padding: 30px; border-radius: 10px; width: 800px; max-width: 90%; max-height: 90%; overflow-y: auto; border: 2px solid #333;">
          <h3 style="color: #00ff88; margin-bottom: 20px;">🔧 Detalles de Pieza</h3>
          <div id="pieceDetailContent"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Admin Login Form (Hidden by default) -->
<div id="adminLogin" style="display: none;">
  <div class="admin-login-container">
    <div class="logo">
      <h1>ZETALAB</h1>
      <p>Panel de Administración</p>
    </div>

    <div id="adminErrorMessage" class="error-message" style="display: none;"></div>
    <div id="adminSuccessMessage" class="success-message" style="display: none;"></div>

    <form id="adminLoginForm">
      <div class="form-group">
        <label for="adminEmail">Email de Administrador</label>
        <input type="email" id="adminEmail" name="adminEmail" required autocomplete="email">
      </div>

      <div class="form-group">
        <label for="adminPassword">Contraseña</label>
        <input type="password" id="adminPassword" name="adminPassword" required autocomplete="current-password">
      </div>

      <button type="submit" id="adminLoginBtn" class="login-btn">
        Iniciar Sesión
      </button>
    </form>

    <div class="back-link">
      <button id="backToUserLogin" class="link-btn">← Volver al login de usuarios</button>
    </div>
  </div>
</div>

<script>
  /*** CONFIG SUPABASE (tu proyecto) ***/
  // CONFIGURACIÓN: Centralizar credenciales para uso global
  window.SUPABASE_URL = "https://fwmyiovamcxvinoxnput.supabase.co";
  window.SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3bXlpb3ZhbWN4dmlub3hucHV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxNzAzODksImV4cCI6MjA3MTc0NjM4OX0.x94-SZj7-BR9CGMzeujkjyk_7iItajoHKkGRgIYPUTc";
  const supabase = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
  
  // Make supabase available to subscription service
  window.supa = supabase;

  // Admin configuration (Service Role Key for admin operations)
  const SERVICE_ROLE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3bXlpb3ZhbWN4dmlub3hucHV0Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NjE3MDM4OSwiZXhwIjoyMDcxNzQ2Mzg5fQ.DfuFLgbxVNmrhfqXVgCRIoTCsDvUK02qR9wJqzik2PY';
  
  // Global admin state
  let currentAdminSession = null;
  let adminSupabase = null;
  let isAdminMode = false;

  // Check for admin session and URL parameters
  const urlParams = new URLSearchParams(window.location.search);
  const adminParam = urlParams.get('admin');

  // UI Elements
  const userInterface = document.querySelector('main');
  const adminDashboard = document.getElementById('adminDashboard');
  const adminLogin = document.getElementById('adminLogin');

  /*** Admin Mode Detection and Initialization ***/
  async function initializeApp() {
    // Check if user is trying to access admin or if there's an existing admin session
    const adminSession = localStorage.getItem('admin_session');
    
    if (adminParam === 'true' || adminSession) {
      console.log('🔐 Admin mode detected');
      await initAdminMode();
      return;
    }

    // Initialize regular user mode
    await initUserMode();
  }

  async function initAdminMode() {
    isAdminMode = true;
    console.log('🔐 Initializing admin mode...');
    
    // Hide user interface, show admin interface
    userInterface.style.display = 'none';
    
    // Check for existing valid admin session
    const adminSessionStr = localStorage.getItem('admin_session');
    if (adminSessionStr) {
      try {
        const adminSession = JSON.parse(adminSessionStr);
        if (adminSession.expires_at && new Date(adminSession.expires_at) > new Date()) {
          console.log('✅ Valid admin session found');
          currentAdminSession = adminSession;
          adminSupabase = window.supabase.createClient(window.SUPABASE_URL, SERVICE_ROLE_KEY);
          showAdminDashboard();
          return;
        }
      } catch (e) {
        localStorage.removeItem('admin_session');
      }
    }
    
    // Show admin login
    showAdminLogin();
  }

  async function initUserMode() {
    console.log('👤 Initializing user mode...');
    isAdminMode = false;
    adminDashboard.style.display = 'none';
    adminLogin.style.display = 'none';
    userInterface.style.display = 'block';
    
    // Continue with OAuth callback handling for users
    await handleUserAuthentication();
  }

  function showAdminLogin() {
    userInterface.style.display = 'none';
    adminDashboard.style.display = 'none';
    adminLogin.style.display = 'block';
  }

  function showAdminDashboard() {
    userInterface.style.display = 'none';
    adminLogin.style.display = 'none';
    adminDashboard.style.display = 'block';
    loadAdminDashboard();
  }

  function showUserInterface() {
    adminDashboard.style.display = 'none';
    adminLogin.style.display = 'none';
    userInterface.style.display = 'block';
  }

  /*** Enhanced OAuth callback handling with trial activation ***/
  async function handleUserAuthentication() {
    try {
      let isOAuthCallback = false;
      
      // Handle OAuth callback from URL hash (magic link, OAuth)
      if (location.hash && location.hash.includes('access_token')) {
        console.log('🔐 Procesando callback de autenticación...');
        
        const p = new URLSearchParams(location.hash.slice(1));
        const access_token = p.get('access_token');
        const refresh_token = p.get('refresh_token');
        const type = p.get('type'); // 'signup', 'magiclink', 'recovery', etc.
        
        if (access_token && refresh_token) {
          await supabase.auth.setSession({ access_token, refresh_token });
          isOAuthCallback = true;
          
          console.log(`✅ Sesión establecida (tipo: ${type || 'oauth'})`);
        }
        
        // Clean URL
        history.replaceState({}, document.title, location.pathname + location.search);
      }
      
      // Check current session
      const { data: { session } } = await supabase.auth.getSession();
      
      if (session) {
        console.log('👤 Usuario autenticado:', session.user.email);
        
        // If this is a new OAuth user, try to activate trial automatically
        if (isOAuthCallback && window.subscriptionService) {
          try {
            console.log('🎁 Verificando elegibilidad para trial automático...');
            const isEligible = await window.subscriptionService.isEligibleForTrial(session.user.id);
            
            if (isEligible) {
              console.log('✅ Usuario elegible - activando trial automático...');
              await window.subscriptionService.activateTrialForNewUser(session.user.id);
              console.log('🎉 Trial automático activado para nuevo usuario OAuth');
            } else {
              console.log('ℹ️ Usuario no elegible para trial (ya tuvo suscripciones previas)');
            }
          } catch (trialError) {
            console.warn('⚠️ Error activando trial automático:', trialError);
            // Don't block login if trial activation fails
          }
        }
        
        // Check if we should show welcome popup for new users
        if (isOAuthCallback && window.subscriptionService) {
          try {
            const isEligible = await window.subscriptionService.isEligibleForTrial(session.user.id);
            if (isEligible) {
              console.log('🎁 Mostrando popup de bienvenida para nuevo usuario...');
              // Store welcome popup data for showing after redirect
              sessionStorage.setItem('showWelcomePopup', JSON.stringify({
                isNewUser: true,
                authProvider: 'oauth',
                userEmail: session.user.email
              }));
            }
          } catch (error) {
            console.warn('⚠️ Error verificando elegibilidad para welcome popup:', error);
          }
        }
        
        // Redirect to calculator
        console.log('🚀 Redirigiendo a calculadora...');
        location.href = 'calculadora.html';
      } else {
        console.log('🔓 Usuario no autenticado, mostrando formulario de login');
      }
      
    } catch (error) {
      console.error('❌ Error procesando autenticación:', error);
      // Show error but don't block the login page
      const msg = document.getElementById('login-msg');
      if (msg) {
        msg.textContent = 'Error procesando autenticación. Intenta iniciar sesión manualmente.';
      }
    }
  }

  // Initialize the app
  initializeApp();

  /*** Admin Access Button Handler ***/
  document.getElementById('adminAccessBtn').addEventListener('click', () => {
    window.location.search = '?admin=true';
  });

  /*** Admin Login Form Handler ***/
  const adminLoginForm = document.getElementById('adminLoginForm');
  if (adminLoginForm) {
    adminLoginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const email = document.getElementById('adminEmail').value.trim();
      const password = document.getElementById('adminPassword').value.trim();
      
      if (!email || !password) {
        showAdminError('Por favor completa todos los campos');
        return;
      }
      
      await loginAdmin(email, password);
    });
  }

  /*** Back to User Login Handler ***/
  document.getElementById('backToUserLogin').addEventListener('click', () => {
    window.location.search = '';
  });

  /*** Admin Login Function ***/
  async function loginAdmin(email, password) {
    try {
      setAdminLoading(true);
      hideAdminMessages();
      
      console.log('🔐 Attempting admin login for:', email);
      
      // 1. Authenticate with Supabase Auth
      const { data: authData, error: authError } = await supabase.auth.signInWithPassword({
        email: email,
        password: password
      });
      
      if (authError || !authData.user) {
        throw new Error(authError?.message || 'Error de autenticación');
      }
      
      console.log('✅ User authenticated:', authData.user.email);
      
      // 2. Verify user is admin (using service role)
      const supabaseAdmin = window.supabase.createClient(window.SUPABASE_URL, SERVICE_ROLE_KEY);
      
      const { data: adminUser, error: adminError } = await supabaseAdmin
        .from('admin_users')
        .select('*')
        .eq('user_id', authData.user.id)
        .eq('active', true)
        .single();
      
      if (adminError || !adminUser) {
        await supabase.auth.signOut();
        throw new Error('No tienes permisos de administrador o tu cuenta está desactivada');
      }
      
      console.log('✅ User verified as admin:', adminUser);
      
      // 3. Create admin session
      const sessionData = {
        admin_id: adminUser.id,
        user_id: authData.user.id,
        email: authData.user.email,
        role: adminUser.role,
        permissions: adminUser.permissions,
        token: authData.session.access_token,
        expires_at: new Date(authData.session.expires_at * 1000).toISOString(),
        created_at: new Date().toISOString()
      };
      
      // 4. Save session
      localStorage.setItem('admin_session', JSON.stringify(sessionData));
      currentAdminSession = sessionData;
      adminSupabase = supabaseAdmin;
      
      console.log('💾 Admin session saved');
      
      showAdminSuccess('¡Bienvenido! Cargando dashboard...');
      
      // 5. Redirect to dashboard
      setTimeout(() => {
        showAdminDashboard();
      }, 1500);
      
    } catch (error) {
      console.error('❌ Error in admin login:', error);
      showAdminError(error.message || 'Error de autenticación');
    } finally {
      setAdminLoading(false);
    }
  }

  /*** Admin UI Helper Functions ***/
  function setAdminLoading(loading) {
    const loginBtn = document.getElementById('adminLoginBtn');
    const form = document.getElementById('adminLoginForm');
    
    if (loading) {
      loginBtn.innerHTML = '<div class="loader"></div>Iniciando sesión...';
      loginBtn.disabled = true;
      form.classList.add('loading');
    } else {
      loginBtn.innerHTML = 'Iniciar Sesión';
      loginBtn.disabled = false;
      form.classList.remove('loading');
    }
  }
  
  function showAdminError(message) {
    const errorEl = document.getElementById('adminErrorMessage');
    const successEl = document.getElementById('adminSuccessMessage');
    errorEl.textContent = message;
    errorEl.style.display = 'block';
    successEl.style.display = 'none';
  }
  
  function showAdminSuccess(message) {
    const errorEl = document.getElementById('adminErrorMessage');
    const successEl = document.getElementById('adminSuccessMessage');
    successEl.textContent = message;
    successEl.style.display = 'block';
    errorEl.style.display = 'none';
  }
  
  function hideAdminMessages() {
    document.getElementById('adminErrorMessage').style.display = 'none';
    document.getElementById('adminSuccessMessage').style.display = 'none';
  }

  /*** Tabs simples ***/
  const tabLogin = document.getElementById('tab-login');
  const tabRegister = document.getElementById('tab-register');
  const formLogin = document.getElementById('form-login');
  const formRegister = document.getElementById('form-register');
  tabLogin.onclick = () => { tabLogin.classList.add('active'); tabRegister.classList.remove('active'); formLogin.style.display='block'; formRegister.style.display='none'; };
  tabRegister.onclick = () => { tabRegister.classList.add('active'); tabLogin.classList.remove('active'); formRegister.style.display='block'; formLogin.style.display='none'; };

  /*** Login con email + password ***/
  formLogin.addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('login-email').value.trim();
    const password = document.getElementById('login-pass').value;
    const msg = document.getElementById('login-msg');
    
    // VALIDACIÓN: Verificar campos antes de enviar
    if (!email || !password) {
      msg.textContent = 'Complete todos los campos';
      return;
    }
    
    msg.textContent = 'Ingresando…';
    try {
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) { 
        msg.textContent = error.message; 
        return; 
      }
      msg.textContent = 'Listo, redirigiendo…';
      location.href = 'calculadora.html';
    } catch (err) {
      console.error('Error en login:', err);
      msg.textContent = 'Error de conexión. Intentá de nuevo.';
    }
  });

  /*** Enhanced email registration with auto trial ***/
  formRegister.addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('reg-email').value.trim();
    const pass1 = document.getElementById('reg-pass').value;
    const pass2 = document.getElementById('reg-pass2').value;
    const msg = document.getElementById('reg-msg');
    
    if (pass1 !== pass2) { msg.textContent = 'Las contraseñas no coinciden.'; return; }
    
    msg.textContent = 'Creando cuenta…';
    
    try {
      const { data, error } = await supabase.auth.signUp({
        email, 
        password: pass1,
        options: { emailRedirectTo: window.location.href }
      });
      
      if (error) { 
        msg.textContent = error.message; 
        return; 
      }
      
      // Check if user was created and is immediately available (no email confirmation required)
      const { data: { session } } = await supabase.auth.getSession();
      
      if (session) {
        // User is immediately logged in - activate trial
        msg.textContent = 'Cuenta creada. Activando trial gratuito...';
        
        try {
          if (window.subscriptionService) {
            await window.subscriptionService.activateTrialForNewUser(session.user.id);
            console.log('🎉 Trial automático activado para nuevo usuario email');
            msg.textContent = '¡Perfecto! Cuenta creada con 7 días de acceso premium gratuito.';
            
            // Store welcome popup data for showing after redirect
            sessionStorage.setItem('showWelcomePopup', JSON.stringify({
              isNewUser: true,
              authProvider: 'email',
              userEmail: session.user.email
            }));
          }
        } catch (trialError) {
          console.warn('⚠️ Error activando trial automático:', trialError);
          msg.textContent = 'Cuenta creada exitosamente.';
        }
        
        // Redirect after a short delay
        setTimeout(() => {
          location.href = 'calculadora.html';
        }, 2000);
        
      } else {
        // Email confirmation required
        msg.textContent = 'Listo. Revisá tu email para confirmar la cuenta. Una vez confirmada, tendrás 7 días de acceso premium gratuito.';
      }
      
    } catch (err) {
      console.error('Error en registro:', err);
      msg.textContent = 'Error creando cuenta. Intentá de nuevo.';
    }
  });

  /*** Magic link (sin contraseña) ***/
  document.getElementById('btn-magic').onclick = async () => {
    const email = (document.getElementById('login-email').value || '').trim();
    const msg = document.getElementById('login-msg');
    if (!email) { msg.textContent = 'Escribí tu email primero.'; return; }
    msg.textContent = 'Enviando link…';
    const { error } = await supabase.auth.signInWithOtp({
      email,
      options: { emailRedirectTo: window.location.href } // vuelve a este index
    });
    msg.textContent = error ? error.message : 'Listo, revisá tu correo y abrí el link.';
  };

  /*** Reset de contraseña ***/
  document.getElementById('btn-reset').onclick = async () => {
    const email = (document.getElementById('login-email').value || '').trim();
    const msg = document.getElementById('login-msg');
    if (!email) { msg.textContent = 'Poné tu email arriba y tocá "Restablecer".'; return; }
    const { error } = await supabase.auth.resetPasswordForEmail(email, {
      redirectTo: window.location.href // desde el mail volverá aquí y podés mostrar un form para nueva pass
    });
    msg.textContent = error ? error.message : 'Te enviamos un email para cambiar la contraseña.';
  };

  /*** Improved OAuth Login Functions with proper error handling ***/
  const handleSocialLogin = async (provider) => {
    const currentTabIsRegister = document.getElementById('tab-register').classList.contains('active');
    const msg = currentTabIsRegister ? 
      document.getElementById('reg-msg') : 
      document.getElementById('login-msg');
    
    msg.textContent = `Conectando con ${provider}...`;
    
    try {
      // Enhanced OAuth configuration with proper redirect handling
      const { data, error } = await supabase.auth.signInWithOAuth({
        provider: provider,
        options: {
          redirectTo: `${window.location.origin}/calculadora.html`,
          queryParams: {
            access_type: 'offline',
            prompt: 'consent',
          },
          // Skip confirmation page for better UX
          skipBrowserRedirect: false
        }
      });
      
      if (error) {
        console.error(`❌ Error en login con ${provider}:`, error);
        msg.textContent = `Error conectando con ${provider}. ${error.message}`;
        
        // Specific error handling for common OAuth issues
        if (error.message.includes('not enabled')) {
          msg.textContent = `${provider} no está habilitado. Contacta al administrador.`;
        } else if (error.message.includes('Invalid redirect')) {
          msg.textContent = `Error de configuración. Intenta con email/contraseña.`;
        }
        return;
      }
      
      // OAuth initiated successfully - user will be redirected
      msg.textContent = `Redirigiendo a ${provider}...`;
      
      // Log success for debugging
      console.log(`✅ OAuth iniciado exitosamente para ${provider}`);
      
    } catch (err) {
      console.error(`❌ Error inesperado con ${provider}:`, err);
      msg.textContent = `Error de conexión con ${provider}. Verifica tu conexión e intenta de nuevo.`;
      
      // Additional debugging info
      if (navigator.onLine === false) {
        msg.textContent = `Sin conexión a internet. Verifica tu conexión.`;
      }
    }
  };

  /*** Google Login ***/
  document.getElementById('google-login').onclick = async () => {
    await handleSocialLogin('google');
  };

  /*** Facebook Login ***/
  document.getElementById('facebook-login').onclick = async () => {
    await handleSocialLogin('facebook');
  };
  
  /*** ADMIN DASHBOARD FUNCTIONALITY ***/
  
  // Global admin data
  let allUsers = [];
  let allSubscriptions = [];
  let allPieces = [];
  let allPieceVersions = [];
  let allPaymentTransactions = [];
  let allConfigProfiles = [];
  let allFilaments = [];
  let allUserUsage = [];

  // Admin tab navigation
  function showAdminTab(tabName) {
    // Hide all sections
    document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    
    // Show selected section
    document.getElementById('admin' + tabName.charAt(0).toUpperCase() + tabName.slice(1) + 'Section').classList.add('active');
    event.target.classList.add('active');

    // Load data if needed
    if (tabName === 'users') loadUsers();
    if (tabName === 'subscriptions') loadSubscriptions();
    if (tabName === 'pieces') loadPieces();
  }

  // Load admin dashboard
  async function loadAdminDashboard() {
    if (!currentAdminSession || !adminSupabase) return;
    
    try {
      console.log('📊 Loading admin dashboard...');
      
      // Load all data
      await Promise.all([
        loadAllUsers(),
        loadAllSubscriptions(),
        loadAllPieces(),
        loadAdditionalData()
      ]);
      
      // Calculate and display metrics
      updateDashboardStats();
      loadRecentActivity();
      
      // Add logout button and admin info
      addAdminLogoutButton();
      
      console.log('✅ Admin dashboard loaded successfully');
      
    } catch (error) {
      console.error('❌ Error loading admin dashboard:', error);
    }
  }

  async function loadAllUsers() {
    const { data: users } = await adminSupabase.auth.admin.listUsers();
    allUsers = users?.users || [];
    console.log('👥 Users loaded:', allUsers.length);
  }

  async function loadAllSubscriptions() {
    const { data: subscriptions } = await adminSupabase
      .from('subscriptions')
      .select('*');
    allSubscriptions = subscriptions || [];
    console.log('💳 Subscriptions loaded:', allSubscriptions.length);
  }

  async function loadAllPieces() {
    const { data: pieces } = await adminSupabase
      .from('pieces')
      .select('*')
      .order('created_at', { ascending: false });
    allPieces = pieces || [];
    console.log('🔧 Pieces loaded:', allPieces.length);
  }

  async function loadAdditionalData() {
    const [pieceVersions, paymentTransactions, configProfiles, filaments, userUsage] = await Promise.all([
      adminSupabase.from('piece_versions').select('*').order('created_at', { ascending: false }).limit(100),
      adminSupabase.from('payment_transactions').select('*').order('created_at', { ascending: false }).limit(100),
      adminSupabase.from('config_profiles').select('*').order('created_at', { ascending: false }).limit(100),
      adminSupabase.from('filaments').select('*').order('created_at', { ascending: false }).limit(100),
      adminSupabase.from('user_usage').select('*').order('created_at', { ascending: false }).limit(100)
    ]);

    allPieceVersions = pieceVersions.data || [];
    allPaymentTransactions = paymentTransactions.data || [];
    allConfigProfiles = configProfiles.data || [];
    allFilaments = filaments.data || [];
    allUserUsage = userUsage.data || [];
  }

  function updateDashboardStats() {
    const totalUsers = allUsers.length;
    
    // Active users (last 30 days)
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
    const activeUsers = allUsers.filter(user => 
      user.last_sign_in_at && new Date(user.last_sign_in_at) > thirtyDaysAgo
    ).length;

    // Verified users
    const verifiedUsers = allUsers.filter(user => user.email_confirmed_at).length;

    // Active subscriptions
    const activeSubs = allSubscriptions.filter(s => {
      const isActive = s.active === true;
      const notExpired = !s.expires_at || new Date(s.expires_at) > new Date();
      return isActive && notExpired;
    }).length;

    // Total revenue
    const totalRevenue = allSubscriptions.reduce((sum, s) => {
      return sum + (parseFloat(s.amount) || 0);
    }, 0);

    // Monthly growth
    const lastMonth = new Date();
    lastMonth.setMonth(lastMonth.getMonth() - 1);
    const usersLastMonth = allUsers.filter(user => 
      new Date(user.created_at) > lastMonth
    ).length;
    const usersBeforeLastMonth = totalUsers - usersLastMonth;
    const monthlyGrowth = usersBeforeLastMonth > 0 
      ? ((usersLastMonth / usersBeforeLastMonth) * 100) 
      : 0;

    // Update UI
    document.getElementById('totalUsers').textContent = totalUsers;
    document.getElementById('activeUsers').textContent = activeUsers;
    document.getElementById('verifiedUsers').textContent = verifiedUsers;
    document.getElementById('activeSubscriptions').textContent = activeSubs;
    document.getElementById('totalRevenue').textContent = `$${totalRevenue.toLocaleString()}`;
    
    const growthEl = document.getElementById('monthlyGrowth');
    growthEl.textContent = `+${monthlyGrowth.toFixed(1)}%`;
    growthEl.className = monthlyGrowth > 0 ? 'growth-positive' : 
                       monthlyGrowth < 0 ? 'growth-negative' : 'growth-neutral';
  }

  function loadRecentActivity() {
    const activities = [];

    // Recent users
    allUsers.slice(-5).forEach(user => {
      activities.push({
        type: 'user_register',
        date: new Date(user.created_at),
        description: `Nuevo usuario registrado: ${user.email}`,
        icon: '👤'
      });
    });

    // Recent calculations
    allPieceVersions.slice(-8).forEach(version => {
      const user = allUsers.find(u => u.id === version.user_id);
      const piece = allPieces.find(p => p.id === version.piece_id);
      const total = version.total ? `$${parseFloat(version.total).toLocaleString()}` : 'N/A';
      activities.push({
        type: 'budget_calculated',
        date: new Date(version.created_at),
        description: `Presupuesto calculado: ${total} para "${piece?.title || 'Pieza'}"`,
        icon: '💰',
        user: user?.email || 'Usuario desconocido',
        amount: total
      });
    });

    // Recent subscriptions
    allSubscriptions.slice(-3).forEach(sub => {
      const user = allUsers.find(u => u.id === sub.user_id);
      activities.push({
        type: 'subscription',
        date: new Date(sub.created_at),
        description: `Suscripción ${sub.plan_type}: $${parseFloat(sub.amount || 0).toLocaleString()}`,
        icon: '💎',
        user: user?.email || 'Usuario desconocido',
        amount: `$${parseFloat(sub.amount || 0).toLocaleString()}`
      });
    });

    // Sort by date
    activities.sort((a, b) => b.date - a.date);

    let html = '';
    activities.slice(0, 15).forEach(activity => {
      html += `
        <div class="activity-item">
          <div>
            <span class="activity-icon">${activity.icon}</span>
            ${activity.description}
            ${activity.user ? `<br><small style="color: #888;">por ${activity.user}</small>` : ''}
          </div>
          <div style="text-align: right;">
            ${activity.amount ? `<div class="activity-amount">${activity.amount}</div>` : ''}
            <div class="activity-date">${activity.date.toLocaleString('es-ES')}</div>
          </div>
        </div>
      `;
    });

    document.getElementById('recentActivity').innerHTML = html || '<p>No hay actividad reciente</p>';
  }

  // Load users section
  async function loadUsers() {
    if (allUsers.length === 0) await loadAllUsers();
    displayUsers(allUsers);
    setupUserFilters();
  }

  function displayUsers(users) {
    if (!users || users.length === 0) {
      document.getElementById('usersContent').innerHTML = '<p>No hay usuarios registrados</p>';
      return;
    }

    let html = `
      <table>
        <thead>
          <tr>
            <th>Email</th>
            <th>Verificado</th>
            <th>Registrado</th>
            <th>Último Acceso</th>
            <th>Piezas</th>
            <th>Suscripción</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
    `;

    users.forEach(user => {
      const userPieces = allPieces.filter(p => p.user_id === user.id);
      const userSubscription = allSubscriptions.find(s => s.user_id === user.id && s.active);
      
      const isVerified = user.email_confirmed_at ? 'Sí' : 'No';
      const verifiedClass = user.email_confirmed_at ? 'status-active' : 'status-inactive';
      
      const registeredDate = new Date(user.created_at).toLocaleDateString('es-ES');
      const lastLogin = user.last_sign_in_at ? new Date(user.last_sign_in_at).toLocaleDateString('es-ES') : 'Nunca';
      
      const subStatus = userSubscription ? userSubscription.plan_type : 'Ninguna';
      const subClass = userSubscription ? 'status-active' : 'status-inactive';

      html += `
        <tr>
          <td><strong>${user.email}</strong></td>
          <td><span class="status-badge ${verifiedClass}">${isVerified}</span></td>
          <td>${registeredDate}</td>
          <td>${lastLogin}</td>
          <td><strong>${userPieces.length}</strong></td>
          <td><span class="status-badge ${subClass}">${subStatus}</span></td>
          <td>
            <button class="action-btn" onclick="editUser('${user.id}')">✏️ Editar</button>
            <button class="action-btn secondary" onclick="viewUserActivity('${user.id}')">📊 Actividad</button>
          </td>
        </tr>
      `;
    });

    html += '</tbody></table>';
    document.getElementById('usersContent').innerHTML = html;
  }

  function setupUserFilters() {
    const searchInput = document.getElementById('userSearch');
    const filterSelect = document.getElementById('userFilter');
    
    if (searchInput && filterSelect) {
      searchInput.addEventListener('input', filterUsers);
      filterSelect.addEventListener('change', filterUsers);
    }
  }

  function filterUsers() {
    const searchTerm = document.getElementById('userSearch').value.toLowerCase();
    const filterType = document.getElementById('userFilter').value;

    let filteredUsers = allUsers.filter(user => 
      user.email.toLowerCase().includes(searchTerm)
    );

    switch (filterType) {
      case 'verified':
        filteredUsers = filteredUsers.filter(user => user.email_confirmed_at);
        break;
      case 'unverified':
        filteredUsers = filteredUsers.filter(user => !user.email_confirmed_at);
        break;
      case 'active':
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        filteredUsers = filteredUsers.filter(user => 
          user.last_sign_in_at && new Date(user.last_sign_in_at) > thirtyDaysAgo
        );
        break;
      case 'subscribed':
        filteredUsers = filteredUsers.filter(user => 
          allSubscriptions.some(s => s.user_id === user.id && s.active)
        );
        break;
    }

    displayUsers(filteredUsers);
  }

  // Load subscriptions
  async function loadSubscriptions() {
    if (allSubscriptions.length === 0) await loadAllSubscriptions();
    displaySubscriptions();
  }

  function displaySubscriptions() {
    const subscriptions = allSubscriptions;
    
    if (!subscriptions || subscriptions.length === 0) {
      document.getElementById('subscriptionsContent').innerHTML = '<p>No hay suscripciones registradas</p>';
      return;
    }

    let html = `
      <table>
        <thead>
          <tr>
            <th>Email</th>
            <th>Plan</th>
            <th>Estado</th>
            <th>Monto</th>
            <th>Creada</th>
            <th>Expira</th>
            <th>Días Restantes</th>
          </tr>
        </thead>
        <tbody>
    `;

    subscriptions.forEach(sub => {
      const user = allUsers.find(u => u.id === sub.user_id);
      const userEmail = user ? user.email : 'Usuario no encontrado';
      
      const now = new Date();
      const createdDate = new Date(sub.created_at);
      const expiry = sub.expires_at ? new Date(sub.expires_at) : null;
      
      let status = 'inactive';
      let statusText = 'Inactiva';
      let daysRemaining = 'N/A';
      let daysClass = '';
      
      if (sub.active) {
        if (expiry && expiry > now) {
          status = 'active';
          statusText = 'Activa';
          const timeDiff = expiry.getTime() - now.getTime();
          const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
          daysRemaining = daysDiff;
          daysClass = daysDiff <= 7 ? 'days-expired' : daysDiff <= 30 ? 'days-remaining' : '';
        } else if (expiry && expiry < now) {
          status = 'inactive';
          statusText = 'Expirada';
          const timeDiff = now.getTime() - expiry.getTime();
          const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
          daysRemaining = `-${daysDiff}`;
          daysClass = 'days-expired';
        }
      }

      if (sub.plan_type === 'trial') {
        status = 'trial';
        statusText = 'Trial';
      }

      html += `
        <tr>
          <td><strong>${userEmail}</strong></td>
          <td>${sub.plan_type.replace('_', ' ')}</td>
          <td><span class="status-badge status-${status}">${statusText}</span></td>
          <td>$${sub.amount ? parseFloat(sub.amount).toLocaleString() : '0'}</td>
          <td>${createdDate.toLocaleDateString('es-ES')}</td>
          <td>${expiry ? expiry.toLocaleDateString('es-ES') : 'Sin vencimiento'}</td>
          <td>
            <span class="${daysClass}">
              ${daysRemaining === 'N/A' ? 'N/A' : 
                daysRemaining > 0 ? `${daysRemaining} días` : 
                `Expiró hace ${Math.abs(daysRemaining)} días`}
            </span>
          </td>
        </tr>
      `;
    });

    html += '</tbody></table>';
    document.getElementById('subscriptionsContent').innerHTML = html;
  }

  // Load pieces
  async function loadPieces() {
    if (allPieces.length === 0) await loadAllPieces();
    loadPiecesStatistics();
    displayPieces(allPieces);
  }

  function loadPiecesStatistics() {
    const totalPieces = allPieces.length;
    
    // Pieces this month
    const thisMonth = new Date();
    thisMonth.setDate(1);
    const piecesThisMonth = allPieces.filter(piece => 
      new Date(piece.created_at) >= thisMonth
    ).length;

    // Average price
    const averagePrice = totalPieces > 0 
      ? allPieces.reduce((sum, piece) => sum + (parseFloat(piece.est_price_ars) || 0), 0) / totalPieces
      : 0;

    // Average print time
    const averagePrintTimeMinutes = totalPieces > 0
      ? allPieces.reduce((sum, piece) => sum + (parseInt(piece.est_print_time_min) || 0), 0) / totalPieces
      : 0;

    const hours = Math.floor(averagePrintTimeMinutes / 60);
    const minutes = Math.round(averagePrintTimeMinutes % 60);

    // Update UI
    document.getElementById('totalPieces').textContent = totalPieces;
    document.getElementById('piecesThisMonth').textContent = piecesThisMonth;
    document.getElementById('averagePrice').textContent = `$${averagePrice.toLocaleString()}`;
    document.getElementById('averagePrintTime').textContent = `${hours}h ${minutes}m`;
  }

  function displayPieces(pieces) {
    if (!pieces || pieces.length === 0) {
      document.getElementById('piecesContent').innerHTML = '<p>No hay piezas registradas</p>';
      return;
    }

    let html = `
      <table>
        <thead>
          <tr>
            <th>Título</th>
            <th>Usuario</th>
            <th>Categoría</th>
            <th>Peso (g)</th>
            <th>Tiempo</th>
            <th>Precio</th>
            <th>Creada</th>
          </tr>
        </thead>
        <tbody>
    `;

    pieces.forEach(piece => {
      const user = allUsers.find(u => u.id === piece.user_id);
      const userEmail = user ? user.email : 'Usuario no encontrado';

      const weight = piece.est_weight_grams ? `${piece.est_weight_grams}g` : 'N/A';
      const printTime = piece.est_print_time_min ? `${Math.floor(piece.est_print_time_min / 60)}h ${piece.est_print_time_min % 60}m` : 'N/A';
      const price = piece.est_price_ars ? `$${parseFloat(piece.est_price_ars).toLocaleString()}` : 'N/A';
      const category = piece.category || 'Sin categoría';
      const createdDate = new Date(piece.created_at).toLocaleDateString('es-ES');

      html += `
        <tr>
          <td>
            <strong>${piece.title}</strong>
            ${piece.image_url ? `<br><small style="color: #4f9a65;">📷 Con imagen</small>` : ''}
          </td>
          <td>${userEmail}</td>
          <td><span class="status-badge secondary">${category}</span></td>
          <td>${weight}</td>
          <td>${printTime}</td>
          <td><strong>${price}</strong></td>
          <td>${createdDate}</td>
        </tr>
      `;
    });

    html += '</tbody></table>';
    document.getElementById('piecesContent').innerHTML = html;
  }

  // Add admin logout button
  function addAdminLogoutButton() {
    const header = document.querySelector('#adminDashboard .header');
    if (header && !document.getElementById('adminLogoutBtn')) {
      const logoutBtn = document.createElement('button');
      logoutBtn.id = 'adminLogoutBtn';
      logoutBtn.innerHTML = '🚪 Cerrar Sesión';
      logoutBtn.className = 'action-btn danger';
      logoutBtn.style.cssText = `
        position: absolute;
        top: 20px;
        right: 20px;
      `;
      
      logoutBtn.addEventListener('click', () => {
        if (confirm('¿Estás seguro de que quieres cerrar la sesión de administrador?')) {
          logoutAdmin();
        }
      });
      
      header.style.position = 'relative';
      header.appendChild(logoutBtn);
      
      // Show admin info
      if (currentAdminSession) {
        const adminInfo = document.createElement('div');
        adminInfo.style.cssText = `
          position: absolute;
          top: 60px;
          right: 20px;
          font-size: 0.8rem;
          color: #b9c7bf;
          text-align: right;
        `;
        adminInfo.innerHTML = `
          Admin: ${currentAdminSession.email}<br>
          Rol: ${currentAdminSession.role || 'admin'}
        `;
        header.appendChild(adminInfo);
      }
    }
  }

  // Admin logout
  async function logoutAdmin() {
    try {
      console.log('👋 Logging out admin...');
      
      if (currentAdminSession) {
        await supabase.auth.signOut();
      }
      
      localStorage.removeItem('admin_session');
      currentAdminSession = null;
      adminSupabase = null;
      isAdminMode = false;
      
      // Redirect to user interface
      window.location.search = '';
      
    } catch (error) {
      console.warn('⚠️ Error in logout:', error);
      // Force redirect anyway
      localStorage.removeItem('admin_session');
      window.location.search = '';
    }
  }

  // Dummy functions for editor and other features (can be implemented later)
  function editUser(userId) {
    console.log('Edit user:', userId);
    alert('Función de edición de usuario - por implementar');
  }

  function viewUserActivity(userId) {
    console.log('View user activity:', userId);
    alert('Función de ver actividad de usuario - por implementar');
  }

  function clearPieceFilters() {
    console.log('Clear piece filters');
    // Implementation for clearing filters
  }

  // Inicializar sistemas de mejoras si están disponibles
  if (window.ErrorHandler) {
    // Wrapear funciones de auth con manejo de errores
    window.addEventListener('error', (event) => {
      ErrorHandler.handle(event.error, 'Login/Register', {
        filename: event.filename,
        lineno: event.lineno
      });
    });
  }
</script>

<!-- Sistemas de mejoras -->
<script src="error-handler.js"></script>
<script src="loading-manager.js"></script>
<script src="ui-animations.js"></script>
</body>
</html>
