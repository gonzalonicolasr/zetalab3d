<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculadora ZetaLab</title>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- MercadoPago SDK -->
  <script src="https://sdk.mercadopago.com/js/v2"></script>

  <!-- Favicon -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Ccircle cx='8' cy='8' r='8' fill='%2313251f'/%3E%3Ctext x='8' y='11' text-anchor='middle' font-size='9' fill='%23c9b28a'%3EZL%3C/text%3E%3C/svg%3E">

  <!-- Estilos -->
  <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="container">
  <header class="row" style="align-items:center; justify-content:space-between; gap:8px;">
    <div class="pill">
      <img src="logo.png" alt="ZetaLab" onerror="this.style.display='none'">
      <strong>Calculadora ZetaLab</strong>
    </div>
    <div class="muted">Costeo de piezas 3D ‚Ä¢ PLA/PETG/ABS/TPU</div>
    <div class="row" style="gap:8px">
      <!-- Bot√≥n Suscripciones MercadoPago -->
      <button id="subscriptionButton" class="pill subscription-btn" style="background: #009EE3; color: white; border: none;">
        üí≥ <span>Suscripciones</span>
      </button>
      <!-- Indicador de suscripci√≥n -->
      <div id="subscriptionStatus" class="pill" style="display:none">
        <span id="subscriptionText">‚Äî</span>
      </div>
      <a href="mis-piezas.html" class="pill" style="text-decoration:none">Mis piezas guardadas</a>
    </div>
  </header>

  <!-- === CALCULADORA === -->
  <main class="row" style="margin-top:12px">
    <!-- Gastos fijos -->
    <section class="card" style="flex:1 1 100%; min-width:300px">
      <h2 style="margin-top:0">Gastos Fijos</h2>
      <div class="row">
        <div class="col">
          <label>Precio KG (ARS $):</label>
          <input id="precioKg" type="number" min="0" step="1" placeholder="17000">
        </div>
        <div class="col">
          <label>Precio kWh (ARS $):</label>
          <input id="precioKwh" type="number" min="0" step="1" placeholder="598">
        </div>
        <div class="col">
          <label>Consumo real por hora (W):</label>
          <input id="consumoW" type="number" min="0" step="1" placeholder="120">
        </div>
        <div class="col">
          <label>Desgaste m√°quina (horas):</label>
          <input id="horasDesgaste" type="number" min="0" step="1" placeholder="4320">
        </div>
        <div class="col">
          <label>Precio Repuestos (ARS $):</label>
          <input id="precioRepuestos" type="number" min="0" step="1" placeholder="150000">
        </div>
        <div class="col">
          <label>% Margen de error:</label>
          <input id="margenError" type="number" min="0" step="1" placeholder="30">
        </div>
      </div>

      <div class="hr"></div>
      <div class="row">
        <div class="col">
          <label>Nombre del perfil de Gastos Fijos</label>
          <input id="presetName" placeholder="Ej: BambuLab A1 - PLA" />
        </div>
        <div class="col" style="min-width:320px">
          <label>Perfiles guardados</label>
          <div class="row">
            <select id="presetList" style="flex:1; padding:12px; border-radius:10px; background:var(--bg-tertiary); color:var(--text-primary); border:1px solid var(--border-secondary);"></select>
            <button type="button" id="btnApplyPreset">Aplicar</button>
            <button type="button" id="btnDeletePreset">Borrar</button>
          </div>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button type="button" id="btnSavePreset" class="primary">Guardar perfil con los valores actuales</button>
      </div>
    </section>

    <!-- Pieza -->
    <section class="card" style="flex:1 1 100%; min-width:300px">
      <h2>Pieza</h2>

      <div class="row">
        <div class="col">
          <label>Nombre de la pieza:</label>
          <input id="pieceName" placeholder="Ej: Caja MTG" />
        </div>

        <div class="col">
          <label>üîó URL del modelo</label>
          <input id="pieceUrl" placeholder="https://makerworld.com/es/models/..." />
          <small style="color: #888; font-size: 12px; display: block; margin-top: 4px;">
            üìã Pega la URL de MakerWorld, Thingiverse, etc.
          </small>
        </div>

        <div class="col">
          <label>üñºÔ∏è Imagen (opcional)</label>
          <input id="imageUrl" placeholder="https://..." />
          <small style="color: #888; font-size: 12px; display: block; margin-top: 4px;">
            ‚ú® <strong>Se completa autom√°ticamente</strong> al usar "Autocompletar"
          </small>
        </div>
        <div id="pieceImgPreview" style="margin-top:6px">
          <img id="pieceImgTag" src="" alt="Preview" style="max-width:180px; border-radius:8px; display:none"/>
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <button id="btnAutoFromUrl">ü™Ñ Autocompletar desde URL</button>
        <small style="color: #28a745; font-size: 12px; margin-left: 10px; align-self: center;">
          <strong>üí° Tip:</strong> Pega una URL de MakerWorld y hace clic aqu√≠ para obtener nombre e imagen autom√°ticamente
        </small>
      </div>

      <div class="row" style="margin-top:12px">
        <div class="col">
          <label>Horas:</label>
          <input id="horas" type="number" min="0" step="1" placeholder="2">
        </div>
        <div class="col">
          <label>Minutos:</label>
          <input id="minutos" type="number" min="0" step="1" placeholder="33">
        </div>
        <div class="col">
          <label>Gramos de filamento:</label>
          <input id="gramos" type="number" min="0" step="1" placeholder="184">
        </div>
        <div class="col">
          <label>INSUMOS (ARS $):</label>
          <input id="insumos" type="number" min="0" step="1" placeholder="0">
        </div>
      </div>
    </section>

    <!-- Ganancia -->
    <section class="card" style="flex:1 1 100%; min-width:300px">
      <h2>Ganancia</h2>
      <div class="row">
        <div class="col">
          <label>Margen de ganancia (multiplicador):</label>
          <input id="multiplicador" type="number" min="1" step="0.1" placeholder="4">
          <div class="row" style="margin-top:8px">
            <button type="button" data-mult="4">Minorista ‚Üí 4</button>
            <button type="button" data-mult="3">Mayorista ‚Üí 3</button>
            <button type="button" data-mult="5">Llaveros ‚Üí 5</button>
          </div>
        </div>
        <div class="col">
          <label>Comisi√≥n MercadoLibre (%):</label>
          <input id="mlFee" type="number" min="0" step="0.1" placeholder="20">
          <div class="row" style="margin-top:8px">
            <button type="button" data-ml="17">Cl√°sico 17%</button>
            <button type="button" data-ml="20.5">Premium 20.5%</button>
            <button type="button" data-ml="22">Extra 22%</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Acciones / KPIs -->
    <section class="card" style="flex:1 1 100%; min-width:300px">
      <div class="row" style="justify-content:space-between;">
        <div class="row" style="gap:8px">
          <button class="primary" id="btnCalc">Calcular</button>
          <button id="btnQuote">Generar presupuesto (HTML)</button>
          <label class="row" style="margin-left:8px; gap:6px; font-size:12px; color:#b9c7bf">
            <input id="discreetDetail" type="checkbox" checked /> Detalle discreto
          </label>
          <button id="btnReset">Borrar datos</button>
          <button id="btnSavePiece" title="Guarda esta pieza y crea una versi√≥n">Guardar pieza</button>
        </div>
        <small class="small">Los campos se guardan en este navegador.</small>
      </div>
      <div class="hr"></div>

      <div class="kpi">
        <div class="tile">
          <h3>Precio sugerido (sin imp.)</h3>
          <p id="precioSugerido">‚Äî</p>
        </div>
        <div class="tile">
          <h3>Material</h3>
          <p id="outMaterial">‚Äî</p>
          <div class="small mono" id="matDetalle"></div>
        </div>
        <div class="tile">
          <h3>Energ√≠a</h3>
          <p id="outEnergia">‚Äî</p>
          <div class="small mono" id="enerDetalle"></div>
        </div>
      </div>

      <div class="kpi" style="margin-top:12px">
        <div class="tile">
          <h3>Desgaste</h3>
          <p id="outDesgaste">‚Äî</p>
          <div class="small mono" id="desgDetalle"></div>
        </div>
        <div class="tile">
          <h3>Insumos</h3>
          <p id="outInsumos">‚Äî</p>
        </div>
        <div class="tile">
          <h3>Subtotal + error</h3>
          <p id="outSubtotal">‚Äî</p>
          <div class="small mono" id="errorDetalle"></div>
        </div>
      </div>
    </section>

    <!-- Resumen cl√°sico -->
    <section class="card" style="flex:1 1 100%; min-width:300px">
      <h2>Resumen estilo cl√°sico</h2>
      <div class="mono">
        <p><strong>Precio Material:</strong> <span id="classicMaterial">‚Äî</span></p>
        <p><strong>Precio Luz:</strong> <span id="classicLuz">‚Äî</span></p>
        <p><strong>Desgaste M√°quina:</strong> <span id="classicDesgaste">‚Äî</span></p>
        <p><strong>Margen de Error:</strong> <span id="classicError">‚Äî</span></p>
        <p><strong>INSUMOS:</strong> <span id="classicInsumos">‚Äî</span></p>
        <p><strong>Costo Luz y Material:</strong> <span id="classicLyM">‚Äî</span></p>
        <p><strong>Costo Total (incluye insumos):</strong> <span id="classicCostoTotal">‚Äî</span></p>
        <p><strong>TOTAL A COBRAR:</strong> <span id="classicTotalCobrar">‚Äî</span></p>
        <p style="text-decoration: underline;">
          <strong>PRECIO MERCADOLIBRE:</strong> <span id="classicML">‚Äî</span><br>
          <span class="small" id="mlDetalle"></span>
        </p>
      </div>
    </section>
  </main>
</div>

<!-- Modal removido - Ahora se usa solo el modal din√°mico del SubscriptionService -->

<!-- Sistemas de mejoras -->
<script src="error-handler.js"></script>
<script src="loading-manager.js"></script>
<script src="validators.js"></script>
<script src="debounce-utils.js"></script>
<script src="config-profiles-service.js"></script>

<!-- UI Animations Enhancement -->
<script src="ui-animations.js"></script>

<!-- Sistema de suscripciones -->
<script src="subscription-service.js"></script>

<!-- App principal -->
<script src="app.js"></script>

<!-- Guard de sesi√≥n Supabase (expone window.supa y window.currentUser) -->
<script type="module" src="auth.js"></script>

<!-- Inicializar validaci√≥n en tiempo real -->
<script>
  // Esperar a que el DOM est√© listo
  document.addEventListener('DOMContentLoaded', async () => {
    // Inicializar validaci√≥n en tiempo real
    if (window.validationSystem) {
      validationSystem.initializeRealTimeValidation();
    }

    // Agregar atributos data-loading-key a botones importantes
    const btnCalc = document.getElementById('btnCalc');
    if (btnCalc) {
      btnCalc.setAttribute('data-loading-key', 'calculate');
    }

    const btnSave = document.getElementById('btnGuardarPieza');
    if (btnSave) {
      btnSave.setAttribute('data-loading-key', 'save-piece');
    }

    const btnQuote = document.getElementById('btnPresupuesto');
    if (btnQuote) {
      btnQuote.setAttribute('data-loading-key', 'generate-quote');
    }

    // Inicializar sistema de suscripciones cuando el usuario est√© listo
    if (window.currentUser) {
      await initializeSubscriptionSystem();
    } else {
      // Esperar a que se cargue el usuario
      window.addEventListener('userReady', async () => {
        await initializeSubscriptionSystem();
      });
    }
  });

  // Funci√≥n para inicializar el sistema de suscripciones
  async function initializeSubscriptionSystem() {
    if (!window.subscriptionService || !window.currentUser) return;

    try {
      const hasActive = await window.subscriptionService.checkSubscriptionStatus(window.currentUser.id);
      const statusEl = document.getElementById('subscriptionStatus');
      const textEl = document.getElementById('subscriptionText');
      
      if (hasActive) {
        const subscription = await window.subscriptionService.getCurrentSubscription(window.currentUser.id);
        const expiresAt = new Date(subscription.expires_at);
        const daysLeft = Math.ceil((expiresAt - new Date()) / (1000 * 60 * 60 * 24));
        
        statusEl.style.display = 'flex';
        
        // Mostrar estado seg√∫n plan con texto m√°s descriptivo
        let statusText = '';
        let statusClass = '';
        
        if (subscription.plan_type === 'trial') {
          statusText = `üÜì Prueba Gratis Activa ‚Ä¢ ${daysLeft} d√≠as restantes`;
          statusClass = 'trial';
        } else if (subscription.plan_type === 'monthly') {
          statusText = `‚úÖ Suscripci√≥n Activa ‚Ä¢ ${daysLeft} d√≠as restantes`;
          statusClass = 'monthly';
        } else if (subscription.plan_type === 'premium') {
          statusText = `‚≠ê Plan Premium Activo ‚Ä¢ ${daysLeft} d√≠as restantes`;
          statusClass = 'premium';
        }
        
        statusEl.className = `pill ${statusClass}`;
        textEl.textContent = statusText;
        
        // Usuario con suscripci√≥n activa - no necesita bot√≥n de upgrade
      } else {
        statusEl.style.display = 'flex';
        statusEl.style.background = '#d97706';
        statusEl.style.color = 'white';
        textEl.textContent = '‚ö†Ô∏è Sin suscripci√≥n activa';
      }
    } catch (error) {
      console.error('Error inicializando suscripciones:', error);
    }
  }

  // Funciones de upgrade premium removidas - bot√≥n eliminado

  // ============================================================================
  // SUSCRIPCIONES - SIMPLIFICADO
  // ============================================================================

  // Conectar bot√≥n de suscripciones al SubscriptionService
  document.addEventListener('DOMContentLoaded', function() {
    const subscriptionButton = document.getElementById('subscriptionButton');
    
    // Usar el modal din√°mico del SubscriptionService (ahora async)
    if (subscriptionButton) {
      subscriptionButton.addEventListener('click', async function() {
        if (window.subscriptionService) {
          try {
            await window.subscriptionService.showSubscriptionModal();
          } catch (error) {
            console.error('Error mostrando modal de suscripciones:', error);
            alert('Error al cargar las suscripciones. Por favor intenta nuevamente.');
          }
        } else {
          alert('Servicio de suscripciones no disponible');
        }
      });
    }
  });

  // Verificar URL parameters al cargar (para manejar redirects de MercadoPago)
  document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const payment = urlParams.get('payment');
    const plan = urlParams.get('plan');

    if (payment === 'success' && plan) {
      // Verificar realmente el estado de suscripci√≥n despu√©s del pago
      setTimeout(async () => {
        try {
          if (window.currentUser && window.subscriptionService) {
            // Esperar unos segundos para que el webhook procese el pago
            await new Promise(resolve => setTimeout(resolve, 3000));
            
            // Verificar el estado actual de la suscripci√≥n
            const hasActive = await window.subscriptionService.hasActiveSubscription(window.currentUser.id);
            
            if (hasActive) {
              alert(`¬°Suscripci√≥n ${plan} activada exitosamente!`);
              // Reinicializar el sistema de suscripciones para actualizar UI
              initializeSubscriptionSystem();
            } else {
              // Si a√∫n no est√° activa, mostrar mensaje de procesamiento
              alert('Tu pago fue exitoso y est√° siendo procesado. La suscripci√≥n se activar√° en unos minutos.');
              // Verificar nuevamente en 30 segundos
              setTimeout(async () => {
                const recheckActive = await window.subscriptionService.hasActiveSubscription(window.currentUser.id);
                if (recheckActive) {
                  initializeSubscriptionSystem();
                }
              }, 30000);
            }
          } else {
            alert(`¬°Pago exitoso! Tu suscripci√≥n ${plan} se est√° activando.`);
          }
        } catch (error) {
          console.error('Error verificando suscripci√≥n:', error);
          alert('Pago exitoso. Si no ves tu suscripci√≥n activada en unos minutos, contacta soporte.');
        }
      }, 1000);
      
      // Limpiar URL
      window.history.replaceState({}, document.title, window.location.pathname);
    } else if (payment === 'failure') {
      // Mostrar mensaje de error
      setTimeout(() => {
        alert('Hubo un problema con tu pago. Por favor, intenta nuevamente.');
      }, 1000);
      
      // Limpiar URL
      window.history.replaceState({}, document.title, window.location.pathname);
    } else if (payment === 'pending' && plan) {
      // Mostrar mensaje de pendiente
      setTimeout(() => {
        alert('Tu pago est√° siendo procesado. Te notificaremos cuando sea confirmado.');
      }, 1000);
      
      // Limpiar URL
      window.history.replaceState({}, document.title, window.location.pathname);
    }
  });
</script>
</body>
</html>
