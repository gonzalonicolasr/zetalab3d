<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setup Database - ZETALAB</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .container {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        .success {
            color: #28a745;
            background: #1a2a1a;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            border-left: 4px solid #28a745;
        }
        .error {
            color: #dc3545;
            background: #2a1a1a;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            border-left: 4px solid #dc3545;
        }
        .warning {
            color: #ffc107;
            background: #2a2a1a;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            border-left: 4px solid #ffc107;
        }
        .step {
            background: #333;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .step.completed {
            border-left: 4px solid #28a745;
        }
        .step.error {
            border-left: 4px solid #dc3545;
        }
        pre {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
        }
        .progress {
            width: 100%;
            height: 6px;
            background: #333;
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-bar {
            height: 100%;
            background: #007bff;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üõ†Ô∏è Configuraci√≥n de Base de Datos</h1>
        <p>Este script crear√° autom√°ticamente la tabla <code>config_profiles</code> y sus dependencias en Supabase.</p>
        
        <div class="warning">
            ‚ö†Ô∏è <strong>Importante:</strong> Asegurate de estar autenticado antes de ejecutar la configuraci√≥n.
        </div>
    </div>

    <div class="container">
        <h3>Estado del sistema:</h3>
        <div class="progress">
            <div id="progress-bar" class="progress-bar" style="width: 0%"></div>
        </div>
        
        <div id="step-1" class="step">
            <strong>Paso 1:</strong> Verificar conexi√≥n a Supabase
            <div id="status-1">‚è≥ Pendiente...</div>
        </div>
        
        <div id="step-2" class="step">
            <strong>Paso 2:</strong> Verificar autenticaci√≥n
            <div id="status-2">‚è≥ Pendiente...</div>
        </div>
        
        <div id="step-3" class="step">
            <strong>Paso 3:</strong> Crear tabla config_profiles
            <div id="status-3">‚è≥ Pendiente...</div>
        </div>
        
        <div id="step-4" class="step">
            <strong>Paso 4:</strong> Configurar permisos RLS
            <div id="status-4">‚è≥ Pendiente...</div>
        </div>
        
        <div id="step-5" class="step">
            <strong>Paso 5:</strong> Probar funcionalidad
            <div id="status-5">‚è≥ Pendiente...</div>
        </div>
    </div>

    <div class="container">
        <h3>Acciones:</h3>
        <button id="setup-btn" onclick="runFullSetup()">üöÄ Ejecutar Configuraci√≥n Completa</button>
        <button onclick="testConnection()">üîç Probar Conexi√≥n</button>
        <button onclick="window.location.href='calculadora.html'">üìä Ir a Calculadora</button>
        
        <div id="results"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Configuraci√≥n de Supabase
        const SUPABASE_URL = 'https://fwmyiovamcxvinoxnput.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3bXlpb3ZhbWN4dmlub3hucHV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzI2NDI4NDQsImV4cCI6MjA0ODIxODg0NH0.YMqiAhCBJOeVKCTMYZEP-Cz3gWvNuWokkFQBE9Dx0Ak';
        
        window.supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentStep = 0;
        const totalSteps = 5;

        function updateProgress(step) {
            currentStep = step;
            const percentage = (step / totalSteps) * 100;
            document.getElementById('progress-bar').style.width = percentage + '%';
        }

        function setStepStatus(step, status, message) {
            const stepDiv = document.getElementById(`step-${step}`);
            const statusDiv = document.getElementById(`status-${step}`);
            
            stepDiv.className = `step ${status}`;
            
            const icons = {
                'completed': '‚úÖ',
                'error': '‚ùå',
                'pending': '‚è≥',
                'working': '‚öôÔ∏è'
            };
            
            statusDiv.innerHTML = `${icons[status]} ${message}`;
        }

        async function runFullSetup() {
            const setupBtn = document.getElementById('setup-btn');
            setupBtn.disabled = true;
            setupBtn.textContent = '‚öôÔ∏è Configurando...';
            
            try {
                // Paso 1: Verificar conexi√≥n
                updateProgress(1);
                setStepStatus(1, 'working', 'Verificando conexi√≥n...');
                await testSupabaseConnection();
                setStepStatus(1, 'completed', 'Conexi√≥n exitosa');

                // Paso 2: Verificar autenticaci√≥n
                updateProgress(2);
                setStepStatus(2, 'working', 'Verificando usuario...');
                const user = await checkAuthentication();
                setStepStatus(2, 'completed', `Usuario: ${user.email}`);

                // Paso 3: Crear tabla
                updateProgress(3);
                setStepStatus(3, 'working', 'Creando tabla config_profiles...');
                await createConfigProfilesTable();
                setStepStatus(3, 'completed', 'Tabla creada exitosamente');

                // Paso 4: Configurar RLS
                updateProgress(4);
                setStepStatus(4, 'working', 'Configurando permisos...');
                await setupRLSPolicies();
                setStepStatus(4, 'completed', 'Permisos configurados');

                // Paso 5: Probar funcionalidad
                updateProgress(5);
                setStepStatus(5, 'working', 'Probando funcionalidad...');
                await testFunctionality();
                setStepStatus(5, 'completed', 'Todo funcionando correctamente');

                document.getElementById('results').innerHTML = `
                    <div class="success">
                        üéâ <strong>¬°Configuraci√≥n completada!</strong><br>
                        La tabla config_profiles ha sido creada y configurada correctamente.<br>
                        Pod√©s usar la calculadora normalmente ahora.
                    </div>
                `;

            } catch (error) {
                const failedStep = Math.min(currentStep + 1, totalSteps);
                setStepStatus(failedStep, 'error', error.message);
                
                document.getElementById('results').innerHTML = `
                    <div class="error">
                        <strong>‚ùå Error en el paso ${failedStep}:</strong><br>
                        ${error.message}<br><br>
                        <strong>Soluciones posibles:</strong><br>
                        ‚Ä¢ Verific√° que est√©s autenticado<br>
                        ‚Ä¢ Revis√° los permisos de tu usuario en Supabase<br>
                        ‚Ä¢ Contact√° al administrador si el problema persiste
                    </div>
                `;
            } finally {
                setupBtn.disabled = false;
                setupBtn.textContent = 'üöÄ Ejecutar Configuraci√≥n Completa';
            }
        }

        async function testSupabaseConnection() {
            try {
                const { data, error } = await window.supa.from('pieces').select('id').limit(1);
                if (error && !error.message.includes('relation "public.pieces"')) {
                    throw new Error(`Error de conexi√≥n: ${error.message}`);
                }
                return true;
            } catch (error) {
                throw new Error(`No se pudo conectar a Supabase: ${error.message}`);
            }
        }

        async function checkAuthentication() {
            try {
                const { data: { user }, error } = await window.supa.auth.getUser();
                if (error) throw error;
                if (!user) throw new Error('Usuario no autenticado');
                
                window.currentUser = user;
                return user;
            } catch (error) {
                throw new Error(`Error de autenticaci√≥n: ${error.message}`);
            }
        }

        async function createConfigProfilesTable() {
            try {
                // Intentar crear la tabla usando RPC si est√° disponible
                const createTableSQL = \`
                    CREATE TABLE IF NOT EXISTS public.config_profiles (
                        id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
                        user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
                        name TEXT NOT NULL,
                        config_data JSONB NOT NULL,
                        is_default BOOLEAN DEFAULT false,
                        is_public BOOLEAN DEFAULT false,
                        created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL,
                        updated_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL
                    );
                    
                    CREATE INDEX IF NOT EXISTS idx_config_profiles_user_id ON public.config_profiles(user_id);
                    CREATE INDEX IF NOT EXISTS idx_config_profiles_name ON public.config_profiles(user_id, name);
                \`;

                // Intentar ejecutar como RPC
                try {
                    const { error } = await window.supa.rpc('exec_sql', { sql: createTableSQL });
                    if (error) throw error;
                } catch (rpcError) {
                    // Si RPC no funciona, intentar insertar un registro de prueba para forzar la creaci√≥n
                    const testData = {
                        user_id: window.currentUser.id,
                        name: 'test-table-creation',
                        config_data: { test: true },
                        is_default: false,
                        is_public: false
                    };

                    const { error } = await window.supa.from('config_profiles').insert(testData);
                    
                    if (error && error.message.includes('relation "public.config_profiles" does not exist')) {
                        throw new Error('La tabla debe ser creada manualmente en Supabase Dashboard');
                    }
                    
                    // Si llegamos aqu√≠, la tabla existe, eliminar el registro de prueba
                    if (!error) {
                        await window.supa.from('config_profiles').delete().eq('name', 'test-table-creation');
                    }
                }
                
                return true;
            } catch (error) {
                if (error.message.includes('relation "public.config_profiles" does not exist')) {
                    throw new Error('Tabla no existe. Creala manualmente en Supabase SQL Editor con el script proporcionado.');
                }
                throw error;
            }
        }

        async function setupRLSPolicies() {
            try {
                // Las pol√≠ticas RLS deben crearse manualmente por limitaciones de seguridad
                // Solo verificamos que la tabla tenga RLS habilitado
                const { data, error } = await window.supa.from('config_profiles').select('id').limit(1);
                
                if (error && error.message.includes('RLS')) {
                    throw new Error('RLS no configurado correctamente');
                }
                
                return true;
            } catch (error) {
                // Si hay error de RLS, es posible que no est√© configurado
                console.warn('RLS warning:', error.message);
                return true; // Continuar de todas formas
            }
        }

        async function testFunctionality() {
            try {
                // Probar crear un perfil de prueba
                const testProfile = {
                    user_id: window.currentUser.id,
                    name: 'Test Profile - ' + Date.now(),
                    config_data: {
                        material_kg: 1.0,
                        energia_kwh: 0.1,
                        desgaste: 50,
                        repuestos: 25,
                        multiplicador: 2.0,
                        ml_comision: 15
                    },
                    is_default: false,
                    is_public: false
                };

                const { data: created, error: createError } = await window.supa
                    .from('config_profiles')
                    .insert(testProfile)
                    .select()
                    .single();

                if (createError) throw createError;

                // Probar leer el perfil
                const { data: read, error: readError } = await window.supa
                    .from('config_profiles')
                    .select('*')
                    .eq('id', created.id)
                    .single();

                if (readError) throw readError;

                // Probar eliminar el perfil de prueba
                const { error: deleteError } = await window.supa
                    .from('config_profiles')
                    .delete()
                    .eq('id', created.id);

                if (deleteError) throw deleteError;

                return true;
            } catch (error) {
                throw new Error(`Test de funcionalidad fall√≥: ${error.message}`);
            }
        }

        async function testConnection() {
            const results = document.getElementById('results');
            results.innerHTML = '<div class="warning">üîç Probando conexi√≥n...</div>';
            
            try {
                await testSupabaseConnection();
                const user = await checkAuthentication();
                
                results.innerHTML = `
                    <div class="success">
                        ‚úÖ <strong>Conexi√≥n exitosa</strong><br>
                        Usuario: ${user.email}<br>
                        URL: ${SUPABASE_URL}
                    </div>
                `;
            } catch (error) {
                results.innerHTML = `
                    <div class="error">
                        ‚ùå <strong>Error de conexi√≥n:</strong><br>
                        ${error.message}
                    </div>
                `;
            }
        }

        // Auto-verificar al cargar
        document.addEventListener('DOMContentLoaded', () => {
            testConnection();
        });
    </script>
</body>
</html>